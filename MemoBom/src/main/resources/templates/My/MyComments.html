<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{My/MyLayout}">

 <th:block layout:fragment="my_title">MY Comments</th:block>

 <th:block layout:fragment="my_content">
	   <div class="w-full px-4 pb-24">

	     <!-- Í≤ÄÏÉâ Î∞î -->
	     <div class="mt-3 sticky top-0 z-10 bg-slate-50/80 backdrop-blur-md pt-2 pb-2">
	       <div class="relative">
	         <input id="keyword" type="search" autocomplete="off" placeholder="Í≤ÄÏÉâ"
	                class="w-full h-11 rounded-2xl bg-white ring-1 ring-slate-200
	                       pl-4 pr-11 text-dynamic-15 outline-none
	                       focus:ring-2 focus:ring-sky-300"/>
	         <button id="btnSearch" type="button"
	                 class="absolute right-2 top-1/2 -translate-y-1/2
	                        w-9 h-9 rounded-xl hover:bg-slate-100 flex items-center justify-center"
	                 aria-label="Í≤ÄÏÉâ">
	           <svg class="w-5 h-5 text-slate-600" viewBox="0 0 24 24" fill="none">
	             <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
	             <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
	           </svg>
	         </button>
	       </div>
	     </div>

	     <!-- Î¶¨Ïä§Ìä∏ -->
	     <div id="list" class="mt-3 space-y-3"></div>

	     <!-- ÏÉÅÌÉú -->
	     <div id="state" class="mt-4 text-center text-dynamic-sm text-slate-500"></div>

	     <!-- ÏÑºÌã∞ÎÑ¨ -->
	     <div id="sentinel" class="h-10"></div>

	     <!-- ===== ÌÖúÌîåÎ¶ø ===== -->
	     <template id="tplCmtItem">
	       <div class="relative overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-slate-200/70">
	         <!-- Ï¢åÏ∏° topic Ïª¨Îü¨Î∞î -->
	         <div class="color-bar absolute left-0 top-0 h-full w-2"></div>

	         <!-- ÏÉÅÎã®: topic row + ÎÇ†Ïßú(ÎåìÍ∏Ä ÏûëÏÑ±Ïùº) + ÌôîÏÇ¥Ìëú -->
	         <div class="px-4 pt-3 pb-2 flex items-center gap-2">
	           <!-- topic ÌÅ¥Î¶≠ ÏòÅÏó≠ -->
	           <button type="button"
	                   class="topic-hit flex items-center gap-2 min-w-0 flex-1 text-left">
	             <span class="topic-emoji w-6 h-6 rounded-lg bg-slate-100 ring-1 ring-slate-200
	                          flex items-center justify-center text-dynamic-sm">üôÇ</span>
	             <span class="topic-name text-dynamic-sm font-semibold text-slate-800 truncate">Topic Ïù¥Î¶Ñ</span>
	           </button>

	           <!-- ÎÇ†Ïßú(ÎåìÍ∏Ä ÏûëÏÑ±Ïùº) -->
	           <span class="reg-date text-dynamic-xs text-slate-500 shrink-0">2026-01-29 18:18</span>

	           <!-- ‚Üí ÎßÅÌÅ¨(ÎåìÍ∏Ä) -->
	           <button type="button"
	                   class="btn-cmt-link shrink-0 p-2 rounded-xl hover:bg-slate-100
	                          ring-1 ring-slate-200"
	                   aria-label="ÎåìÍ∏ÄÎ°ú Ïù¥Îèô">
	             <svg xmlns="http://www.w3.org/2000/svg"
	                  viewBox="0 0 24 24"
	                  width="20" height="20"
	                  fill="none"
	                  stroke="currentColor"
	                  stroke-width="1.8"
	                  stroke-linecap="round"
	                  stroke-linejoin="round">
	               <path d="M6 12h10"/>
	               <path d="M13.5 8.5l4 3.5-4 3.5"/>
	             </svg>
	           </button>
	         </div>

	         <!-- ÏõêÍ∏Ä(Ï°∞Í∏à ÏûëÍ≤å) -->
	         <div class="px-4 pb-2">
	           <div class="frag-preview text-dynamic-sm leading-5 text-slate-600 line-clamp-2">
	             Fragment.content...
	           </div>
	         </div>

	         <!-- ÎåìÍ∏Ä ÏòÅÏó≠(Ï†êÏÑ† Î∞ïÏä§) -->
	         <div class="px-4 pb-4">
	           <div class="cmt-box rounded-xl border border-dashed border-slate-300 bg-slate-50/60 px-3 py-3">
	             <div class="cmt-content text-dynamic-base leading-6 text-slate-900"></div>
	           </div>
	         </div>
	       </div>
	     </template>

	   </div>
</th:block>

<th:block layout:fragment="my_script">
	 <script>
	 (function () {
	   const cp = window.contextPath || '';
	   const API_URL = cp + '/My/Comments.json';

	   const $list = document.getElementById('list');
	   const $state = document.getElementById('state');
	   const $sentinel = document.getElementById('sentinel');
	   const $keyword = document.getElementById('keyword');
	   const $btnSearch = document.getElementById('btnSearch');
	   const tpl = document.getElementById('tplCmtItem');

	   let pageNo = 1;
	   let loading = false;
	   let ended = false;
	   let currentKeyword = '';

	   function setState(msg) { $state.textContent = msg || ''; }
	   function setText(el, v) { if (el) el.textContent = (v ?? ''); }

	   function createNode(item) {
	     const frag = tpl.content.cloneNode(true);
	     const root = frag.firstElementChild;

	     const topic = item.fragment?.topic || {};
	     const topicUid = topic.uid || '';
	     const cmtUid = item.uid || '';

	     // dataset (Ïù¥Î≤§Ìä∏ ÏúÑÏûÑÏóêÏÑú ÏÇ¨Ïö©)
	     root.dataset.topicUid = topicUid;
	     root.dataset.cmtUid = cmtUid;

	     // Ïª¨Îü¨Î∞î
	     root.querySelector('.color-bar').style.background = topic.color || '#cbd5e1';

	     // topic
	     setText(root.querySelector('.topic-emoji'), topic.imogi || 'üôÇ');
	     setText(root.querySelector('.topic-name'), topic.name || '');

	     // ÎÇ†Ïßú: ÎåìÍ∏Ä ÏûëÏÑ±Ïùº
	     setText(root.querySelector('.reg-date'), item.regDate || '');

	     // ÏõêÍ∏Ä(fragment.content)
	     setText(root.querySelector('.frag-preview'), item.fragment?.content || '');

	     // ÎåìÍ∏Ä ÎÇ¥Ïö©
	     setText(root.querySelector('.cmt-content'), item.content || '');

	     return root;
	   }

	   async function fetchPage() {
	     if (loading || ended) return;
	     loading = true;
	     setState('Î∂àÎü¨Ïò§Îäî Ï§ë‚Ä¶');

	     try {
	       const res = await apiGetWithParam(API_URL, {
	         pageNo: pageNo,
	         keyword: currentKeyword || ''
	       });

	       if (!res || res.code !== '0') {
	         setState(res?.message || 'Ï°∞ÌöåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
	         ended = true;
	         return;
	       }

	       const data = res.data;

	       // ÎÅù Ï°∞Í±¥
	       if (!data || (Array.isArray(data) && data.length === 0)) {
	         ended = true;
	         setState($list.children.length === 0 ? 'Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.' : 'ÎßàÏßÄÎßâÏûÖÎãàÎã§.');
	         return;
	       }

	       const holder = document.createDocumentFragment();
	       for (const it of data) holder.appendChild(createNode(it));
	       $list.appendChild(holder);

	       pageNo += 1;
	       setState('');
	     } catch (e) {
	       console.error(e);
	       setState('ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
	       ended = true;
	     } finally {
	       loading = false;
	     }
	   }

	   // Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ
	   $list.addEventListener('click', (e) => {
	     // 1) ‚Üí Î≤ÑÌäº: cmtUidÎ°ú Ïù¥Îèô
	     const btnCmt = e.target.closest('button.btn-cmt-link');
	     if (btnCmt) {
	       const card = btnCmt.closest('[data-cmt-uid]');
	       const uid = card?.dataset?.cmtUid;
	       if (uid) location.href = cp + '/Fragment/index.html?cmtUid=' + encodeURIComponent(uid);
	       return;
	     }

	     // 2) topic ÌÅ¥Î¶≠: topicUidÎ°ú Ïù¥Îèô
	     const btnTopic = e.target.closest('button.topic-hit');
	     if (btnTopic) {
	       const card = btnTopic.closest('[data-topic-uid]');
	       const topicUid = card?.dataset?.topicUid;
	       if (topicUid) location.href = cp + '/Fragment/index.html?topicUid=' + encodeURIComponent(topicUid);
	       return;
	     }
	   });

	   // Í≤ÄÏÉâ
	   async function resetAndLoad() {
	     pageNo = 1;
	     ended = false;
	     loading = false;
	     $list.innerHTML = '';
	     setState('');
	     await fetchPage();
	   }

	   $btnSearch.addEventListener('click', () => {
	     currentKeyword = ($keyword.value || '').trim();
	     resetAndLoad();
	   });

	   $keyword.addEventListener('keydown', (e) => {
	     if (e.key === 'Enter') {
	       currentKeyword = ($keyword.value || '').trim();
	       resetAndLoad();
	     }
	   });

	   // Î¨¥Ìïú Ïä§ÌÅ¨Î°§
	   const io = new IntersectionObserver((entries) => {
	     const ent = entries[0];
	     if (ent.isIntersecting) fetchPage();
	   }, { root: null, threshold: 0.1 });

	   io.observe($sentinel);

	   // Ï≤´ Î°úÎìú
	   fetchPage();
	 })();
	 </script>
 </th:block>
</html>
