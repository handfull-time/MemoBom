<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{My/MyLayout}">
<head>
  <th:block layout:fragment="my_css">
    <!-- FullCalendar (CDN) -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.20/main.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.20/main.min.css">

    <style>
      /* 달력 이벤트(뱃지) 줄 간격 조금 다듬기 */
      .fc .fc-daygrid-day-events { margin-top: 2px; }
      .fc .fc-daygrid-event { margin: 1px 0; }

	  /* 일요일(빨강) */
	  .fc .fc-day-sun .fc-daygrid-day-number,
	  .fc .fc-col-header-cell.fc-day-sun {
	    color: #ef4444; /* red-500 */
	  }

	  /* 토요일(파랑) */
	  .fc .fc-day-sat .fc-daygrid-day-number,
	  .fc .fc-col-header-cell.fc-day-sat {
	    color: #3b82f6; /* blue-500 */
	  }
	</style>

  </th:block>
</head>

<body>
<th:block layout:fragment="my_content">
  <div class="-m-2 h-[calc(100vh-48px-40px)] flex flex-col bg-white">
    <div class="flex items-center justify-between mb-2">
      <div class="text-base font-bold">Calendar</div>
      <div id="calMonthLabel" class="text-sm text-gray-500"></div>
    </div>
    <div id="calendar" class="flex-1 min-h-0"></div>
  </div>

  <!-- 여러 개 선택 모달 -->
  <div id="pickModal" class="fixed inset-0 z-[9999] hidden">
    <div class="absolute inset-0 bg-black/40" onclick="CalendarPick.close()"></div>

    <div class="absolute left-1/2 top-1/2 w-[92%] max-w-md -translate-x-1/2 -translate-y-1/2
                bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
      <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
        <div class="font-semibold" id="pickTitle">선택</div>
        <button type="button" class="px-2 py-1 rounded hover:bg-gray-100" onclick="CalendarPick.close()">✕</button>
      </div>

      <div class="p-3">
        <div id="pickList" class="space-y-2"></div>
      </div>

      <div class="p-3 border-t border-gray-200 flex justify-end">
        <button type="button"
                class="px-3 py-2 text-sm rounded-lg border border-gray-200 hover:bg-gray-50"
                onclick="CalendarPick.close()">
          닫기
        </button>
      </div>
    </div>
  </div>
</th:block>

<th:block layout:fragment="my_script">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.js"></script>

  <script th:inline="javascript">
    // ======================
    // 아이콘(SVG)
    // ======================
    const ICON = {
      fragment: `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-3.5 h-3.5">
  <path d="M7 3h10a2 2 0 0 1 2 2v14l-4-2-4 2-4-2-4 2V5a2 2 0 0 1 2-2z"
        fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
</svg>`,
      comment: `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-3.5 h-3.5">
  <path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"
        fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
</svg>`
    };

    // ======================
    // 모달
    // ======================
    const CalendarPick = {
      open(dateStr, items) {
        const modal = document.getElementById('pickModal');
        const title = document.getElementById('pickTitle');
        const list = document.getElementById('pickList');

        title.textContent = `${dateStr} 항목 선택`;
        list.innerHTML = '';

        items.forEach((it) => {
          const target = normalizeTarget(it.target);
          const label = target === 'fragment' ? 'Fragment' : 'Comment';

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = "w-full flex items-center justify-between px-3 py-3 rounded-xl border border-gray-200 hover:bg-gray-50 text-left";
          btn.innerHTML = `
            <div class="flex items-center gap-2 text-sm">
              <span class="${target === 'fragment' ? 'text-slate-900' : 'text-slate-700'}">${ICON[target]}</span>
              <span class="font-medium">${label}</span>
              <span class="text-xs text-gray-400">(${it.uid})</span>
            </div>
            <span class="text-xs text-gray-400">선택</span>
          `;
          btn.onclick = () => {
            CalendarPick.close();
            navigateByItem(it);
          };
          list.appendChild(btn);
        });

        modal.classList.remove('hidden');
      },
      close() {
        document.getElementById('pickModal').classList.add('hidden');
      }
    };

    // ======================
    // 데이터 보관 (date -> {fragment:[uids], comment:[uids]})
    // ======================
    let monthMap = new Map();

    function normalizeTarget(t) {
      if (!t) return '';
      const v = String(t).toLowerCase();
      if (v === 'comments') return 'comment';
      return v; // fragment | comment
    }

    function yyyymmFromDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      return `${y}${m}`;
    }

    function setMonthLabel(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      document.getElementById('calMonthLabel').textContent = `${y}-${m}`;
    }

    async function loadMonth(yyyymm) {
      const base = window.contextPath || '';

	  const url = /*[[@{/My/MyCalendar.json}]]*/ '/My/Calendar.json';
	  const json = await apiGetWithParam(url, {date: yyyymm});
      
      if (!json || json.code !== 0) {
        monthMap = new Map();
        return;
      }

      const next = new Map();

      (json.data || []).forEach((row) => {
        const date = row.date; // 'YYYY-MM-DD'
        const target = normalizeTarget(row.target); // fragment|comment
        const uid = row.uid;

        if (!next.has(date)) next.set(date, { fragment: [], comment: [] });
        if (target === 'fragment') next.get(date).fragment.push(uid);
        if (target === 'comment') next.get(date).comment.push(uid);
      });

      monthMap = next;
    }

    // ✅ monthMap -> FullCalendar events
    function buildCalendarEvents() {
      const events = [];

      for (const [date, v] of monthMap.entries()) {
        if (v.fragment.length) {
          events.push({
            start: date,
            allDay: true,
            title: '', // 표시 안 함 (eventContent로 커스텀)
            extendedProps: { kind: 'fragment', count: v.fragment.length }
          });
        }
        if (v.comment.length) {
          events.push({
            start: date,
            allDay: true,
            title: '',
            extendedProps: { kind: 'comment', count: v.comment.length }
          });
        }
      }
      return events;
    }

    function navigateByItem(it) {
      const target = normalizeTarget(it.target);
      const uid = encodeURIComponent(it.uid);
      const base = /**[[@{/Fragment/Fragment.html}]]**/ '';

      if (target === 'fragment') {
        location.href = `${base}?uid=${uid}`;
      } else if (target === 'comment') {
        location.href = `${base}?comment=${uid}`;
      }
    }

    // ======================
    // FullCalendar 초기화
    // ======================
    document.addEventListener('DOMContentLoaded', () => {
      const calendarEl = document.getElementById('calendar');

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: '100%',
        locale: 'ko',
        fixedWeekCount: false,
        dayMaxEventRows: 2,  // fragment+comment 정도만 보이게
        eventDisplay: 'block',
		expandRows: true,

        // 이벤트를 "뱃지"처럼 보이게 (클릭/드래그 방지)
        eventClassNames: () => ['!bg-transparent', '!border-0', '!p-0', 'pointer-events-none'],

        // ✅ 아이콘+카운트 렌더링
        eventContent: function(arg) {
          const kind = arg.event.extendedProps.kind;
          const count = arg.event.extendedProps.count;

          const icon = (kind === 'fragment') ? ICON.fragment : ICON.comment;
          const textCls = (kind === 'fragment') ? 'text-slate-900' : 'text-slate-700';

          const html = `
<div class="flex items-center gap-1 ${textCls} text-[11px] leading-none">
    ${icon}<span class="font-semibold">${count}</span>
</div>
`;
          return { html };
        },

        // ✅ 월 이동/초기 렌더 시점: API 재조회 + 이벤트 갱신
        datesSet: async function(info) {
          const cur = info.view.currentStart; // 월뷰 기준 해당 월 시작
          setMonthLabel(cur);

          const yyyymm = yyyymmFromDate(cur);
          await loadMonth(yyyymm);

          calendar.removeAllEvents();
          calendar.addEventSource(buildCalendarEvents());
        },

        // ✅ 날짜 클릭: monthMap 기준으로 이동/모달 선택
        dateClick: function(info) {
          const dateStr = info.dateStr; // YYYY-MM-DD
          const day = monthMap.get(dateStr);
          if (!day) return;

          const items = [
            ...day.fragment.map(uid => ({ date: dateStr, target: 'fragment', uid })),
            ...day.comment.map(uid => ({ date: dateStr, target: 'comment', uid })),
          ];

          if (items.length === 1) {
            navigateByItem(items[0]);
            return;
          }
          if (items.length >= 2) {
            CalendarPick.open(dateStr, items);
          }
        }
      });

      calendar.render();
    });
  </script>
</th:block>
</body>
</html>
