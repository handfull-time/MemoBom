<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{My/MyLayout}">

	<th:block layout:fragment="my_title">MY Mosaic</th:block>	 
<body>
	<th:block layout:fragment="my_content">
	  <div class="w-full mx-auto px-4 pb-24">

	    <!-- ê²€ìƒ‰ ë°” -->
	    <div class="mt-3 sticky top-0 z-10 bg-slate-50/80 backdrop-blur-md pt-2 pb-2">
	      <div class="flex items-center gap-2">
	        <div class="relative flex-1">
	          <input id="keyword" type="search" autocomplete="off" placeholder="ê²€ìƒ‰"
	                 class="w-full h-11 rounded-2xl bg-white ring-1 ring-slate-200
	                        pl-4 pr-11 text-dynamic-15 outline-none
	                        focus:ring-2 focus:ring-sky-300" />
	          <button id="btnSearch" type="button"
	                  class="absolute right-2 top-1/2 -translate-y-1/2
	                         w-9 h-9 rounded-xl hover:bg-slate-100 flex items-center justify-center"
	                  aria-label="ê²€ìƒ‰">
	            <svg class="w-5 h-5 text-slate-600" viewBox="0 0 24 24" fill="none">
	              <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
	              <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
	            </svg>
	          </button>
	        </div>

	        <button id="btnReset" type="button"
	                class="h-11 px-3 rounded-2xl bg-white ring-1 ring-slate-200
	                       text-dynamic-sm font-semibold text-slate-700 hover:bg-slate-100">
	          ì´ˆê¸°í™”
	        </button>
	      </div>
	    </div>

	    <!-- ë¦¬ìŠ¤íŠ¸ -->
	    <div id="list" class="mt-3 space-y-3"></div>

	    <!-- ìƒíƒœ -->
	    <div id="state" class="mt-4 text-center text-dynamic-sm text-slate-500"></div>

	    <!-- ë¬´í•œìŠ¤í¬ë¡¤ ì„¼í‹°ë„¬ -->
	    <div id="sentinel" class="h-10"></div>

	    <!-- í…œí”Œë¦¿ -->
	    <template id="tplMosaicItem">
	      <div class="relative overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-slate-200/70">
	        <div class="color-bar absolute left-0 top-0 h-full w-2"></div>

	        <div class="pl-5 pr-4 py-4">
	          <div class="flex items-center gap-3">
	            <div class="emoji-box w-11 h-11 rounded-2xl bg-slate-100 ring-1 ring-slate-200
	                        flex items-center justify-center text-dynamic-xl">ğŸ™‚</div>

	            <div class="min-w-0 flex-1">
	              <div class="name text-dynamic-17 font-extrabold tracking-tight text-slate-900 truncate">ì´ëª¨ì§€ ì´ë¦„</div>

	              <div class="mt-2 flex flex-wrap gap-2">
	                <span class="badge-external px-2 py-1 rounded-xl text-dynamic-xs font-semibold"></span>
	                <span class="badge-comments px-2 py-1 rounded-xl text-dynamic-xs font-semibold"></span>
	                <span class="badge-emotion px-2 py-1 rounded-xl text-dynamic-xs font-semibold"></span>
	              </div>
	            </div>

				<button type="button"
				        class="btn-edit hidden shrink-0 p-2 rounded-xl
				               hover:bg-slate-100 ring-1 ring-slate-200"
				        aria-label="í¸ì§‘">
				  <th:block th:replace="~{Fragments/Icons :: topic_write}"></th:block>
				</button>
	          </div>
	        </div>
	      </div>
	    </template>

	  </div>
	</th:block>

	<th:block layout:fragment="my_script">
	<script>
	(function () {
	  const cp = window.contextPath || '';
	  const API_URL = cp + '/My/MyMosaic.json';

	  const $list = document.getElementById('list');
	  const $state = document.getElementById('state');
	  const $sentinel = document.getElementById('sentinel');
	  const $keyword = document.getElementById('keyword');
	  const $btnSearch = document.getElementById('btnSearch');
	  const $btnReset = document.getElementById('btnReset');
	  const tpl = document.getElementById('tplMosaicItem');

	  let pageNo = 1;
	  let loading = false;
	  let ended = false;
	  let currentKeyword = '';

	  function setState(msg) {
	    $state.textContent = msg || '';
	  }

	  function setBadge(el, enabled, onText, offText) {
	    if (!el) return;
	    el.textContent = enabled ? onText : offText;
	    el.className = [
	      'px-2 py-1 rounded-xl text-dynamic-xs font-semibold ring-1',
	      enabled
	        ? 'bg-emerald-50 text-emerald-700 ring-emerald-200'
	        : 'bg-slate-100 text-slate-500 ring-slate-200'
	    ].join(' ');
	  }

	  function createItemNode(item) {
	    const frag = tpl.content.cloneNode(true);
	    const root = frag.firstElementChild;

	    root.querySelector('.color-bar').style.background = item.color || '#cbd5e1';
	    root.querySelector('.emoji-box').textContent = item.imogi || 'ğŸ™‚';
	    root.querySelector('.name').textContent = item.name || '';

	    setBadge(root.querySelector('.badge-external'), item.external, 'ê³µê°œ', 'ë¹„ê³µê°œ');
	    setBadge(root.querySelector('.badge-comments'), item.comments, 'ëŒ“ê¸€ ON', 'ëŒ“ê¸€ OFF');
	    setBadge(root.querySelector('.badge-emotion'), item.emotion, 'ì´ëª¨ì…˜ ON', 'ì´ëª¨ì…˜ OFF');

	    const btnEdit = root.querySelector('.btn-edit');
	    if (item.editable) {
	      btnEdit.classList.remove('hidden');
	      btnEdit.dataset.uid = item.uid;
	    }

	    // ì¹´ë“œ ì „ì²´ í´ë¦­ë„ uidë¥¼ ì•Œ ìˆ˜ ìˆê²Œ(ì„ íƒ)
	    root.dataset.uid = item.uid;

	    return root;
	  }

	  async function fetchPage() {
	    if (loading || ended) return;
	    loading = true;
	    setState('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');

	    try {
	      // âœ… api.js ì‚¬ìš©
	      const res = await apiGetWithParam(API_URL, {
	        pageNo: pageNo,
	        keyword: currentKeyword || ''
	      });

	      if (!res || res.code !== '0') {
	        setState(res?.message || 'ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
	        ended = true;
	        return;
	      }

	      const data = res.data;

	      // ë ì¡°ê±´: null ë˜ëŠ” ë¹ˆ ë°°ì—´
	      if (!data || (Array.isArray(data) && data.length === 0)) {
	        ended = true;
	        setState($list.children.length === 0 ? 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ë§ˆì§€ë§‰ì…ë‹ˆë‹¤.');
	        return;
	      }

	      const holder = document.createDocumentFragment();
	      for (const item of data) {
	        holder.appendChild(createItemNode(item));
	      }
	      $list.appendChild(holder);

	      pageNo += 1;
	      setState('');
	    } catch (e) {
	      console.error(e);
	      setState('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
	      ended = true;
	    } finally {
	      loading = false;
	    }
	  }

	  // ì´ë²¤íŠ¸ ìœ„ì„: í¸ì§‘ ë²„íŠ¼
	  $list.addEventListener('click', (e) => {
		const btn = e.target.closest('button.btn-edit');
		  if (!btn) return;

		  const uid = btn.dataset.uid;
		  if (!uid) return;

		  location.href = cp + '/Mosaic/Item.html?uid=' + encodeURIComponent(uid);
	  });

	  async function resetAndLoad() {
	    pageNo = 1;
	    ended = false;
	    loading = false;
	    $list.innerHTML = '';
	    setState('');
	    await fetchPage();
	  }

	  $btnSearch.addEventListener('click', () => {
	    currentKeyword = ($keyword.value || '').trim();
	    resetAndLoad();
	  });

	  $keyword.addEventListener('keydown', (e) => {
	    if (e.key === 'Enter') {
	      currentKeyword = ($keyword.value || '').trim();
	      resetAndLoad();
	    }
	  });

	  $btnReset.addEventListener('click', () => {
	    $keyword.value = '';
	    currentKeyword = '';
	    resetAndLoad();
	  });

	  // ë¬´í•œ ìŠ¤í¬ë¡¤: IntersectionObserver
	  const io = new IntersectionObserver((entries) => {
	    const ent = entries[0];
	    if (ent.isIntersecting) fetchPage();
	  }, { root: null, threshold: 0.1 });

	  io.observe($sentinel);

	  // ì²« ë¡œë“œ
	  fetchPage();
	})();
	</script>
	</th:block>
</body>
</html>
