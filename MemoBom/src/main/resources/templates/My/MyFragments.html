<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{My/MyLayout}">
	 
	 <th:block layout:fragment="my_title">MY Fragments</th:block>

<body>

	<th:block layout:fragment="my_content">
	  <div class="w-full px-4 pb-24">

	    <!-- Í≤ÄÏÉâ Î∞î -->
	    <div class="mt-3 sticky top-0 z-10 bg-slate-50/80 backdrop-blur-md pt-2 pb-2">
	      <div class="relative">
	        <input id="keyword" type="search" autocomplete="off" placeholder="Í≤ÄÏÉâ"
	               class="w-full h-11 rounded-2xl bg-white ring-1 ring-slate-200
	                      pl-4 pr-11 text-dynamic-15 outline-none
	                      focus:ring-2 focus:ring-sky-300"/>
	        <button id="btnSearch" type="button"
	                class="absolute right-2 top-1/2 -translate-y-1/2
	                       w-9 h-9 rounded-xl hover:bg-slate-100 flex items-center justify-center"
	                aria-label="Í≤ÄÏÉâ">
	          <svg class="w-5 h-5 text-slate-600" viewBox="0 0 24 24" fill="none">
	            <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
	            <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
	          </svg>
	        </button>
	      </div>
	    </div>

	    <!-- Î¶¨Ïä§Ìä∏ -->
	    <div id="list" class="mt-3 space-y-3"></div>

	    <!-- ÏÉÅÌÉú -->
	    <div id="state" class="mt-4 text-center text-dynamic-sm text-slate-500"></div>

	    <!-- ÏÑºÌã∞ÎÑ¨ -->
	    <div id="sentinel" class="h-10"></div>

	    <!-- ===== ÌÖúÌîåÎ¶ø ===== -->
	    <template id="tplFragItem">
	      <div class="relative overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-slate-200/70">
	        <!-- Ï¢åÏ∏° topic Ïª¨Îü¨Î∞î -->
	        <div class="color-bar absolute left-0 top-0 h-full w-2"></div>

	        <!-- ÏÉÅÎã®: topic row + ÎÇ†Ïßú + ÌôîÏÇ¥Ìëú -->
	        <div class="px-4 pt-3 pb-2 flex items-center gap-2">
	          <!-- topic ÌÅ¥Î¶≠ ÏòÅÏó≠ -->
	          <button type="button"
	                  class="topic-hit flex items-center gap-2 min-w-0 flex-1 text-left">
	            <span class="topic-emoji w-6 h-6 rounded-lg bg-slate-100 ring-1 ring-slate-200
	                         flex items-center justify-center text-dynamic-sm">üôÇ</span>
	            <span class="topic-name text-dynamic-sm font-semibold text-slate-800 truncate">Topic Ïù¥Î¶Ñ</span>
	          </button>

	          <!-- ÎÇ†Ïßú -->
	          <span class="reg-date text-dynamic-xs text-slate-500 shrink-0">2026.01.29</span>

	          <!-- ‚Üí ÎßÅÌÅ¨(ÌîÑÎûòÍ∑∏Î®ºÌä∏) -->
	          <button type="button"
	                  class="btn-frag-link shrink-0 p-2 rounded-xl hover:bg-slate-100
	                         ring-1 ring-slate-200"
	                  aria-label="ÌîÑÎûòÍ∑∏Î®ºÌä∏Î°ú Ïù¥Îèô">
	            <svg xmlns="http://www.w3.org/2000/svg"
	                 viewBox="0 0 24 24"
	                 width="20" height="20"
	                 fill="none"
	                 stroke="currentColor"
	                 stroke-width="1.8"
	                 stroke-linecap="round"
	                 stroke-linejoin="round">
	              <path d="M6 12h10"/>
	              <path d="M13.5 8.5l4 3.5-4 3.5"/>
	            </svg>
	          </button>
	        </div>

	        <!-- Íµ¨Î∂ÑÏÑ†(Ï†êÏÑ† ÎäêÎÇå) -->
	        <div class="mx-4 border-t border-dashed border-slate-200"></div>

	        <!-- Î≥∏Î¨∏ -->
	        <div class="px-4 py-3">
	          <div class="content text-dynamic-15 leading-6 text-slate-900 line-clamp-3"></div>
	        </div>
	      </div>
	    </template>

	  </div>
	</th:block>

	<th:block layout:fragment="my_script">
	<script>
	(function () {
	  const cp = window.contextPath || '';
	  const API_URL = cp + '/My/Fragments.json';

	  const $list = document.getElementById('list');
	  const $state = document.getElementById('state');
	  const $sentinel = document.getElementById('sentinel');
	  const $keyword = document.getElementById('keyword');
	  const $btnSearch = document.getElementById('btnSearch');
	  const tpl = document.getElementById('tplFragItem');

	  let pageNo = 1;
	  let loading = false;
	  let ended = false;
	  let currentKeyword = '';

	  function setState(msg) { $state.textContent = msg || ''; }

	  // contentÎäî HTMLÏù¥ ÏÑûÏùº Ïàò ÏûàÏúºÎãà XSS Î∞©ÏßÄ ÏúÑÌï¥ textÎ°ú ÎÑ£Ïùå(ÌïÑÏöî Ïãú ÏÑúÎ≤ÑÏóêÏÑú sanitize/markdown Ï≤òÎ¶¨ Í∂åÏû•)
	  function setText(el, v) { if (el) el.textContent = (v ?? ''); }

	  function createNode(item) {
	    const frag = tpl.content.cloneNode(true);
	    const root = frag.firstElementChild;

	    // data Ï†ÄÏû• (Ïù¥Î≤§Ìä∏ ÏúÑÏûÑÏóêÏÑú ÏÇ¨Ïö©)
	    root.dataset.fragUid = item.uid;
	    root.dataset.topicUid = item.topic?.uid || '';

	    // Ïª¨Îü¨Î∞î
	    root.querySelector('.color-bar').style.background = item.topic?.color || '#cbd5e1';

	    // topic
	    setText(root.querySelector('.topic-emoji'), item.topic?.imogi || 'üôÇ');
	    setText(root.querySelector('.topic-name'), item.topic?.name || '');

	    // ÎÇ†Ïßú
	    setText(root.querySelector('.reg-date'), item.regDate || '');

	    // Î≥∏Î¨∏
	    setText(root.querySelector('.content'), item.content || '');

	    return root;
	  }

	  async function fetchPage() {
	    if (loading || ended) return;
	    loading = true;
	    setState('Î∂àÎü¨Ïò§Îäî Ï§ë‚Ä¶');

	    try {
	      const res = await apiGetWithParam(API_URL, {
	        pageNo: pageNo,
	        keyword: currentKeyword || ''
	      });

	      if (!res || res.code !== '0') {
	        setState(res?.message || 'Ï°∞ÌöåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
	        ended = true;
	        return;
	      }

	      const data = res.data;

	      // ÎÅù Ï°∞Í±¥
	      if (!data || (Array.isArray(data) && data.length === 0)) {
	        ended = true;
	        setState($list.children.length === 0 ? 'Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.' : 'ÎßàÏßÄÎßâÏûÖÎãàÎã§.');
	        return;
	      }

	      const holder = document.createDocumentFragment();
	      for (const it of data) holder.appendChild(createNode(it));
	      $list.appendChild(holder);

	      pageNo += 1;
	      setState('');
	    } catch (e) {
	      console.error(e);
	      setState('ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
	      ended = true;
	    } finally {
	      loading = false;
	    }
	  }

	  // Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ
	  $list.addEventListener('click', (e) => {
	    // 1) ‚Üí Î≤ÑÌäº: fragUidÎ°ú Ïù¥Îèô
	    const btnFrag = e.target.closest('button.btn-frag-link');
	    if (btnFrag) {
	      const card = btnFrag.closest('[data-frag-uid]');
	      const uid = card?.dataset?.fragUid;
	      if (uid) location.href = cp + '/Fragment/index.html?fragUid=' + encodeURIComponent(uid);
	      return;
	    }

	    // 2) topic ÏòÅÏó≠ ÌÅ¥Î¶≠: topicUidÎ°ú Ïù¥Îèô
	    const btnTopic = e.target.closest('button.topic-hit');
	    if (btnTopic) {
	      const card = btnTopic.closest('[data-topic-uid]');
	      const topicUid = card?.dataset?.topicUid;
	      if (topicUid) location.href = cp + '/Fragment/index.html?topicUid=' + encodeURIComponent(topicUid);
	      return;
	    }
	  });

	  // Í≤ÄÏÉâ
	  async function resetAndLoad() {
	    pageNo = 1;
	    ended = false;
	    loading = false;
	    $list.innerHTML = '';
	    setState('');
	    await fetchPage();
	  }

	  $btnSearch.addEventListener('click', () => {
	    currentKeyword = ($keyword.value || '').trim();
	    resetAndLoad();
	  });

	  $keyword.addEventListener('keydown', (e) => {
	    if (e.key === 'Enter') {
	      currentKeyword = ($keyword.value || '').trim();
	      resetAndLoad();
	    }
	  });

	  // Î¨¥Ìïú Ïä§ÌÅ¨Î°§
	  const io = new IntersectionObserver((entries) => {
	    const ent = entries[0];
	    if (ent.isIntersecting) fetchPage();
	  }, { root: null, threshold: 0.1 });

	  io.observe($sentinel);

	  // Ï≤´ Î°úÎìú
	  fetchPage();
	})();
	</script>
	</th:block>
</body>
</html>
