<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{My/MyLayout}">

<th:block layout:fragment="my_title">마이페이지</th:block>

<th:block layout:fragment="my_content">
	<div class="max-w-sm mx-auto px-4 pb-24">

		<div id="myPageRoot" th:attr="data-login-uid=${user.uid},data-item-uid=${item.user.uid}">
		</div>

		<!-- iOS 카드 -->
		<div class="mt-4 rounded-2xl bg-white shadow-sm ring-1 ring-slate-200/70 overflow-hidden">

			<!-- 프로필 -->
			<div class="px-6 pb-4 pt-2 flex flex-col items-center">
				<label id="profileLabel"
					class="w-24 h-24 rounded-2xl bg-slate-100 ring-1 ring-slate-200 flex items-center justify-center overflow-hidden cursor-pointer">
					<img id="profileImg" th:src="${item.user.profileUrl}"
						onerror="this.style.display='none'; document.getElementById('profileFallback').classList.remove('hidden');"
						class="w-full h-full object-cover" alt="profile" />

					<div id="profileFallback" class="hidden">
						<svg class="w-12 h-12 text-slate-400" viewBox="0 0 24 24" fill="none">
							<path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="2" />
							<path d="M20 20a8 8 0 1 0-16 0" stroke="currentColor" stroke-width="2"
								stroke-linecap="round" />
						</svg>
					</div>

					<input id="profileFile" type="file" accept="image/*" class="hidden" />
				</label>

				<input id="nickname" th:value="${item.user.nickname}" maxlength="32" class="mt-3 w-full text-center text-xl font-bold tracking-tight text-slate-900
                      outline-none bg-transparent" placeholder="닉네임" />
			</div>

			<!-- 구분선 -->
			<div class="h-[1px] bg-slate-200/70"></div>

			<!-- 이용 통계: iOS 리스트 -->
			<div class="px-4 py-4">
				<div class="text-sm font-semibold text-slate-500 text-center mb-3">이용 통계</div>

				<ul class="rounded-2xl bg-slate-50 ring-1 ring-slate-200/60 overflow-hidden">
					<li class="flex items-center justify-between px-4 py-3">
						<span class="text-slate-700">Topic 생성</span>
						<span class="font-semibold text-slate-900"
							th:text="${item.statistics.topicCreatedCount}">0</span>
					</li>
					<div class="h-[1px] bg-slate-200/60"></div>
					<li class="flex items-center justify-between px-4 py-3">
						<span class="text-slate-700">Topic 팔로우</span>
						<span class="font-semibold text-slate-900"
							th:text="${item.statistics.topicFollowCount}">0</span>
					</li>
					<div class="h-[1px] bg-slate-200/60"></div>
					<li class="flex items-center justify-between px-4 py-3">
						<span class="text-slate-700">로그인</span>
						<span class="font-semibold text-slate-900" th:text="${item.statistics.loginCount}">0</span>
					</li>
					<div class="h-[1px] bg-slate-200/60"></div>
					<li class="flex items-center justify-between px-4 py-3">
						<span class="text-slate-700">Fragment 작성</span>
						<span class="font-semibold text-slate-900"
							th:text="${item.statistics.fragmentWriteCount}">0</span>
					</li>
					<div class="h-[1px] bg-slate-200/60"></div>
					<li class="flex items-center justify-between px-4 py-3">
						<span class="text-slate-700">댓글 작성</span>
						<span class="font-semibold text-slate-900"
							th:text="${item.statistics.commentWriteCount}">0</span>
					</li>
					<div class="h-[1px] bg-slate-200/60"></div>
					<li class="flex items-center justify-between px-4 py-3">
						<span class="text-slate-700">Fragment 감정 참여</span>
						<span class="font-semibold text-slate-900"
							th:text="${item.statistics.fragmentEmotionCount}">0</span>
					</li>
					<div class="h-[1px] bg-slate-200/60"></div>
					<li class="flex items-center justify-between px-4 py-3">
						<span class="text-slate-700">댓글 감정 참여</span>
						<span class="font-semibold text-slate-900"
							th:text="${item.statistics.commentEmotionCount}">0</span>
					</li>
				</ul>
			</div>

			<!-- 구분선 -->
			<div class="h-[1px] bg-slate-200/70"></div>

			<!-- 설정 -->
			<div class="px-4 py-4">
				<div class="text-sm font-semibold text-slate-500 text-center mb-3">설정</div>

				<ul class="rounded-2xl bg-slate-50 ring-1 ring-slate-200/60 overflow-hidden">
					<li class="flex items-center justify-between px-4 py-3">
						<div class="flex flex-col">
							<span class="text-slate-700">푸시 알림 받기</span>
							<span class="text-xs text-slate-500 mt-0.5" id="pushHint">설정 확인 중...</span>
						</div>

						<!-- 토글: pp-toggle -->
						<pp-toggle id="togglePush" name="pushReceive" on-text="ON" off-text="OFF"></pp-toggle>
					</li>
				</ul>
			</div>
			
			<th:block th:if="${isAdmin}">
				<div class="h-[1px] bg-slate-200/70"></div>
				<a th:href="@{/Lotus/Login.html}"
				   class="shrink-0 px-2 py-2 text-sm font-medium text-blue-500 hover:text-blue-600">
				    AdminPage
				</a>
			</th:block>

			<!-- 하단 액션: 로그아웃(버튼) + 탈퇴(우측) -->
			<div class="px-4 pb-5 pt-2">
				<div class="flex items-center justify-between gap-3">
					<button id="btnLogout" type="button" class="flex-1 py-3 rounded-2xl text-base font-semibold
	                     bg-slate-100 text-slate-900 hover:bg-slate-200
	                     ring-1 ring-slate-200">
						로그아웃
					</button>

					<button id="btnWithdraw" type="button"
						class="shrink-0 px-2 py-2 text-sm font-medium text-rose-500 hover:text-rose-600">
						탈퇴
					</button>
				</div>
			</div>
		</div>
	</div>
</th:block>

<th:block layout:fragment="my_script">
	<script type="text/javascript" th:src="@{/js/ToggleButton.js(v=${assetVersion})}"></script>
	<script type="text/javascript" th:src="@{/js/pwa.js(v=${assetVersion})}"></script>

	<script>
		(function () {
			const root = document.getElementById('myPageRoot');
			const loginUid = root?.dataset?.loginUid || '';
			const itemUid = root?.dataset?.itemUid || '';
			const canEdit = (loginUid && itemUid && loginUid === itemUid);

			const $nickname = document.getElementById('nickname');
			const $file = document.getElementById('profileFile');
			const $label = document.getElementById('profileLabel');
			const $img = document.getElementById('profileImg');

			let savingProfile = false;
			let savingNickname = false;

			let lastSavedNickname = ($nickname.value || '').trim();
			let dirtyNickname = false;

			/* =====================
			 * 권한 처리
			 * ===================== */
			if (!canEdit) {
				$nickname.setAttribute('readonly', 'readonly');
				$nickname.classList.add('bg-slate-50', 'text-slate-500');
				$label.classList.add('opacity-50', 'pointer-events-none');
				return;
			}

			/* =====================
			 * 닉네임 변경 감지
			 * ===================== */
			$nickname.addEventListener('input', () => {
				const now = ($nickname.value || '').trim();
				dirtyNickname = (now !== lastSavedNickname);
			});

			/* =====================
			 * 이미지 변경 → 즉시 서버 전송
			 * ===================== */
			$file.addEventListener('change', async (e) => {
				const f = e.target.files?.[0];
				if (!f || savingProfile) return;

				savingProfile = true;

				// 미리보기
				const previewUrl = URL.createObjectURL(f);
				$img.style.display = '';
				$img.src = previewUrl;
				document.getElementById('profileFallback')?.classList.add('hidden');

				try {
					showLoading?.();

					const resized = await resizeImageToBlob(f);
					const fd = new FormData();
					fd.append('uid', itemUid);
					fd.append('profile', resized, 'profile.jpg');

					const cp = window.contextPath || '';
					const res = await fetch(cp + '/My/updateUser.json', {
						method: 'POST',
						body: fd,
						credentials: 'include'
					}).then(r => r.json());

					if (res?.code !== '0') {
						await alertP(res?.message || '프로필 이미지 저장 실패');
						return;
					}

					// 성공 → input 초기화
					$file.value = '';
					showToast?.('', '프로필 이미지가 변경되었습니다.', ToastType.SUCCESS, 1200);

				} catch (e) {
					console.error(e);
					await alertP('프로필 이미지 저장 중 오류가 발생했습니다.');
				} finally {
					hideLoading?.();
					savingProfile = false;
					URL.revokeObjectURL(previewUrl);
				}
			});

			/* =====================
			 * 페이지 이탈 시 닉네임만 저장
			 * ===================== */
			async function saveNicknameIfNeeded() {
				if (!dirtyNickname || savingNickname) return;

				const nickname = ($nickname.value || '').trim();
				if (!nickname) return;

				savingNickname = true;

				try {
					const fd = new FormData();
					fd.append('uid', itemUid);
					fd.append('nickname', nickname);

					const cp = window.contextPath || '';
					const res = await fetch(cp + '/My/updateUser.json', {
						method: 'POST',
						body: fd,
						credentials: 'include'
					}).then(r => r.json());

					if (res?.code === '0') {
						lastSavedNickname = nickname;
						dirtyNickname = false;
					}
				} catch (e) {
					console.warn('닉네임 자동 저장 실패', e);
				} finally {
					savingNickname = false;
				}
			}

			/* =====================
			 * 닉네임 포커스 아웃 시 저장 ⭕
			 * ===================== */
			$nickname.addEventListener('blur', async () => {
			    await saveNicknameIfNeeded();
			});

			$nickname.addEventListener('keydown', (e) => {
			    if (e.key === 'Enter') {
			        e.preventDefault();
			        $nickname.blur(); // blur → 저장 트리거
			    }
			});

			/* =====================
			 * 로그아웃 / 탈퇴 시에도 닉네임 저장 후 진행
			 * ===================== */
			async function leaveAfterNicknameSave(next) {
				await saveNicknameIfNeeded();
				next();
			}

			document.getElementById('btnLogout')?.addEventListener('click', async () => {
				await leaveAfterNicknameSave(async () => {
					const ok = await confirmP('로그아웃 하시겠습니까?');
					if (!ok) return;

					try {
						showLoading?.();
						const cp = window.contextPath || '';
						await apiPost(cp + '/My/Logout.json', {});
						window.location.href = cp + '/';
					} finally {
						hideLoading?.();
					}
				});
			});

			document.getElementById('btnWithdraw')?.addEventListener('click', async () => {
				await leaveAfterNicknameSave(async () => {
					await alertP('탈퇴 시 입력했던 정보는 모두 삭제되며 복구할 수 없습니다.');
					const email = await promptP('탈퇴 확인을 위해 이메일을 입력해 주세요.');
					if (!email) return;

					const cp = window.contextPath || '';
					window.location.href = cp + '/My/Withdraw/Google?email=' + encodeURIComponent(email);
				});
			});

			/* =====================
			 * 유틸: 이미지 리사이즈
			 * ===================== */
			async function resizeImageToBlob(file) {
				const img = new Image();
				img.src = URL.createObjectURL(file);
				await img.decode();

				const max = 512;
				const ratio = Math.min(max / img.width, max / img.height, 1);
				const w = Math.round(img.width * ratio);
				const h = Math.round(img.height * ratio);

				const canvas = document.createElement('canvas');
				canvas.width = w;
				canvas.height = h;
				canvas.getContext('2d').drawImage(img, 0, 0, w, h);

				const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.85));
				URL.revokeObjectURL(img.src);
				return blob;
			}

		})();

		(function () {
			const $togglePush = document.getElementById('togglePush');
			const $pushHint = document.getElementById('pushHint');
			if (!$togglePush) return;

			function setHint(msg) {
				if ($pushHint) $pushHint.textContent = msg || '';
			}
			function setBusy(busy) {
				if (busy) $togglePush.setAttribute('disabled', '');
				else $togglePush.removeAttribute('disabled');
			}

			async function init() {
				setBusy(true);
				try {
					if (!window.PWA_PUSH?.supported()) {
						$togglePush.checked = false;
						$togglePush.setAttribute('disabled', '');
						setHint('이 브라우저는 푸시를 지원하지 않습니다.');
						return;
					}

					const enabled = await PWA_PUSH.getUserPushStatus();
					$togglePush.checked = enabled;
					setHint(enabled ? '푸시 수신: ON' : '푸시 수신: OFF');

				} catch (e) {
					console.error(e);
					setHint('푸시 상태 조회 실패');
					showToast?.('', '푸시 상태 조회에 실패했습니다.', ToastType.ERROR, 1500);
				} finally {
					setBusy(false);
				}
			}

			$togglePush.addEventListener('change', async (e) => {
				const next = !!e.detail?.checked;
				const prev = !next;

				setBusy(true);
				try {
					// 1) 서버(계정) 설정
					await PWA_PUSH.setUserPushStatus(next);

					// 2) 디바이스 구독/해제는 비동기
					if (next) {
						setHint('푸시 수신: ON (이 기기 구독 처리 중...)');
						PWA_PUSH.subscribeDevice().catch(err => console.warn(err));
					} else {
						setHint('푸시 수신: OFF (이 기기 구독 해제 중...)');
						PWA_PUSH.unsubscribeDevice().catch(err => console.warn(err));
					}

					showToast?.('', next ? '푸시 수신이 켜졌습니다.' : '푸시 수신이 꺼졌습니다.', ToastType.SUCCESS, 1200);

				} catch (err) {
					console.error(err);
					$togglePush.checked = prev;
					setHint('푸시 설정 변경 실패');
					showToast?.('', '푸시 설정 변경에 실패했습니다.', ToastType.ERROR, 1500);
				} finally {
					setBusy(false);
				}
			});

			window.addEventListener('load', init);
		})();

	</script>
</th:block>

</html>