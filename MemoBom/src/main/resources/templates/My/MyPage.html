<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{My/MyLayout}">

<th:block layout:fragment="my_title">ë§ˆì´í˜ì´ì§€</th:block>

<th:block layout:fragment="my_content">
  <div class="max-w-sm mx-auto px-4 pb-24">

    <div id="myPageRoot"
         th:attr="data-login-uid=${user},data-item-uid=${item.user.uid}">
    </div>

    <!-- iOS ì¹´ë“œ -->
    <div class="mt-4 rounded-2xl bg-white shadow-sm ring-1 ring-slate-200/70 overflow-hidden">

      <!-- í”„ë¡œí•„ -->
      <div class="px-6 pb-4 pt-2 flex flex-col items-center">
        <label id="profileLabel"
               class="w-24 h-24 rounded-2xl bg-slate-100 ring-1 ring-slate-200 flex items-center justify-center overflow-hidden cursor-pointer">
          <img id="profileImg"
               th:src="${item.user.profileUrl}"
               onerror="this.style.display='none'; document.getElementById('profileFallback').classList.remove('hidden');"
               class="w-full h-full object-cover"
               alt="profile"/>

          <div id="profileFallback" class="hidden">
            <svg class="w-12 h-12 text-slate-400" viewBox="0 0 24 24" fill="none">
              <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="2"/>
              <path d="M20 20a8 8 0 1 0-16 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>

          <input id="profileFile" type="file" accept="image/*" class="hidden"/>
        </label>

        <input id="nickname"
               th:value="${item.user.nickname}"
			   maxlength="32"
			   class="mt-3 w-full text-center text-xl font-bold tracking-tight text-slate-900
                      outline-none bg-transparent"
               placeholder="ë‹‰ë„¤ì„"/>
      </div>

      <!-- êµ¬ë¶„ì„  -->
      <div class="h-[1px] bg-slate-200/70"></div>

      <!-- ì´ìš© í†µê³„: iOS ë¦¬ìŠ¤íŠ¸ -->
      <div class="px-4 py-4">
        <div class="text-sm font-semibold text-slate-500 text-center mb-3">ì´ìš© í†µê³„</div>

        <ul class="rounded-2xl bg-slate-50 ring-1 ring-slate-200/60 overflow-hidden">
          <li class="flex items-center justify-between px-4 py-3">
            <span class="text-slate-700">Topic ìƒì„±</span>
            <span class="font-semibold text-slate-900" th:text="${item.statistics.topicCreatedCount}">0</span>
          </li>
          <div class="h-[1px] bg-slate-200/60"></div>
          <li class="flex items-center justify-between px-4 py-3">
            <span class="text-slate-700">Topic íŒ”ë¡œìš°</span>
            <span class="font-semibold text-slate-900" th:text="${item.statistics.topicFollowCount}">0</span>
          </li>
          <div class="h-[1px] bg-slate-200/60"></div>
          <li class="flex items-center justify-between px-4 py-3">
            <span class="text-slate-700">ë¡œê·¸ì¸</span>
            <span class="font-semibold text-slate-900" th:text="${item.statistics.loginCount}">0</span>
          </li>
          <div class="h-[1px] bg-slate-200/60"></div>
          <li class="flex items-center justify-between px-4 py-3">
            <span class="text-slate-700">Fragment ì‘ì„±</span>
            <span class="font-semibold text-slate-900" th:text="${item.statistics.fragmentWriteCount}">0</span>
          </li>
          <div class="h-[1px] bg-slate-200/60"></div>
          <li class="flex items-center justify-between px-4 py-3">
            <span class="text-slate-700">ëŒ“ê¸€ ì‘ì„±</span>
            <span class="font-semibold text-slate-900" th:text="${item.statistics.commentWriteCount}">0</span>
          </li>
          <div class="h-[1px] bg-slate-200/60"></div>
          <li class="flex items-center justify-between px-4 py-3">
            <span class="text-slate-700">Fragment ê°ì • ì°¸ì—¬</span>
            <span class="font-semibold text-slate-900" th:text="${item.statistics.fragmentEmotionCount}">0</span>
          </li>
          <div class="h-[1px] bg-slate-200/60"></div>
          <li class="flex items-center justify-between px-4 py-3">
            <span class="text-slate-700">ëŒ“ê¸€ ê°ì • ì°¸ì—¬</span>
            <span class="font-semibold text-slate-900" th:text="${item.statistics.commentEmotionCount}">0</span>
          </li>
        </ul>
      </div>

	  <!-- í•˜ë‹¨ ì•¡ì…˜: ë¡œê·¸ì•„ì›ƒ(ë²„íŠ¼) + íƒˆí‡´(ìš°ì¸¡) -->
	  <div class="px-4 pb-5 pt-2">
	    <div class="flex items-center justify-between gap-3">
	      <button id="btnLogout"
	              type="button"
	              class="flex-1 py-3 rounded-2xl text-base font-semibold
	                     bg-slate-100 text-slate-900 hover:bg-slate-200
	                     ring-1 ring-slate-200">
	        ë¡œê·¸ì•„ì›ƒ
	      </button>

	      <button id="btnWithdraw"
	              type="button"
	              class="shrink-0 px-2 py-2 text-sm font-medium text-rose-500 hover:text-rose-600">
	        íƒˆí‡´
	      </button>
	    </div>
	  </div>
    </div>
  </div>
</th:block>

<th:block layout:fragment="my_script">
<script>
(function () {
  const root = document.getElementById('myPageRoot');
  const loginUid = root?.dataset?.loginUid || '';
  const itemUid  = root?.dataset?.itemUid  || '';
  const canEdit = (loginUid && itemUid && loginUid === itemUid);

  const $nickname = document.getElementById('nickname');
  const $file = document.getElementById('profileFile');
  const $label = document.getElementById('profileLabel');
  const $img = document.getElementById('profileImg');

  let savingProfile = false;
  let savingNickname = false;

  let lastSavedNickname = ($nickname.value || '').trim();
  let dirtyNickname = false;

  /* =====================
   * ê¶Œí•œ ì²˜ë¦¬
   * ===================== */
  if (!canEdit) {
    $nickname.setAttribute('readonly', 'readonly');
    $nickname.classList.add('bg-slate-50', 'text-slate-500');
    $label.classList.add('opacity-50', 'pointer-events-none');
    return;
  }

  /* =====================
   * ë‹‰ë„¤ì„ ë³€ê²½ ê°ì§€
   * ===================== */
  $nickname.addEventListener('input', () => {
    const now = ($nickname.value || '').trim();
    dirtyNickname = (now !== lastSavedNickname);
  });

  /* =====================
   * ì´ë¯¸ì§€ ë³€ê²½ â†’ ì¦‰ì‹œ ì„œë²„ ì „ì†¡
   * ===================== */
  $file.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f || savingProfile) return;

    savingProfile = true;

    // ë¯¸ë¦¬ë³´ê¸°
    const previewUrl = URL.createObjectURL(f);
    $img.style.display = '';
    $img.src = previewUrl;
    document.getElementById('profileFallback')?.classList.add('hidden');

    try {
      showLoading?.();

      const resized = await resizeImageToBlob(f);
      const fd = new FormData();
      fd.append('uid', itemUid);
      fd.append('profile', resized, 'profile.jpg');

      const cp = window.contextPath || '';
      const res = await fetch(cp + '/My/updateUser.json', {
        method: 'POST',
        body: fd,
        credentials: 'include'
      }).then(r => r.json());

      if (res?.code !== '0') {
        await alertP(res?.message || 'í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨');
        return;
      }

      // ì„±ê³µ â†’ input ì´ˆê¸°í™”
      $file.value = '';
      showToast?.('', 'í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', ToastType.SUCCESS, 1200);

    } catch (e) {
      console.error(e);
      await alertP('í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      hideLoading?.();
      savingProfile = false;
      URL.revokeObjectURL(previewUrl);
    }
  });

  /* =====================
   * í˜ì´ì§€ ì´íƒˆ ì‹œ ë‹‰ë„¤ì„ë§Œ ì €ì¥
   * ===================== */
  async function saveNicknameIfNeeded() {
    if (!dirtyNickname || savingNickname) return;

    const nickname = ($nickname.value || '').trim();
    if (!nickname) return;

    savingNickname = true;

    try {
      const fd = new FormData();
      fd.append('uid', itemUid);
      fd.append('nickname', nickname);

      const cp = window.contextPath || '';
      const res = await fetch(cp + '/My/updateUser.json', {
        method: 'POST',
        body: fd,
        credentials: 'include'
      }).then(r => r.json());

      if (res?.code === '0') {
        lastSavedNickname = nickname;
        dirtyNickname = false;
      }
    } catch (e) {
      console.warn('ë‹‰ë„¤ì„ ìë™ ì €ì¥ ì‹¤íŒ¨', e);
    } finally {
      savingNickname = false;
    }
  }

  /* =====================
   * ì´íƒˆ í›…
   * ===================== */
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
      saveNicknameIfNeeded();
    }
  });

  window.addEventListener('pagehide', () => {
    saveNicknameIfNeeded();
  });

  /* =====================
   * ë¡œê·¸ì•„ì›ƒ / íƒˆí‡´ ì‹œì—ë„ ë‹‰ë„¤ì„ ì €ì¥ í›„ ì§„í–‰
   * ===================== */
  async function leaveAfterNicknameSave(next) {
    await saveNicknameIfNeeded();
    next();
  }

  document.getElementById('btnLogout')?.addEventListener('click', async () => {
    await leaveAfterNicknameSave(async () => {
      const ok = await confirmP('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
      if (!ok) return;

      try {
        showLoading?.();
        const cp = window.contextPath || '';
        await apiPost(cp + '/My/Logout.json', {});
        window.location.href = cp + '/Auth/Login.html';
      } finally {
        hideLoading?.();
      }
    });
  });

  document.getElementById('btnWithdraw')?.addEventListener('click', async () => {
    await leaveAfterNicknameSave(async () => {
      await alertP('íƒˆí‡´ ì‹œ ì…ë ¥í–ˆë˜ ì •ë³´ëŠ” ëª¨ë‘ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      const email = await promptP('íƒˆí‡´ í™•ì¸ì„ ìœ„í•´ ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      if (!email) return;

      const cp = window.contextPath || '';
      window.location.href = cp + '/My/Withdraw/Google?email=' + encodeURIComponent(email);
    });
  });

  /* =====================
   * ìœ í‹¸: ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ
   * ===================== */
  async function resizeImageToBlob(file) {
    const img = new Image();
    img.src = URL.createObjectURL(file);
    await img.decode();

    const max = 512;
    const ratio = Math.min(max / img.width, max / img.height, 1);
    const w = Math.round(img.width * ratio);
    const h = Math.round(img.height * ratio);

    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    canvas.getContext('2d').drawImage(img, 0, 0, w, h);

    const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.85));
    URL.revokeObjectURL(img.src);
    return blob;
  }

})();
</script>
</th:block>


<th:block layout:fragment="my_script______">
  <script>
    (function () {
      const root = document.getElementById('myPageRoot');
      const loginUid = root?.dataset?.loginUid || '';
      const itemUid  = root?.dataset?.itemUid  || '';
      const canEdit = (loginUid && itemUid && loginUid === itemUid);

      const $nickname = document.getElementById('nickname');
      const $file = document.getElementById('profileFile');
      const $label = document.getElementById('profileLabel');
      const $img = document.getElementById('profileImg');

      let saving = false;

      let lastSavedNickname = ($nickname.value || '').trim();
      let dirtyNickname = false;
      let dirtyImage = false;

      // ê¶Œí•œ ì—†ìœ¼ë©´ ìˆ˜ì • ì ê¸ˆ
      if (!canEdit) {
        $nickname.setAttribute('readonly', 'readonly');
        $nickname.classList.add('bg-slate-50', 'text-slate-500');
        $label.classList.add('opacity-50', 'pointer-events-none');
      }

      // ë‹‰ë„¤ì„ ë³€ê²½ ê°ì§€
      $nickname?.addEventListener('input', () => {
        if (!canEdit) return;
        const now = ($nickname.value || '').trim();
        dirtyNickname = (now !== lastSavedNickname);
      });

      // ì´ë¯¸ì§€ ë³€ê²½ ê°ì§€ (â­ ì—¬ê¸°ì„œ dirtyImage=true)
      $file?.addEventListener('change', (e) => {
        if (!canEdit) return;
        const f = e.target.files?.[0];
        if (!f) return;

        dirtyImage = true;

        // ë¯¸ë¦¬ë³´ê¸°
        const url = URL.createObjectURL(f);
        $img.style.display = '';
        $img.src = url;
        document.getElementById('profileFallback')?.classList.add('hidden');
      });

      async function resizeImageToBlob(file, { maxW = 512, maxH = 512, quality = 0.85 } = {}) {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();

        const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
        const w = Math.round(img.width * ratio);
        const h = Math.round(img.height * ratio);

        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d', { alpha: false });
        ctx.drawImage(img, 0, 0, w, h);

        const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', quality));
        URL.revokeObjectURL(img.src);
        return blob;
      }

      // â­ ë³€ê²½: ë‹‰ë„¤ì„ì´ ì•ˆ ë°”ë€Œì–´ë„ ì´ë¯¸ì§€ê°€ ë°”ë€Œë©´ í˜¸ì¶œ
      async function updateMyInfo() {
        if (!canEdit) return true;
        if (saving) return false;

        const needSave = dirtyNickname || dirtyImage;
        if (!needSave) return true;

        const nickname = ($nickname.value || '').trim();

        // ë‹‰ë„¤ì„ì„ ë¹ˆ ê°’ìœ¼ë¡œ ë³´ë‚´ê³  ì‹¶ì§€ ì•Šë‹¤ë©´ ë°©ì–´
        if (!nickname) {
          await alertP('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return false;
        }

        saving = true;

        const fd = new FormData();
        fd.append('uid', itemUid);
        fd.append('nickname', nickname);

        const f = $file.files?.[0];

        // â­ ì´ë¯¸ì§€ê°€ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ profile ì²¨ë¶€
        if (dirtyImage && f) {
          const resizedBlob = await resizeImageToBlob(f, { maxW: 512, maxH: 512, quality: 0.85 });
          fd.append('profile', resizedBlob, 'profile.jpg');
        }

        try {
          showLoading?.();
          const cp = window.contextPath || '';
          const res = await fetch(cp + '/My/updateUser.json', {
            method: 'POST',
            body: fd,
            credentials: 'include'
          }).then(r => r.json());

          if (res?.code !== '0') {
            await alertP(res?.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            return false;
          }

          // âœ… ì €ì¥ ì„±ê³µ ì‹œ ìƒíƒœ ë¦¬ì…‹
          lastSavedNickname = nickname;
          dirtyNickname = false;
          dirtyImage = false;

          // â­ file input ë¹„ì›Œì„œ ë‹¤ìŒ ì´íƒˆ ë•Œ ë˜ ì €ì¥ë˜ëŠ” ê²ƒ ë°©ì§€
          if ($file) $file.value = '';

          showToast?.('', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', ToastType.SUCCESS, 1000);
          return true;
        } catch (e) {
          console.error(e);
          await alertP('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return false;
        } finally {
          hideLoading?.();
          saving = false;
        }
      }

      async function leaveWithAutoSave(nextAction) {
        const needSave = dirtyNickname || dirtyImage;
        if (!needSave) return nextAction();

        const saved = await updateMyInfo();
        if (saved) return nextAction();

        const go = await confirmP('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì €ì¥í•˜ì§€ ì•Šê³  ì´ë™í• ê¹Œìš”?');
        if (go) return nextAction();
      }

      // iOSì—ì„œ í˜ì´ì§€ ìˆ¨ê¹€ ì‹œì  ìë™ ì €ì¥ ì‹œë„
      let autoSaveTriggered = false;
      async function tryAutoSaveOnHide() {
        if (autoSaveTriggered) return;
        if (!(dirtyNickname || dirtyImage)) return;
        autoSaveTriggered = true;
        try { await updateMyInfo(); } finally { autoSaveTriggered = false; }
      }

      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') tryAutoSaveOnHide();
      });
      window.addEventListener('pagehide', () => tryAutoSaveOnHide());

      // ë¡œê·¸ì•„ì›ƒ
      document.getElementById('btnLogout')?.addEventListener('click', async () => {
        await leaveWithAutoSave(async () => {
          const ok = await confirmP('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
          if (!ok) return;

          try {
            showLoading?.();
            const cp = window.contextPath || '';
            const res = await apiPost(cp + '/My/Logout.json', {});
            if (res?.code && res.code !== '0') {
              await alertP(res?.message || 'ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨');
              return;
            }
            window.location.href = cp + '/Auth/Login.html';
          } catch (e) {
            console.error(e);
            await alertP('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          } finally {
            hideLoading?.();
          }
        });
      });

      // íƒˆí‡´
      async function withdrawFlow() {
        await alertP('íƒˆí‡´ ì‹œ ì…ë ¥í–ˆë˜ ì •ë³´ëŠ” ëª¨ë‘ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        const email = await promptP('íƒˆí‡´ í™•ì¸ì„ ìœ„í•´ ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        if (email === false) return;

        const v = String(email || '').trim();
        if (!v) { await alertP('ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }

        const cp = window.contextPath || '';
        window.location.href = cp + '/My/Withdraw/Google?email=' + encodeURIComponent(v);
      }

      document.getElementById('btnWithdraw')?.addEventListener('click', async () => {
        await leaveWithAutoSave(withdrawFlow);
      });

    })();
  </script>
</th:block>


<th:block layout:fragment="my_script_">
  <script>
    (function () {
      const root = document.getElementById('myPageRoot');
      const loginUid = root?.dataset?.loginUid || '';
      const itemUid  = root?.dataset?.itemUid  || '';
      const canEdit = (loginUid && itemUid && loginUid === itemUid);

      const $nickname = document.getElementById('nickname');
      const $file = document.getElementById('profileFile');
      const $label = document.getElementById('profileLabel');
      const $img = document.getElementById('profileImg');

      let dirty = false;
      let saving = false;
      let lastSavedNickname = ($nickname.value || '').trim();
      let lastSavedFileSig = ""; // íŒŒì¼ ë³€ê²½ ê°ì§€ìš©

      function setDirty(v) { dirty = v; }

      // ê¶Œí•œ ì—†ìœ¼ë©´ ìˆ˜ì • ì ê¸ˆ
      if (!canEdit) {
        $nickname.setAttribute('readonly', 'readonly');
        $nickname.classList.add('bg-slate-50', 'text-slate-500');
        $label.classList.add('opacity-50', 'pointer-events-none');
      }

      // ë‹‰ë„¤ì„ ë³€ê²½ ê°ì§€(ì…ë ¥ ì¤‘ì—ëŠ” dirtyë§Œ ì˜¬ë ¤ë‘ê³  ì €ì¥ì€ ì´íƒˆ ì‹œì )
      $nickname?.addEventListener('input', () => {
        if (!canEdit) return;
        const now = ($nickname.value || '').trim();
        if (now !== lastSavedNickname) setDirty(true);
      });

      // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° + dirty
      $file?.addEventListener('change', (e) => {
        if (!canEdit) return;
        const f = e.target.files?.[0];
        if (!f) return;

        // íŒŒì¼ ì‹œê·¸ë‹ˆì²˜(ê°„ë‹¨)ë¡œ ë³€ê²½ ì¶”ì 
        lastSavedFileSig = `${f.name}:${f.size}:${f.lastModified}`;
        setDirty(true);

        // ë¯¸ë¦¬ë³´ê¸°
        const url = URL.createObjectURL(f);
        $img.style.display = '';
        $img.src = url;
        document.getElementById('profileFallback')?.classList.add('hidden');
      });

      async function resizeImageToBlob(file, { maxW = 512, maxH = 512, quality = 0.85 } = {}) {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();

        const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
        const w = Math.round(img.width * ratio);
        const h = Math.round(img.height * ratio);

        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d', { alpha: false });
        ctx.drawImage(img, 0, 0, w, h);

        const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', quality));
        URL.revokeObjectURL(img.src);
        return blob;
      }

      async function updateMyInfo() {
        if (!canEdit) return true;
        if (!dirty) return true;
        if (saving) return false;

        const nickname = ($nickname.value || '').trim();
        if (!nickname) {
          await alertP('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return false;
        }

        saving = true;

        const fd = new FormData();
        fd.append('uid', itemUid);
        fd.append('nickname', nickname);

        const f = $file.files?.[0];
        if (f) {
          const resizedBlob = await resizeImageToBlob(f, { maxW: 512, maxH: 512, quality: 0.85 });
          fd.append('profile', resizedBlob, 'profile.jpg');
        }

        try {
          showLoading?.();
          const cp = window.contextPath || '';
          const res = await fetch(cp + '/My/updateUser.json', {
            method: 'POST',
            body: fd,
            credentials: 'include'
          }).then(r => r.json());

          if (res?.code !== '0') {
            await alertP(res?.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            return false;
          }

          // ì €ì¥ ì„±ê³µ ìƒíƒœ ê°±ì‹ 
          lastSavedNickname = nickname;
          if (f) {
            // ì €ì¥ í›„ íŒŒì¼ ì…ë ¥ì€ ìœ ì§€í•´ë„ ë˜ì§€ë§Œ, â€œì €ì¥ë¨â€ ìƒíƒœë§Œ dirty=false ì²˜ë¦¬
            // í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ $file.value = '' ë¡œ ì´ˆê¸°í™” ê°€ëŠ¥
          }
          dirty = false;

          showToast?.('', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', ToastType.SUCCESS, 1000);
          return true;
        } catch (e) {
          console.error(e);
          await alertP('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return false;
        } finally {
          hideLoading?.();
          saving = false;
        }
      }

      /**
       * ì´ í˜ì´ì§€ë¥¼ ë– ë‚˜ëŠ” ì•¡ì…˜(ë¡œê·¸ì•„ì›ƒ/íƒˆí‡´/ë©”ë‰´ ì´ë™ ë“±)ì„ ìš°ë¦¬ê°€ ì œì–´í•  ë•Œ:
       * - ë³€ê²½ì‚¬í•­ ìˆìœ¼ë©´ ì €ì¥ í›„ ì§„í–‰
       */
      async function leaveWithAutoSave(nextAction) {
        if (!dirty) return nextAction();

        // ì €ì¥ ì‹¤íŒ¨í•´ë„ ë‚˜ê°€ì•¼ í•˜ëŠ” ì •ì±…ì´ë©´ confirm ì¶”ê°€ ê°€ëŠ¥
        const saved = await updateMyInfo();
        if (saved) return nextAction();

        // ì €ì¥ ì‹¤íŒ¨ ì‹œ: ì‚¬ìš©ìì—ê²Œ ì„ íƒê¶Œ
        const go = await confirmP('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì €ì¥í•˜ì§€ ì•Šê³  ì´ë™í• ê¹Œìš”?');
        if (go) return nextAction();
      }

      // ğŸ”¸ iOSì—ì„œ â€œí˜ì´ì§€ ìˆ¨ê¹€/ë°±ê·¸ë¼ìš´ë“œâ€ ì‹œì ì— ìë™ ì €ì¥ ì‹œë„
      // (ì£¼ì˜: fetchê°€ í•­ìƒ ë³´ì¥ë˜ì§„ ì•ŠìŒ. ê·¸ë˜ë„ ìµœëŒ€í•œ ì‹œë„)
      let autoSaveTriggered = false;

      async function tryAutoSaveOnHide() {
        if (autoSaveTriggered) return;
        if (!dirty) return;
        autoSaveTriggered = true;
        try { await updateMyInfo(); } finally { autoSaveTriggered = false; }
      }

      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          tryAutoSaveOnHide();
        }
      });

      window.addEventListener('pagehide', () => {
        // pagehideëŠ” bfcache í¬í•¨í•´ì„œ iOSì—ì„œ ë” ì˜ ì¡íˆëŠ” í¸
        tryAutoSaveOnHide();
      });

      // ë¡œê·¸ì•„ì›ƒ
      document.getElementById('btnLogout')?.addEventListener('click', async () => {
        await leaveWithAutoSave(async () => {
          const ok = await confirmP('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
          if (!ok) return;

          try {
            showLoading?.();
            const cp = window.contextPath || '';
            const res = await apiPost(cp + '/My/Logout.json', {});
            if (res?.code && res.code !== '0') {
              await alertP(res?.message || 'ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨');
              return;
            }
            window.location.href = cp + '/Auth/Login.html';
          } catch (e) {
            console.error(e);
            await alertP('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          } finally {
            hideLoading?.();
          }
        });
      });

      // íƒˆí‡´
      async function withdrawFlow() {
        await alertP('íƒˆí‡´ ì‹œ ì…ë ¥í–ˆë˜ ì •ë³´ëŠ” ëª¨ë‘ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        const email = await promptP('íƒˆí‡´ í™•ì¸ì„ ìœ„í•´ ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        if (email === false) return;

        const v = String(email || '').trim();
        if (!v) { await alertP('ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }

        const cp = window.contextPath || '';
        window.location.href = cp + '/My/Withdraw/Google?email=' + encodeURIComponent(v);
      }

      document.getElementById('btnWithdraw')?.addEventListener('click', async () => {
        await leaveWithAutoSave(withdrawFlow);
      });

    })();
  </script>
</th:block>


<th:block layout:fragment="my_script__">
  <script>
    (function () {
      const root = document.getElementById('myPageRoot');
      const loginUid = root?.dataset?.loginUid || '';
      const itemUid  = root?.dataset?.itemUid  || '';
      const canEdit = (loginUid && itemUid && loginUid === itemUid);

      const $nickname = document.getElementById('nickname');
      const $file = document.getElementById('profileFile');
      const $label = document.getElementById('profileLabel');
      const $btnSave = document.getElementById('btnSave');
      const $img = document.getElementById('profileImg');

      let dirty = false;
      let saving = false;
      const originNickname = ($nickname.value || '').trim();

      function setDirty(v) {
        dirty = v;
        if (!canEdit) return;
        // ë³€ê²½ ìˆì„ ë•Œë§Œ ì €ì¥ ë²„íŠ¼ ë…¸ì¶œ
        $btnSave.classList.toggle('hidden', !dirty);
        $btnSave.disabled = !dirty || saving;
      }

      // ê¶Œí•œ ì—†ìœ¼ë©´ ìˆ˜ì • ì ê¸ˆ
      if (!canEdit) {
        $nickname.setAttribute('readonly', 'readonly');
        $nickname.classList.add('bg-slate-50', 'text-slate-500');
        $label.classList.add('opacity-50', 'pointer-events-none');
        $btnSave?.remove(); // ì•„ì˜ˆ ì œê±°
      }

      // ë³€ê²½ ê°ì§€
      $nickname?.addEventListener('input', () => {
        const now = ($nickname.value || '').trim();
        setDirty(now !== originNickname);
      });

      // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° + dirty
      $file?.addEventListener('change', async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        $img.style.display = '';
        $img.src = url;
        document.getElementById('profileFallback')?.classList.add('hidden');
        setDirty(true);
      });

      async function resizeImageToBlob(file, { maxW = 512, maxH = 512, quality = 0.85 } = {}) {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();

        const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
        const w = Math.round(img.width * ratio);
        const h = Math.round(img.height * ratio);

        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d', { alpha: false });
        ctx.drawImage(img, 0, 0, w, h);

        const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', quality));
        URL.revokeObjectURL(img.src);
        return blob;
      }

      async function updateMyInfo() {
        if (!canEdit) return true;
        if (!dirty) return true; // ë°”ë€ ê²Œ ì—†ìœ¼ë©´ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
        if (saving) return false;

        const nickname = ($nickname.value || '').trim();
        if (!nickname) {
          await alertP('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return false;
        }

        saving = true;
        if ($btnSave) $btnSave.disabled = true;

        const fd = new FormData();
        fd.append('uid', itemUid);
        fd.append('nickname', nickname);

        const f = $file.files?.[0];
        if (f) {
          const resizedBlob = await resizeImageToBlob(f, { maxW: 512, maxH: 512, quality: 0.85 });
          fd.append('profile', resizedBlob, 'profile.jpg');
        }

        try {
          showLoading?.();
          const cp = window.contextPath || '';
          const res = await fetch(cp + '/My/updateUser.json', {
            method: 'POST',
            body: fd,
            credentials: 'include'
          }).then(r => r.json());

          if (res?.code !== '0') {
            await alertP(res?.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            return false;
          }

          // ì €ì¥ ì„±ê³µ ì²˜ë¦¬
          setDirty(false);
          showToast?.('', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', ToastType.SUCCESS, 1200);
          return true;
        } catch (e) {
          console.error(e);
          await alertP('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return false;
        } finally {
          hideLoading?.();
          saving = false;
          if ($btnSave) $btnSave.disabled = !dirty;
        }
      }

      // ì €ì¥ ë²„íŠ¼ í´ë¦­
      $btnSave?.addEventListener('click', updateMyInfo);

      // í˜ì´ì§€ ì´íƒˆ ì‹œ ìë™ ì €ì¥(ìˆ˜ì •ì‚¬í•­ ìˆìœ¼ë©´)
      window.addEventListener('beforeunload', (e) => {
        // ë¸Œë¼ìš°ì € ê¸°ë³¸ confirm(ëª¨ë°”ì¼ ì‚¬íŒŒë¦¬ ì œì•½) ìµœì†Œí•œì˜ ì•ˆì „ì¥ì¹˜
        if (dirty) {
          e.preventDefault();
          e.returnValue = '';
        }
      });

      // SPA/ë§í¬ ì´ë™ì„ ìš°ë¦¬ê°€ ì œì–´í•  ë•Œ: í„°ì¹˜ ê¸°ë°˜ â€œì´íƒˆâ€ íë¦„
      async function tryLeave(action) {
        if (!dirty) return action();

        const ok = await confirmP('ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ì €ì¥í•˜ê³  ë‚˜ê°ˆê¹Œìš”?');
        if (!ok) return action(); // ì €ì¥ ì•ˆ í•˜ê³  ë‚˜ê°

        const saved = await updateMyInfo();
        if (saved) action();
      }

      // ë¡œê·¸ì•„ì›ƒ
      document.getElementById('btnLogout')?.addEventListener('click', async () => {
        await tryLeave(async () => {
          const ok = await confirmP('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
          if (!ok) return;

          try {
            showLoading?.();
            const cp = window.contextPath || '';
            const res = await apiPost(cp + '/My/Logout.json', {});
            if (res?.code && res.code !== '0') {
              await alertP(res?.message || 'ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨');
              return;
            }
            window.location.href = cp + '/';
          } catch (e) {
            console.error(e);
            await alertP('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          } finally {
            hideLoading?.();
          }
        });
      });

      // íƒˆí‡´(ìš°ì¸¡ ìƒë‹¨ ë²„íŠ¼)
      async function withdrawFlow() {
        await alertP('íƒˆí‡´ ì‹œ ì…ë ¥í–ˆë˜ ì •ë³´ëŠ” ëª¨ë‘ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        const email = await promptP('íƒˆí‡´ í™•ì¸ì„ ìœ„í•´ ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        if (email === false) return;

        const v = String(email || '').trim();
        if (!v) { await alertP('ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }

        const cp = window.contextPath || '';
        window.location.href = cp + '/My/Withdraw/Google?email=' + encodeURIComponent(v);
      }

      document.getElementById('btnWithdraw')?.addEventListener('click', async () => {
        await tryLeave(withdrawFlow);
      });

    })();
  </script>
</th:block>

</html>