<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{My/MyLayout}">

<th:block layout:fragment="my_title">마이페이지</th:block>

<th:block layout:fragment="my_css">
	<style>
		/* 공통: 파란 accent 제거 + 트랙/채움 고정 */
		input[type="range"].font-range {
			-webkit-appearance: none;
			appearance: none;
			width: 100%;
			height: 24px;
			background: transparent;
			outline: none;
		}

		/* Webkit (Chrome/Safari/Edge) */
		input[type="range"].font-range::-webkit-slider-runnable-track {
			height: 4px;
			background: #e5e7eb;
			/* gray-200 */
			border-radius: 999px;
		}

		input[type="range"].font-range::-webkit-slider-thumb {
			-webkit-appearance: none;
			appearance: none;
			width: 18px;
			height: 18px;
			border-radius: 999px;
			background: #ffffff;
			border: 2px solid #6b7280;
			/* gray-500 */
			margin-top: -7px;
			/* (thumb 18 - track 4)/2 */
			box-shadow: 0 1px 2px rgba(0, 0, 0, 0.12);
		}

		/* Firefox */
		input[type="range"].font-range::-moz-range-track {
			height: 4px;
			background: #e5e7eb;
			border-radius: 999px;
		}

		input[type="range"].font-range::-moz-range-progress {
			background: #e5e7eb;
			/* 진행부도 동일색으로 (파란색 제거) */
			height: 4px;
			border-radius: 999px;
		}

		input[type="range"].font-range::-moz-range-thumb {
			width: 18px;
			height: 18px;
			border-radius: 999px;
			background: #ffffff;
			border: 2px solid #6b7280;
			box-shadow: 0 1px 2px rgba(0, 0, 0, 0.12);
		}
	</style>
</th:block>


<th:block layout:fragment="my_content">
	<div class="max-w-sm mx-auto px-4 pb-24">

		<div id="myPageRoot" th:attr="data-login-uid=${user.uid},data-item-uid=${item.user.uid}">
		</div>

		<!-- iOS 카드 -->
		<div class="mt-4 rounded-2xl bg-white shadow-sm ring-1 ring-slate-200/70 overflow-hidden">

			<!-- 프로필 -->
			<div class="px-6 pb-4 pt-2 flex flex-col items-center">
				<label id="profileLabel"
					class="w-24 h-24 rounded-2xl bg-slate-100 ring-1 ring-slate-200 flex items-center justify-center overflow-hidden cursor-pointer">
					<img id="profileImg" th:src="${item.user.profileUrl}"
						onerror="this.style.display='none'; document.getElementById('profileFallback').classList.remove('hidden');"
						class="w-full h-full object-cover" alt="profile" />

					<div id="profileFallback" class="hidden">
						<svg class="w-12 h-12 text-slate-400" viewBox="0 0 24 24" fill="none">
							<path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="2" />
							<path d="M20 20a8 8 0 1 0-16 0" stroke="currentColor" stroke-width="2"
								stroke-linecap="round" />
						</svg>
					</div>

					<input id="profileFile" type="file" accept="image/*" class="hidden" />
				</label>

				<input id="nickname" th:value="${item.user.nickname}" maxlength="32" class="mt-3 w-full text-center text-dynamic-xl font-bold tracking-tight text-slate-900
                      outline-none bg-transparent" placeholder="닉네임" />
			</div>

			<!-- 구분선 -->
			<div class="h-[1px] bg-slate-200/70"></div>

			<!-- 이용 통계: iOS 리스트 -->
			<div class="px-4 py-4">
				<div class="text-dynamic-sm font-semibold text-slate-500 text-center mb-3">이용 통계</div>

				<ul class="rounded-2xl bg-slate-50 divide-y divide-slate-200/50 overflow-hidden">
					<li class="flex items-center justify-between px-4 py-3">
						<span class="text-slate-700">Mosaic 생성</span>
						<span class="font-semibold text-slate-900"
							th:text="${item.statistics.topicCreatedCount}">0</span>
					</li>
					<div class="h-[1px] bg-slate-200/60"></div>
					<li class="flex items-center justify-between px-4 py-3">
						<span class="text-slate-700">Mosaic 팔로우</span>
						<span class="font-semibold text-slate-900"
							th:text="${item.statistics.topicFollowCount}">0</span>
					</li>
					<div class="h-[1px] bg-slate-200/60"></div>
					<li class="flex items-center justify-between px-4 py-3">
						<span class="text-slate-700">로그인</span>
						<span class="font-semibold text-slate-900" th:text="${item.statistics.loginCount}">0</span>
					</li>
					<div class="h-[1px] bg-slate-200/60"></div>
					<li class="flex items-center justify-between px-4 py-3">
						<span class="text-slate-700">Fragment 작성</span>
						<span class="font-semibold text-slate-900"
							th:text="${item.statistics.fragmentWriteCount}">0</span>
					</li>
					<div class="h-[1px] bg-slate-200/60"></div>
					<li class="flex items-center justify-between px-4 py-3">
						<span class="text-slate-700">댓글 작성</span>
						<span class="font-semibold text-slate-900"
							th:text="${item.statistics.commentWriteCount}">0</span>
					</li>
					<div class="h-[1px] bg-slate-200/60"></div>
					<li class="flex items-center justify-between px-4 py-3">
						<span class="text-slate-700">Fragment 감정 참여</span>
						<span class="font-semibold text-slate-900"
							th:text="${item.statistics.fragmentEmotionCount}">0</span>
					</li>
					<div class="h-[1px] bg-slate-200/60"></div>
					<li class="flex items-center justify-between px-4 py-3">
						<span class="text-slate-700">댓글 감정 참여</span>
						<span class="font-semibold text-slate-900"
							th:text="${item.statistics.commentEmotionCount}">0</span>
					</li>
				</ul>
			</div>

			<!-- 구분선 -->
			<div class="h-[1px] bg-slate-200/70"></div>

			<!-- 설정 -->
			<div class="px-4 py-4">
				<div class="text-dynamic-sm font-semibold text-slate-500 text-center mb-3">설정</div>

				<ul class="rounded-2xl bg-slate-50 ring-1 ring-slate-200/60 overflow-hidden">
					<li class="flex items-center justify-between px-4 py-3">
						<div class="flex flex-col">
							<span class="text-slate-700">푸시 알림 받기</span>
							<span class="text-dynamic-xs text-slate-500 mt-0.5" id="pushHint">설정 확인 중...</span>
						</div>

						<!-- 토글: pp-toggle -->
						<pp-toggle id="togglePush" name="pushReceive" on-text="ON" off-text="OFF"></pp-toggle>
					</li>

					<li class="px-4 py-4">
						<div class="relative px-2">
							<input id="fontSizeRange" type="range" min="0" max="4" step="1" class="w-full font-range"
								th:attr="data-init=${item.user.fontSize == null ? 'md' : #strings.toLowerCase(item.user.fontSize)}" />

							<div id="fontSizeLabels"
								class="flex justify-between mt-2 text-slate-500 leading-none select-none">
								<span data-index="0" class="text-xs">최소</span>
								<span data-index="1" class="text-sm">소</span>
								<span data-index="2" class="text-base">중</span>
								<span data-index="3" class="text-lg">대</span>
								<span data-index="4" class="text-xl">최대</span>
							</div>
						</div>
					</li>
				</ul>
			</div>

			<th:block th:if="${isAdmin}">
				<div class="h-[1px] bg-slate-200/70"></div>
				<a th:href="@{/Lotus/Login.html}"
					class="shrink-0 px-2 py-2 text-dynamic-sm font-medium text-blue-500 hover:text-blue-600">
					AdminPage
				</a>
			</th:block>

			<!-- 하단 액션: 로그아웃(버튼) + 탈퇴(우측) -->
			<div class="px-4 pb-5 pt-2">
				<div class="flex items-center justify-between gap-3">
					<button id="btnLogout" type="button" class="flex-1 py-3 rounded-2xl text-dynamic-base font-semibold
	                     bg-slate-100 text-slate-900 hover:bg-slate-200
	                     ring-1 ring-slate-200">
						로그아웃
					</button>

					<button id="btnWithdraw" type="button"
						class="shrink-0 px-2 py-2 text-dynamic-sm font-medium text-rose-500 hover:text-rose-600">
						탈퇴
					</button>
				</div>
			</div>
		</div>
	</div>
</th:block>

<th:block layout:fragment="my_script">
	<script type="text/javascript" th:src="@{/js/ToggleButton.js(v=${assetVersion})}"></script>
	<script type="text/javascript" th:src="@{/js/pwa.js(v=${assetVersion})}"></script>

	<script th:inline="javascript">
		(function () {
			const root = document.getElementById('myPageRoot');
			const loginUid = root?.dataset?.loginUid || '';
			const itemUid = root?.dataset?.itemUid || '';
			const canEdit = (loginUid && itemUid && loginUid === itemUid);

			const $nickname = document.getElementById('nickname');
			const $file = document.getElementById('profileFile');
			const $label = document.getElementById('profileLabel');
			const $img = document.getElementById('profileImg');

			let savingProfile = false;
			let savingNickname = false;

			let lastSavedNickname = ($nickname.value || '').trim();
			let dirtyNickname = false;

			/* =====================
			 * 권한 처리
			 * ===================== */
			if (!canEdit) {
				$nickname.setAttribute('readonly', 'readonly');
				$nickname.classList.add('bg-slate-50', 'text-slate-500');
				$label.classList.add('opacity-50', 'pointer-events-none');
				return;
			}

			/* =====================
			 * 닉네임 변경 감지
			 * ===================== */
			$nickname.addEventListener('input', () => {
				const now = ($nickname.value || '').trim();
				dirtyNickname = (now !== lastSavedNickname);
			});

			/* =====================
			 * 이미지 변경 → 즉시 서버 전송
			 * ===================== */
			$file.addEventListener('change', async (e) => {
				const f = e.target.files?.[0];
				if (!f || savingProfile) return;

				savingProfile = true;

				// 미리보기
				const previewUrl = URL.createObjectURL(f);
				$img.style.display = '';
				$img.src = previewUrl;
				document.getElementById('profileFallback')?.classList.add('hidden');

				try {
					showLoading?.();

					const resized = await resizeImageToBlob(f);
					const fd = new FormData();
					fd.append('uid', itemUid);
					fd.append('profile', resized, 'profile.jpg');

					const cp = window.contextPath || '';
					// const res = await fetch(cp + '/My/updateUser.json', {
					// 	method: 'POST',
					// 	body: fd,
					// 	credentials: 'include'
					// }).then(r => r.json());
					const res = await apiFormData(cp + '/My/updateUser.json', fd );
					if (res?.code !== '0') {
						await alertP(res?.message || '프로필 이미지 저장 실패');
						return;
					}

					// 성공 → input 초기화
					$file.value = '';
					showToast('안내', '프로필 이미지가 변경되었습니다.', ToastType.SUCCESS, 1200);

				} catch (e) {
					console.error(e);
					showToast('오류', '프로필 이미지 저장 중 오류가 발생했습니다.', ToastType.ERROR, 1800);
				} finally {
					hideLoading?.();
					savingProfile = false;
					URL.revokeObjectURL(previewUrl);
				}
			});

			/* =====================
			 * 페이지 이탈 시 닉네임만 저장
			 * ===================== */
			async function saveNicknameIfNeeded() {
				if (!dirtyNickname || savingNickname) return;

				const nickname = ($nickname.value || '').trim();
				if (!nickname) return;

				savingNickname = true;

				try {
					const fd = new FormData();
					fd.append('uid', itemUid);
					fd.append('nickname', nickname);

					const cp = window.contextPath || '';
					// const res = await fetch(cp + '/My/updateUser.json', {
					// 	method: 'POST',
					// 	body: fd,
					// 	credentials: 'include'
					// }).then(r => r.json());
					const res = await apiFormData(cp + '/My/updateUser.json', fd );

					if (res?.code === '0') {
						lastSavedNickname = nickname;
						dirtyNickname = false;
					}
				} catch (e) {
					console.warn('닉네임 자동 저장 실패', e);
					showToast('오류', '닉네임 자동 저장 중 오류가 발생했습니다.', ToastType.ERROR, 1800);
				} finally {
					savingNickname = false;
				}
			}

			/* =====================
			 * 닉네임 포커스 아웃 시 저장 ⭕
			 * ===================== */
			$nickname.addEventListener('blur', async () => {
				await saveNicknameIfNeeded();
			});

			$nickname.addEventListener('keydown', (e) => {
				if (e.key === 'Enter') {
					e.preventDefault();
					$nickname.blur(); // blur → 저장 트리거
				}
			});

			/* =====================
			 * 로그아웃 / 탈퇴 시에도 닉네임 저장 후 진행
			 * ===================== */
			async function leaveAfterNicknameSave(next) {
				await saveNicknameIfNeeded();
				next();
			}

			document.getElementById('btnLogout')?.addEventListener('click', async () => {
				await leaveAfterNicknameSave(async () => {
					const ok = await confirmP('로그아웃 하시겠습니까?');
					if (!ok) return;

					try {
						showLoading?.();
						const cp = window.contextPath || '';
						await apiPost(cp + '/My/Logout.json', {});
						window.location.href = cp + '/';
					} finally {
						hideLoading?.();
					}
				});
			});

			document.getElementById('btnWithdraw')?.addEventListener('click', async () => {
				await leaveAfterNicknameSave(async () => {
					await alertP('탈퇴 시 입력했던 정보는 모두 삭제되며 복구할 수 없습니다.');
					const email = await promptP('탈퇴 확인을 위해 이메일을 입력해 주세요.');
					if (!email) return;

					const cp = window.contextPath || '';
					window.location.href = cp + '/My/Withdraw/Google?email=' + encodeURIComponent(email);
				});
			});

			/* =====================
			 * 유틸: 이미지 리사이즈
			 * ===================== */
			async function resizeImageToBlob(file) {
				const img = new Image();
				img.src = URL.createObjectURL(file);
				await img.decode();

				const max = 512;
				const ratio = Math.min(max / img.width, max / img.height, 1);
				const w = Math.round(img.width * ratio);
				const h = Math.round(img.height * ratio);

				const canvas = document.createElement('canvas');
				canvas.width = w;
				canvas.height = h;
				canvas.getContext('2d').drawImage(img, 0, 0, w, h);

				const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.85));
				URL.revokeObjectURL(img.src);
				return blob;
			}

		})();

		(function () {
			const $togglePush = document.getElementById('togglePush');
			const $pushHint = document.getElementById('pushHint');
			if (!$togglePush) return;

			function setHint(msg) {
				if ($pushHint) $pushHint.textContent = msg || '';
			}
			function setBusy(busy) {
				if (busy) $togglePush.setAttribute('disabled', '');
				else $togglePush.removeAttribute('disabled');
			}

			async function init() {
				setBusy(true);
				try {
					if (!window.PWA_PUSH?.supported()) {
						$togglePush.checked = false;
						$togglePush.setAttribute('disabled', '');
						setHint('이 브라우저는 푸시를 지원하지 않습니다.');
						return;
					}

					// 1) 계정 설정(서버)
					const enabled = await PWA_PUSH.getUserPushStatus();

					// 2) 브라우저 권한/구독(클라이언트)
					const perm = window.PWA_PUSH.permission();
					const sub = await PWA_PUSH.getSubscription();
					const deviceSubscribed = !!sub;

					// 토글은 "계정 설정"을 그대로 표시
					$togglePush.checked = enabled;

					// 3) 상태 문구(불일치 표시)
					if (!enabled) {
						setHint(deviceSubscribed
							? '푸시 수신: OFF (이 브라우저는 구독이 남아있어 정리 중...)'
							: '푸시 수신: OFF');
						// 계정 OFF면 남은 구독 정리(선택)
						if (deviceSubscribed) PWA_PUSH.unsubscribeDevice().catch(console.warn);
						return;
					}

					// enabled == true
					if (perm !== 'granted') {
						setHint('푸시 수신: ON (이 브라우저 알림 권한이 꺼져있음)');
						return;
					}

					if (!deviceSubscribed) {
						setHint('푸시 수신: ON (이 브라우저는 아직 구독되지 않음: 구독 처리 중...)');
						// 자동 구독(선택) — 사용자 UX에 따라 버튼으로 유도해도 됨
						PWA_PUSH.subscribeDevice().catch(console.warn);
						return;
					}

					setHint('푸시 수신: ON (이 브라우저 구독 완료)');
				} catch (e) {
					console.error(e);
					setHint('푸시 상태 조회 실패');
					showToast('', '푸시 상태 조회에 실패했습니다.', ToastType.ERROR, 1500);
				} finally {
					setBusy(false);
				}
			}

			$togglePush.addEventListener('change', async (e) => {
				const next = !!e.detail?.checked;
				const prev = !next;

				setBusy(true);
				try {
					// 1) 서버(계정) 설정
					await PWA_PUSH.setUserPushStatus(next);

					// 2) 디바이스 구독/해제는 비동기
					if (next) {
						setHint('푸시 수신: ON (이 기기 구독 처리 중...)');
						PWA_PUSH.subscribeDevice().catch(err => console.warn(err));
					} else {
						setHint('푸시 수신: OFF (이 기기 구독 해제 중...)');
						PWA_PUSH.unsubscribeDevice().catch(err => console.warn(err));
					}

					showToast('', next ? '푸시 수신이 켜졌습니다.' : '푸시 수신이 꺼졌습니다.', ToastType.SUCCESS, 1200);

				} catch (err) {
					console.error(err);
					$togglePush.checked = prev;
					setHint('푸시 설정 변경 실패');
					showToast('', '푸시 설정 변경에 실패했습니다.', ToastType.ERROR, 1500);
				} finally {
					setBusy(false);
				}
			});

			window.addEventListener('load', init);
		})();

		(function () {
			const fontMap = ['xs', 'sm', 'md', 'lg', 'xl'];

			const range = document.getElementById('fontSizeRange');
			const labelsRoot = document.getElementById('fontSizeLabels');
			const labels = labelsRoot ? Array.from(labelsRoot.querySelectorAll('[data-index]')) : [];

			if (!range) return;

			// data-init 안전 처리: 공백 제거 + 소문자
			const rawInit = (range.dataset.init || 'md').trim().toLowerCase();
			const initIndex = fontMap.indexOf(rawInit);
			const safeIndex = initIndex >= 0 ? initIndex : 2; // md

			// body에 즉시 반영
			function applyFontByIndex(idx) {
				const size = fontMap[idx] || 'md';
				document.body.setAttribute('data-font-size', size);
			}

			// 라벨 강조 처리
			function updateLabels(idx) {
				labels.forEach(el => {
					const i = Number(el.dataset.index);
					const selected = (i === Number(idx));
					el.classList.toggle('font-semibold', selected);
					el.classList.toggle('text-slate-700', selected);
					el.classList.toggle('text-slate-500', !selected);
				});
			}

			// ✅ 최초: 서버값을 기본으로 세팅
			range.value = String(safeIndex);
			applyFontByIndex(safeIndex);
			updateLabels(safeIndex);

			// ✅ 드래그 중: 즉시 반영 + 라벨 강조 변경
			range.addEventListener('input', (e) => {
				const idx = Number(e.target.value);
				applyFontByIndex(idx);
				updateLabels(idx);
			});

			// ✅ 드래그 끝: 서버 저장
			range.addEventListener('change', async (e) => {
				const idx = Number(e.target.value);
				const size = fontMap[idx] || 'md';

				try {
					const fd = {
						uid: /*[[${item.user.uid}]]*/ null,
						fontSize: size
					};

					const cp = window.contextPath || '';
					const res = await apiPost(cp + '/My/updateUserFontSize.json', fd);

					if (!res || res.code !== "0") {
						showToast("오류", (res && res.message) ? res.message : "폰트 저장 실패", ToastType.ERROR);
						return;
					}
				} catch (err) {
					console.error(err);
					showToast('', '글자 크기 저장 실패', ToastType.ERROR, 1500);
				}
			});
		})();

	</script>


</th:block>

</html>