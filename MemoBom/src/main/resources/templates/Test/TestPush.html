<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{Common/LayoutBase}">

<th:block layout:fragment="title">push</th:block>
<head>
	<th:block layout:fragment="css">
		<!-- PWA -->
		<link rel="manifest" th:href="@{/manifest.webmanifest}" />
		<meta name="theme-color" content="#0f172a" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="default" />
		<meta name="apple-mobile-web-app-title" content="MemoBom" />
	</th:block>
</head>

<body>

	<!-- 헤더 -->
	<th:block layout:fragment="header">
		<div class="h-12 flex items-center justify-between px-3">
			<div class="font-bold text-slate-900">TestPush</div>
			<div class="text-xs text-slate-500">PWA / Push</div>
		</div>
	</th:block>

	<!-- 본문 -->
	<th:block layout:fragment="content">
		<div class="max-w-xl mx-auto space-y-3">
			<div class="bg-white rounded-xl border border-gray-200 p-4">
				<div class="font-semibold text-slate-900">PWA 설치/푸시 테스트</div>
				<div class="text-sm text-slate-600 mt-2 leading-relaxed">
					- 설치가 안 되어 있으면 진입 시 설치 안내 팝업이 뜹니다.<br/>
					- 거부하면 다시 뜨지 않습니다(브라우저 localStorage 기준).
				</div>
			</div>

			<div class="bg-white rounded-xl border border-gray-200 p-4 space-y-2">
				<div class="font-semibold text-slate-900">Push</div>

				<div class="flex gap-2">
					<button type="button"
							class="flex-1 px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800"
							onclick="enablePush()">
						푸시 알림 활성화
					</button>
					<button type="button"
							class="px-3 py-2 rounded-lg border border-gray-200 hover:bg-gray-50"
							onclick="localStorage.removeItem('pwa_install_dismissed_v1'); showToast('초기화', '설치 안내가 다시 노출됩니다.', ToastType.INFO, 1500)">
						설치 팝업 초기화
					</button>
				</div>

				<div class="text-xs text-slate-500">
					※ iOS는 beforeinstallprompt가 동작하지 않을 수 있어, 이 경우는 “홈 화면에 추가” 안내 UX로 별도 처리하는 게 일반적입니다.
				</div>
			</div>
		</div>
	</th:block>

	<!-- 푸터 -->
	<th:block layout:fragment="footer">
		<div class="h-10 flex items-center justify-center text-xs text-slate-500">
			MemoBom · TestPush
		</div>
	</th:block>

	<!-- 스크립트 -->
	<th:block layout:fragment="script">
		<script type="text/javascript" th:src="@{/js/pwa.js(v=${assetVersion})}"></script>

		<script th:inline="javascript">
			(function () {
				// ===== 설치 유도 1차 목표 =====
				const DISMISS_KEY = "pwa_install_dismissed_v1";
				let deferredPrompt = null;

				function isInstalled() {
					// Android/Chrome/Edge
					const standalone = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
					// iOS Safari
					const iosStandalone = (window.navigator && window.navigator.standalone) === true;
					return standalone || iosStandalone;
				}

				function alreadyDismissed() {
					return localStorage.getItem(DISMISS_KEY) === "1";
				}

				function dismissForever() {
					localStorage.setItem(DISMISS_KEY, "1");
				}

				// beforeinstallprompt: 크롬 계열에서 설치 배너를 우리가 제어
				window.addEventListener("beforeinstallprompt", (e) => {
					e.preventDefault();
					deferredPrompt = e;

					// 이미 설치됐거나, 사용자가 거부했던 이력이 있으면 더 이상 띄우지 않음
					if (isInstalled() || alreadyDismissed()) return;

					// 레이아웃/알림 시스템(AlertView) 사용: confirmP
					confirmP("앱을 설치하면 더 빠르게 이용할 수 있어요.\n지금 설치하시겠어요?")
						.then(async (ok) => {
							if (!ok) {
								dismissForever();
								showToast("안내", "설치 안내를 더 이상 표시하지 않습니다.", ToastType.INFO, 1500);
								return;
							}

							if (!deferredPrompt) return;

							deferredPrompt.prompt();
							const choice = await deferredPrompt.userChoice; // { outcome: 'accepted'|'dismissed', platform: ... }
							deferredPrompt = null;

							if (choice && choice.outcome === "dismissed") {
								dismissForever();
								showToast("안내", "설치를 취소하셨어요. 다시 표시하지 않습니다.", ToastType.INFO, 1500);
							} else {
								showToast("완료", "설치가 진행됩니다.", ToastType.SUCCESS, 1500);
							}
						})
						.catch((err) => console.error(err));
				});

				// 혹시 스탠드얼론으로 진입하면(설치됨) 안내 상태 정리
				window.addEventListener("appinstalled", () => {
					deferredPrompt = null;
					showToast("완료", "앱이 설치되었습니다.", ToastType.SUCCESS, 1500);
				});

				// 진입 시점에서 이미 설치된 상태면 아무것도 안 함
				document.addEventListener("DOMContentLoaded", () => {
					if (isInstalled()) return;
					// beforeinstallprompt가 발생하기 전엔 강제로 prompt를 띄울 수 없어서,
					// 여기서는 별도 안내를 띄우지 않습니다(요청하시면 iOS/desktop fallback 안내 UX도 넣어드릴게요).
				});
			})();
		</script>
	</th:block>

</body>
</html>
