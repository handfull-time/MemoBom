<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{Common/LayoutBase}">

<th:block layout:fragment="title">Memo</th:block>

<th:block layout:fragment="header">
	<th:block th:replace="~{Fragments/Header :: Header_Search('ðŸ”™', 'Fragment', 'âœï¸')}"></th:block>
</th:block>

<th:block layout:fragment="content">

	<!-- ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
	<div id="fragmentList" class="space-y-3 pb-6"></div>

	<!-- ë¡œë”©/ë ìƒíƒœ -->
	<div id="listState" class="hidden mx-2 mt-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-500"></div>

	<!-- ì¹´ë“œ í…œí”Œë¦¿ -->
	<template id="tplFragmentCard">
		<div class="mx-2 rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">

			<!-- top meta row -->
			<div class="flex items-center gap-2 px-3 py-2 border-b border-slate-100">
				<!-- topic pill -->
				<div class="topicPill inline-flex items-center gap-1.5 rounded-full px-2 py-1 text-xs font-semibold"
					 style="background:#eef2ff;">
					<span class="topicEmoji">ðŸ§©</span>
					<span class="topicName">Topic</span>
				</div>

				<!-- center user -->
				<div class="flex-1 min-w-0 flex items-center justify-center gap-2">
					<img class="userImg w-6 h-6 rounded-full border border-slate-200 object-cover" alt="user" />
					<div class="userName text-xs font-medium text-slate-700 truncate">User</div>
				</div>

				<!-- right date -->
				<div class="regDate text-[11px] text-slate-400 whitespace-nowrap">2026-01-24 11:22</div>
			</div>

			<!-- content -->
			<div class="px-3 py-2.5">
				<div class="content text-sm text-slate-800 leading-relaxed whitespace-pre-wrap break-words">
					content...
				</div>

				<!-- hashtags (ì„ íƒ) -->
				<div class="hashtagWrap mt-2 flex flex-wrap gap-1.5"></div>

				<!-- bottom actions -->
				<div class="mt-3 flex items-center justify-between gap-2">

					<!-- left: scrap + comment placeholder -->
					<div class="flex items-center gap-2">
						<button type="button" class="btnScrap inline-flex items-center gap-1 rounded-lg px-2 py-1 text-xs
													border border-slate-200 bg-slate-50 hover:bg-slate-100">
							<span class="scrapIcon"></span>
							<span class="scrapText"></span>
						</button>

						<!-- ëŒ“ê¸€ ì˜ì—­ placeholder (ì¶”í›„ lazy comments) -->
						<div class="commentPlaceholder text-xs text-slate-400">
							ðŸ’¬ ëŒ“ê¸€(ì¤€ë¹„ì¤‘)
						</div>
					</div>

					<!-- emotions -->
					<div class="emotionRow flex items-center gap-1.5"></div>
				</div>
			</div>

			<!-- comments area placeholder block (ê³µê°„ë§Œ) -->
			<div class="commentArea hidden px-3 pb-3">
				<!-- TODO: /Fragment/Comments.json?uid={topicUid}&pageNo=1 -->
			</div>
		</div>
	</template>

</th:block>

<th:block layout:fragment="footer">
	<th:block th:replace="~{Fragments/Footer :: BasicFooter}"></th:block>
</th:block>

<th:block layout:fragment="script">

	<script th:inline="javascript">
		// ì„œë²„ì—ì„œ ë‚´ë ¤ì˜¤ëŠ” ì¡°ê±´(ìžˆìœ¼ë©´ ì‚¬ìš©)
		const user = /*[[${user}]]*/ {};
		const topic = /*[[${topic}]]*/ {};
		const keyword = /*[[${keyword}]]*/ null;

		// ë¬´í•œ ìŠ¤í¬ë¡¤ ìƒíƒœ
		let pageNo = 1;
		let loading = false;
		let ended = false;

		const elList = document.getElementById('fragmentList');
		const elState = document.getElementById('listState');
		const tpl = document.getElementById('tplFragmentCard');

		// LayoutBaseì˜ mainì´ ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆìž„
		const scrollHost = document.querySelector('main');

		// emotion í‘œì‹œìš©(í”„ë¡ íŠ¸ ë§¤í•‘)
		const EMOTION_META = {
			JOY: { emoji: "ðŸ˜Š", label: "ê¸°ì¨" },
			NORMAL: { emoji: "ðŸ˜", label: "ë³´í†µ" },
			SADNESS: { emoji: "ðŸ˜¢", label: "ìŠ¬í””" },
			ANGER: { emoji: "ðŸ˜ ", label: "í™”ë‚¨" },
			AWESOME: { emoji: "ðŸ¤©", label: "ìµœê³ " },

			LIKE: { emoji: "ðŸ‘", label: "ì¢‹ì•„ìš”" },
			EMPATHY: { emoji: "â¤ï¸", label: "ê³µê°" },
			FUNNY: { emoji: "ðŸ˜‚", label: "ì›ƒê¹€" },
			SURPRISE: { emoji: "ðŸ˜®", label: "ë†€ëžŒ" },
		};

		function showState(text) {
			if (!elState) return;
			elState.textContent = text;
			elState.classList.remove('hidden');
		}
		function hideState() {
			if (!elState) return;
			elState.classList.add('hidden');
			elState.textContent = '';
		}

		function safeText(v, fallback = '') {
			if (v === null || v === undefined) return fallback;
			const s = String(v);
			return s;
		}

		function buildHashtags(elWrap, hashtags) {
			elWrap.innerHTML = '';
			if (!Array.isArray(hashtags) || hashtags.length === 0) return;

			hashtags.forEach(tag => {
				const chip = document.createElement('span');
				chip.className = "text-[11px] text-slate-600 bg-slate-100 border border-slate-200 rounded-full px-2 py-0.5";
				chip.textContent = `#${tag}`;
				elWrap.appendChild(chip);
			});
		}

		function buildEmotions(elRow, emotionList) {
			elRow.innerHTML = '';
			if (!Array.isArray(emotionList) || emotionList.length === 0) return;

			emotionList.forEach(e => {
				const code = e?.emotion;
				const meta = EMOTION_META[code] || { emoji: "â“", label: code || "UNKNOWN" };

				const btn = document.createElement('button');
				btn.type = "button";
				btn.className =
					"inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white " +
					"px-2 py-1 text-[11px] text-slate-700 hover:bg-slate-50";

				const emoji = document.createElement('span');
				emoji.textContent = meta.emoji;

				const cnt = document.createElement('span');
				cnt.className = "text-slate-500";
				cnt.textContent = String(e?.count ?? 0);

				btn.appendChild(emoji);
				btn.appendChild(cnt);

				// TODO: í´ë¦­ ì‹œ emotion ì²˜ë¦¬ (ì¶”í›„)
				btn.addEventListener('click', (ev) => {
					ev.stopPropagation();
					// showToast(meta.label, "ì´ëª¨ì…˜ ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ìž…ë‹ˆë‹¤.", ToastType.INFO, 1500);
				});

				elRow.appendChild(btn);
			});
		}

		function makeCard(item) {
			const node = tpl.content.firstElementChild.cloneNode(true);

			// topic
			const topicPill = node.querySelector('.topicPill');
			const topicEmoji = node.querySelector('.topicEmoji');
			const topicName = node.querySelector('.topicName');

			const t = item?.topic || {};
			const tColor = safeText(t.color, '#eef2ff');

			// ë°°ê²½ìƒ‰(í† í”½ ì»¬ëŸ¬)
			topicPill.style.background = tColor;

			topicEmoji.textContent = safeText(t.imogi, 'ðŸ§©');
			topicName.textContent = safeText(t.name, 'Topic');

			// user
			const u = item?.user || {};
			const userImg = node.querySelector('.userImg');
			const userName = node.querySelector('.userName');

			userName.textContent = safeText(u.nickname, 'Unknown');

			const purl = safeText(u.profileUrl, '');
			if (purl) userImg.src = purl;
			else userImg.classList.add('hidden');

			// date
			node.querySelector('.regDate').textContent = safeText(item?.regDate, '');

			// content
			node.querySelector('.content').textContent = safeText(item?.content, '');

			// hashtags
			buildHashtags(node.querySelector('.hashtagWrap'), item?.hashtagList);

			// scrap
			const btnScrap = node.querySelector('.btnScrap');
			const scrapIcon = node.querySelector('.scrapIcon');
			const scrapText = node.querySelector('.scrapText');

			let isScrap = !!item?.scrap;
			function syncScrapUI() {
				if (isScrap) {
					btnScrap.classList.remove('bg-slate-50');
					btnScrap.classList.add('bg-amber-50', 'border-amber-200');
					scrapIcon.textContent = 'ðŸ“Œ';
					//scrapText.textContent = 'ìŠ¤í¬ëž©ë¨';
				} else {
					btnScrap.classList.remove('bg-amber-50', 'border-amber-200');
					btnScrap.classList.add('bg-slate-50');
					scrapIcon.textContent = 'ðŸ“Œ';
					//scrapText.textContent = 'ìŠ¤í¬ëž©';
				}
			}
			syncScrapUI();

			btnScrap.addEventListener('click', (ev) => {
				ev.stopPropagation();
				// TODO: /Fragment/Scrap.json ê°™ì€ APIê°€ ë¶™ìœ¼ë©´ ì²˜ë¦¬
				// ìž„ì‹œ í† ê¸€(í…ŒìŠ¤íŠ¸ìš©)
				isScrap = !isScrap;
				syncScrapUI();
			});

			// emotions
			buildEmotions(node.querySelector('.emotionRow'), item?.emotionList);

			// ì¹´ë“œ í´ë¦­(ì›í•˜ë©´ ìƒì„¸ë¡œ)
			node.addEventListener('click', () => {
				// TODO: ìƒì„¸ í™”ë©´ì´ ìžˆìœ¼ë©´ ì´ë™
				// location.href = `/Fragment/Item.html?uid=${encodeURIComponent(item.uid)}`;
			});

			return node;
		}

		async function loadNextPage() {
			if (loading || ended) return;

			loading = true;
			hideState();

			const sendObj = {
				userUid: user?.userUid,
				topicUid: topic?.topicUid,
				keyword: keyword || '',
				hashTag: '',
				pageNo: pageNo
			};

			try {
				const url = /*[[@{/Fragment/Fragments.json}]]*/ '/Fragment/Fragments.json';
				const res = await apiGetWithParam(url, sendObj);

				if (!res || res.code !== "0") {
					showState(res?.message || "ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
					return;
				}

				const list = Array.isArray(res.data) ? res.data : [];

				// âœ… ë§ˆì§€ë§‰ íŽ˜ì´ì§€: dataê°€ null ë˜ëŠ” []
				if (!list || list.length === 0) {
					ended = true;
					showState("ë§ˆì§€ë§‰ìž…ë‹ˆë‹¤.");
					return;
				}

				list.forEach(item => elList.appendChild(makeCard(item)));
				pageNo += 1;

			} catch (e) {
				showState("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
			} finally {
				loading = false;
			}
		}

		function onScroll() {
			if (!scrollHost) return;

			// ì•„ëž˜ë¡œ(ì†ê°€ë½ì„ ìœ„ë¡œ) ìŠ¤í¬ë¡¤í–ˆì„ ë•Œ, ë°”ë‹¥ ê·¼ì²˜ë©´ ë‹¤ìŒ íŽ˜ì´ì§€ ë¡œë“œ
			const nearBottom = scrollHost.scrollTop + scrollHost.clientHeight >= scrollHost.scrollHeight - 180;
			if (nearBottom) loadNextPage();
		}

		async function init() {
			await loadNextPage(); // 1page
			scrollHost?.addEventListener('scroll', onScroll, { passive: true });
		}

		window.addEventListener("DOMContentLoaded", init);

		function functionLeft() { history.back(); }
		function functionRight() {
			location.href = /*[[@{/Fragment/Tessera.html}]]*/ '/Fragment/Tessera.html';
		}
	</script>
</th:block>

</html>
