<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{Common/LayoutBase}">

<th:block layout:fragment="title">ì‘ì€ ì¡°ê°</th:block>

<th:block layout:fragment="header">
	<th:block th:replace="~{Fragments/Header :: Header_Back('ì‘ì€ ì¡°ê°')}"></th:block><!--í¸ë¦°-->
</th:block>

<th:block layout:fragment="content">

	<!-- Topic Select Modal (compact) -->
	<div id="topicSelectModal" th:if="${topics != null and #lists.size(topics) > 1}"
		class="fixed inset-0 z-50 flex items-end justify-center bg-black/40 p-3">

		<div class="w-full max-w-sm rounded-2xl bg-white shadow-2xl">
			<!-- í—¤ë” -->
			<div class="px-4 pt-4 pb-3 border-b border-slate-100">
				<div class="text-dynamic-base font-extrabold text-slate-800">í† í”½ ì„ íƒ</div>
				<div class="text-dynamic-xs text-slate-500 mt-1">ì£¼ì œë¥¼ ì„ íƒí•˜ë©´ ë°”ë¡œ ì‘ì„±í•  ìˆ˜ ìˆì–´ìš”.</div>

				<!-- ê²€ìƒ‰ -->
				<div class="mt-3">
					<input id="topicSearch" type="text" placeholder="í† í”½ ê²€ìƒ‰..." class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-dynamic-sm
                      outline-none focus:ring-2 focus:ring-slate-300/40" />
				</div>
			</div>

			<!-- ë¦¬ìŠ¤íŠ¸: ë§ì„ ë•Œ ëŒ€ë¹„ ìŠ¤í¬ë¡¤ -->
			<div id="modalTopicList" class="max-h-[46vh] overflow-y-auto px-2 py-2">
				<button type="button" th:each="t : ${topics}" class="topic-row w-full flex items-center gap-2 rounded-xl px-3 py-2
                     hover:bg-slate-50 transition text-left" th:attr="data-uid=${t.uid},
                       data-maxlen=${t.maxLen},
                       data-color=${t.color},
                       data-name=${t.name}">
					<span class="text-dynamic-lg w-6 text-center" th:text="${t.imogi}">ğŸ§©</span>
					<span class="flex-1 text-dynamic-sm font-semibold text-slate-800 truncate" th:text="${t.name}">Topic</span>

					<span class="h-3 w-3 rounded-full border border-black/10 shrink-0"
						th:style="'background:' + ${t.color}"></span>
				</button>

				<!-- ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ -->
				<div id="topicEmpty" class="hidden px-4 py-6 text-center text-dynamic-sm text-slate-400">
					ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
				</div>
			</div>
		</div>
	</div>

	<!-- wrapper: í™”ë©´ ë†’ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê°•ì œë¡œ ì¡ìŒ -->
	<div class="flex flex-col min-h-[320px] h-[calc(100dvh-120px)] h-[calc(100vh-120px)]">

		<!-- Image Preview (centered, optional) -->
		<div id="imgWrap" class="hidden px-3 pt-3">
			<div class="relative mx-auto w-fit max-w-full">
				<img id="imgPreview" alt="preview" class="max-w-full rounded-xl shadow-sm" />
				<button id="btnImgRemove" type="button"
					class="absolute -top-2 -right-2 w-8 h-8 rounded-full bg-black/55 text-white flex items-center justify-center"
					aria-label="ì´ë¯¸ì§€ ì œê±°">âœ•</button>
			</div>
		</div>

		<!-- hidden file input -->
		<input id="imgFile" type="file" accept="image/*" class="hidden" />

		<!-- ë³¸ë¬¸: ë‚¨ì€ ê³µê°„ ì „ë¶€ ì°¨ì§€ -->
		<textarea id="content" name="content" 
			placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”." 
			th:disabled="${item == null}"
		    th:text="${item == null ? '' : item.content}"
			style="font-size: var(--font-base); line-height: 1.6;"
			class="flex-1 min-h-0 w-full border-0 outline-none resize-none p-3 text-dynamic-15 box-border bg-transparent"></textarea>

		<!-- í•´ì‹œíƒœê·¸: í•­ìƒ ë§¨ ì•„ë˜(ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ ê³ ì • ëŠë‚Œ) -->
		<div class="sticky bottom-0 border-t border-slate-200 px-3 pt-2 pb-2.5 bg-white">

			<!-- content ê¸¸ì´ progress (thin) -->
			<div class="mb-2">
				<div class="h-[3px] w-full rounded-full bg-slate-200/70 overflow-hidden">
					<div id="contentProgress" class="h-full rounded-full" style="width:0%; background:#3b82f6;">
					</div>
				</div>
				<div class="mt-1 flex items-center justify-between text-dynamic-sm text-slate-400">
					<span id="contentCounter">0 / 0</span>
					<span id="contentHint" class="hidden text-rose-500 font-semibold">ìµœëŒ€ ê¸¸ì´ì— ê°€ê¹Œì›Œìš”</span>
				</div>
			</div>

			<input type="text" id="hashtags" name="hashtags" placeholder="#í•´ì‹œíƒœê·¸ (ì„ íƒ)"
				th:value="${item == null ? '' : #strings.listJoin(item.hashtagList, ' ')}"
				class="w-full border-0 outline-none text-dynamic-sm text-slate-600 bg-transparent" />

			<div class="mt-1 text-dynamic-xs text-slate-400">
				ì‰¼í‘œ(,) ë˜ëŠ” ë„ì–´ì“°ê¸°ë¡œ ì—¬ëŸ¬ ê°œ ì…ë ¥í•  ìˆ˜ ìˆì–´ìš”.
			</div>
		</div>

	</div>

</th:block>




<th:block layout:fragment="footer">
	<th:block 
	    th:replace="${item == null} 
	        ? ~{Fragments/Footer :: FooterWrite} 
	        : ~{Fragments/Footer :: FooterModify}">
	</th:block>
</th:block>

<th:block layout:fragment="script">

	<script th:inline="javascript">
		
		function lerp(a, b, t) {return a + (b - a) * t;}
		function clamp01(x) {return Math.max(0, Math.min(1, x));}

		// íŒŒë‘(#3b82f6) -> ë¹¨ê°•(#ef4444)ë¡œ ë‹¨ìƒ‰ ë³€í™”
		function ratioToColor(ratio) {
			ratio = clamp01(ratio);

			// hex -> rgb
			const blue = {r: 0x3b, g: 0x82, b: 0xf6}; // 59,130,246
			const red = {r: 0xef, g: 0x44, b: 0x44}; // 239,68,68

			const r = Math.round(lerp(blue.r, red.r, ratio));
			const g = Math.round(lerp(blue.g, red.g, ratio));
			const b = Math.round(lerp(blue.b, red.b, ratio));

			return `rgb(${r}, ${g}, ${b})`;
		}

		function updateContentProgress() {
			const ta = document.getElementById("content");
			const bar = document.getElementById("contentProgress");
			const counter = document.getElementById("contentCounter");
			const hint = document.getElementById("contentHint");

			if (!ta || !bar || !counter) return;

			const maxLenAttr = ta.getAttribute("maxlength");
			const maxLen = maxLenAttr ? Number(maxLenAttr) : 0;

			const len = (ta.value || "").length;

			if (!maxLen || maxLen <= 0) {
				bar.style.width = "0%";
				bar.style.background = "#3b82f6"; // ê¸°ë³¸ íŒŒë‘
				counter.textContent = `${len} / âˆ`;
				hint?.classList.add("hidden");
				return;
			}

			const ratio = Math.min(1, len / maxLen);
			const pct = ratio * 100;

			bar.style.width = pct.toFixed(1) + "%";
			bar.style.background = ratioToColor(ratio); // âœ… ì—¬ê¸°ì„œ ë‹¨ìƒ‰ ë³€í™”
			counter.textContent = `${len} / ${maxLen}`;

			if (hint) hint.classList.toggle("hidden", ratio < 0.9);
		}

		document.addEventListener("DOMContentLoaded", () => {
			const ta = document.getElementById("content");
			if (!ta) return;

			const topic = /*[[${item != null ? item.topic:null}]]*/ null;
			
			if (topic) {
			    applyTopicToEditor(topic);
			}

			// ì…ë ¥í•  ë•Œë§ˆë‹¤ ì—…ë°ì´íŠ¸
			ta.addEventListener("input", updateContentProgress, {passive: true});

			// ì´ˆê¸° 1íšŒ
			updateContentProgress();
			
		});
	</script>


	<script th:inline="javascript">
		const topics = /*[[${topics}]]*/[];
		
		let selectedTopicUid = null;
		let __imgBlob = null;
		let __thumbBlob = null;
		let __imgObjectUrl = null;
		let __imgMeta = { width: 0, height: 0, name: '' };
		const __initialImageUrl = /*[[${itemImageUrl}]]*/ null;

		function __revokePreviewUrl() {
			if (__imgObjectUrl) {
				URL.revokeObjectURL(__imgObjectUrl);
				__imgObjectUrl = null;
			}
		}

		function __clearSelectedImage() {
			__revokePreviewUrl();
			__imgBlob = null;
			__thumbBlob = null;
			__imgMeta = { width: 0, height: 0, name: '' };
			const wrap = document.getElementById('imgWrap');
			const img = document.getElementById('imgPreview');
			if (img) img.removeAttribute('src');
			wrap?.classList.add('hidden');
			const input = document.getElementById('imgFile');
			if (input) input.value = '';
		}

		function __loadImageFromFile(file) {
			return new Promise((resolve, reject) => {
				const url = URL.createObjectURL(file);
				const img = new Image();
				img.onload = () => {
					URL.revokeObjectURL(url);
					resolve(img);
				};
				img.onerror = (e) => {
					URL.revokeObjectURL(url);
					reject(e);
				};
				img.src = url;
			});
		}

		function __drawToCanvas(img, targetW) {
			const srcW = img.naturalWidth || img.width;
			const srcH = img.naturalHeight || img.height;
			const w = Math.max(1, Math.min(targetW, srcW)); // no upscale
			const h = Math.max(1, Math.round((srcH * w) / srcW));
			const canvas = document.createElement('canvas');
			canvas.width = w;
			canvas.height = h;
			const ctx = canvas.getContext('2d', { alpha: false });
			ctx.drawImage(img, 0, 0, w, h);
			return canvas;
		}

		function __canvasToWebpBlob(canvas, quality = 0.86) {
			return new Promise((resolve, reject) => {
				canvas.toBlob((blob) => {
					if (!blob) {
						reject(new Error('webp ë³€í™˜ ì‹¤íŒ¨'));
						return;
					}
					resolve(blob);
				}, 'image/webp', quality);
			});
		}

		async function __resizeThumbToWebp(file, maxWidth) {
			const img = await __loadImageFromFile(file);
			const canvas = __drawToCanvas(img, maxWidth);
			return __canvasToWebpBlob(canvas);
		}

		async function __resizeToWebp(file, maxWidth) {
			const img = await __loadImageFromFile(file);
			const srcW = img.naturalWidth || img.width;
			const srcH = img.naturalHeight || img.height;
			const ratio = (srcW > maxWidth) ? (maxWidth / srcW) : 1;
			const targetW = Math.max(1, Math.round(srcW * ratio));
			const targetH = Math.max(1, Math.round(srcH * ratio));
			const canvas = __drawToCanvas(img, targetW, targetH);
			const blob = await __canvasToWebpBlob(canvas);
			return { blob, width: targetW, height: targetH };
		}


		async function __onSelectImageFile(file) {
			if (!file) return;
			// 1ê°œë§Œ í—ˆìš©. ìƒˆë¡œ ì„ íƒí•˜ë©´ ê¸°ì¡´ êµì²´
			__clearSelectedImage();

			const resized = await __resizeToWebp(file, 1440);
			const thumbBlob = await __resizeThumbToWebp(file, 64);
			__imgBlob = resized.blob;
			__thumbBlob = thumbBlob;
			__imgMeta = { width: resized.width, height: resized.height, name: file.name || '' };

			// preview
			__imgObjectUrl = URL.createObjectURL(__imgBlob);
			const imgEl = document.getElementById('imgPreview');
			const wrap = document.getElementById('imgWrap');
			if (imgEl) imgEl.src = __imgObjectUrl;
			wrap?.classList.remove('hidden');
		}
		
		function __bindExistingImagePreview() {
			if (!__initialImageUrl) return;
			
			const imgEl = document.getElementById('imgPreview');
			const wrap = document.getElementById('imgWrap');
			if (imgEl) imgEl.src = window.contextPath + __initialImageUrl;
			wrap?.classList.remove('hidden');
		}

		async function submitFragment(url, payload) {
			// BoardReqDto: MultipartFile(image/thumb) + ê¸°íƒ€ í•„ë“œ. (í•­ìƒ FormDataë¡œ ì „ì†¡)
			const fd = new FormData();
			Object.entries(payload || {}).forEach(([k, v]) => {
				if (v === undefined || v === null) return;
				fd.append(k, v);
			});
			if (__imgBlob) {
				fd.append('image', __imgBlob, 'image.webp');
				fd.append('imageWidth', String(__imgMeta.width || 0));
				fd.append('imageHeight', String(__imgMeta.height || 0));
				fd.append('imageName', __imgMeta.name || webpName);
			}
			if (__thumbBlob) fd.append('thumb', __thumbBlob, 'thumb.webp');
			return apiFormData(url, fd);
		}

		function applyTopicToEditor(topic) {
			const ta = document.getElementById("content");
			selectedTopicUid = topic.uid;

			const header = document.getElementById("headerTitle");
			if (header && topic.name) {
				header.textContent = topic.name + " Â· ì‘ì€ ì¡°ê°";
			}

			const maxLen = Number(topic.maxLen || 0);
			if (maxLen > 0) ta.setAttribute("maxlength", String(maxLen));
			else ta.removeAttribute("maxlength");

			ta.removeAttribute("disabled");
			ta.focus();

			const modal = document.getElementById("topicSelectModal");
			if (modal) modal.remove();
		}

		function initTopicModalCompact() {
			// 1ê°œë©´ ìë™
			if (!Array.isArray(topics) || topics.length <= 1) {
				if (topics?.length === 1) applyTopicToEditor(topics[0]);
				return;
			}

			// í´ë¦­ ì„ íƒ
			document.querySelectorAll("#modalTopicList .topic-row").forEach(btn => {
				btn.addEventListener("click", () => {
					applyTopicToEditor({
						uid: btn.dataset.uid,
						maxLen: Number(btn.dataset.maxlen || 0),
						color: btn.dataset.color,
						name: btn.dataset.name
					});
				});
			});

			// ê²€ìƒ‰
			const input = document.getElementById("topicSearch");
			const empty = document.getElementById("topicEmpty");
			const rows = Array.from(document.querySelectorAll("#modalTopicList .topic-row"));

			const applyFilter = () => {
				const q = (input.value || "").trim().toLowerCase();
				let visible = 0;

				rows.forEach(r => {
					const name = (r.dataset.name || "").toLowerCase();
					const ok = !q || name.includes(q);
					r.classList.toggle("hidden", !ok);
					if (ok) visible++;
				});

				if (empty) empty.classList.toggle("hidden", visible !== 0);
			};

			input?.addEventListener("input", applyFilter, {passive: true});
			// ì§„ì… ì‹œ ë°”ë¡œ í¬ì»¤ìŠ¤
			input?.focus();
		}

		document.addEventListener("DOMContentLoaded", initTopicModalCompact);

		document.addEventListener("DOMContentLoaded", () => {
			
			__bindExistingImagePreview();
			
			// footer select img
			const btn = document.getElementById('btnSelectImg');
			const input = document.getElementById('imgFile');
			btn?.addEventListener('click', () => input?.click());

			input?.addEventListener('change', async (e) => {
				const file = e.target?.files?.[0];
				try {
					await __onSelectImageFile(file);
				} catch (err) {
					console.error(err);
					showToast('ì—ëŸ¬', err?.message || 'ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹¤íŒ¨', ToastType.ERROR, 1800);
					__clearSelectedImage();
				}
			});

			document.getElementById('btnImgRemove')?.addEventListener('click', __clearSelectedImage);
		});

		async function onClickWrite() {
			if (Array.isArray(topics) && topics.length > 1 && !selectedTopicUid) {
				await alertP("Mosaicì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
				return;
			}

			const content = document.getElementById('content').value.trim();
			if (!content || content.length === 0) {
				await alertP('ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
				return;
			}

			const hashtagRaw = (document.getElementById('hashtags')?.value || '').trim();

			const sendObj = {
				seal: /*[[${seal}]]*/ null,
				topicUid: selectedTopicUid,
				content: content,
				hashTag: hashtagRaw
			}

			try {
				const url = /*[[@{/Fragment/Save.json}]]*/ '/Fragment/Save.json';

				const data = await submitFragment(url, sendObj);

				if (!data) {
					showToast("ì—ëŸ¬", "ì €ì¥ì¤‘ ì˜¤ë¥˜ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", ToastType.ERROR, 1800);
					return;
				}

				if (data.code === "0") {
					await alertP("ì‘ì€ ì¡°ê°ì´ ì¶”ê°€ëìŠµë‹ˆë‹¤.");
					window.__disableDirtyGuard__?.();
					location.replace(/*[[@{/Fragment/index.html}]]*/ '/Fragment/index.html');
				} else {
					console.info(data);
					showToast("ì˜¤ë¥˜", data.message, ToastType.WARNING, 1800);
				}
			} catch (e) {
				console.error(e);
				showToast("ì—ëŸ¬", e.message, ToastType.ERROR, 1800);
			} finally {
				// btnSaveê°€ ì—†ëŠ” í™”ë©´ë„ ìˆì„ ìˆ˜ ìˆì–´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
				if (typeof btnSave !== 'undefined' && btnSave) btnSave.disabled = false;
			}
		}
		
		async function onClickUpdate(isDelete) {

			const actionName = isDelete? 'ì‚­ì œ':'ìˆ˜ì •';

			const ok = await confirmP(actionName + 'í• ê¹Œìš”?');
			if (!ok) return;
			
			const content = document.getElementById('content').value.trim();
			if (!content || content.length === 0) {
				await alertP('ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
				return;
			}

			const hashtagRaw = (document.getElementById('hashtags')?.value || '').trim();

			const sendObj = {
				seal: /*[[${seal}]]*/ null,
				uid: /*[[${item != null ? item.uid : null}]]*/ null,
				topicUid: selectedTopicUid,
				content: content,
				hashTag: hashtagRaw,
				deleted: isDelete
			}
			
			try {
				const url = /*[[@{/Fragment/Save.json}]]*/ '/Fragment/Save.json';

				const data = await submitFragment(url, sendObj);

				if (!data) {
					showToast("ì—ëŸ¬", actionName + "ì¤‘ ì˜¤ë¥˜ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", ToastType.ERROR, 1800);
					return;
				}

				if (data.code === "0") {
					await alertP("ì‘ì€ ì¡°ê°ì´ "+actionName+"ëìŠµë‹ˆë‹¤.");
					window.__disableDirtyGuard__?.();
					location.replace(/*[[@{/Fragment/index.html}]]*/ '/Fragment/index.html');
				} else {
					console.info(data);
					showToast("ì˜¤ë¥˜", data.message, ToastType.WARNING, 1800);
				}
			} catch (e) {
				console.error(e);
				showToast("ì—ëŸ¬", e.message, ToastType.ERROR, 1800);
			} finally {
				// btnSaveê°€ ì—†ëŠ” í™”ë©´ë„ ìˆì„ ìˆ˜ ìˆì–´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
				if (typeof btnSave !== 'undefined' && btnSave) btnSave.disabled = false;
			}
		}

		(function () {
			const ta = document.getElementById('content');
			if (!ta) return;

			const initialValue = ta.value || '';
			let isDirty = false;

			// í”„ë¡œê·¸ë¨ì ìœ¼ë¡œ ë‚˜ê°ˆ ë•Œ ì‚¬ìš©
			let allowLeave = false;

			// guard íˆìŠ¤í† ë¦¬ 1ì¹¸(ë”± 1íšŒ)
			let guardPushed = false;

			// ë‚´ë¶€ì ìœ¼ë¡œ guardë¥¼ ë˜ëŒë¦´ ë•Œ popstateê°€ 1ë²ˆ ë°œìƒí•˜ë¯€ë¡œ ë¬´ì‹œ í”Œë˜ê·¸
			let suppressNextPop = false;

			function ensureGuardHistoryOnce() {
				if (guardPushed) return;
				history.pushState({__dirty_guard__: true}, '', location.href);
				guardPushed = true;
			}

			function popGuardIfExists() {
				if (!guardPushed) return;
				// pushStateë¡œ ì¶”ê°€í•œ 1ì¹¸ë§Œ ì œê±°(ë’¤ë¡œ 1ë²ˆ). ê°™ì€ URLì˜ ì´ì „ stateë¡œ ëŒì•„ê°€ë¯€ë¡œ í˜ì´ì§€ ì´íƒˆ ì•„ë‹˜.
				suppressNextPop = true;
				history.back();
				guardPushed = false;
			}

			// beforeunload í•¸ë“¤ëŸ¬ëŠ” ë³€ìˆ˜ë¡œ ì¡ì•„ë‘¬ì„œ, ì €ì¥ ì„±ê³µ ì‹œ ì œê±° ê°€ëŠ¥í•˜ê²Œ
			function onBeforeUnload(e) {
				if (!isDirty) return;
				e.preventDefault();
				e.returnValue = '';
			}
			window.addEventListener('beforeunload', onBeforeUnload);

			ta.addEventListener('input', () => {
				const nextDirty = (ta.value !== initialValue);

				// dirty -> true ë¡œ ë°”ë€ŒëŠ” ìˆœê°„ì—ë§Œ guard ì¶”ê°€
				if (!isDirty && nextDirty) ensureGuardHistoryOnce();

				// dirty -> false ë¡œ ëŒì•„ì˜¤ë©´ guard ì œê±° (ë’¤ë¡œê°€ê¸°ê°€ 2ë²ˆ í•„ìš”í–ˆë˜ ë¬¸ì œ í•´ê²°)
				if (isDirty && !nextDirty) popGuardIfExists();

				isDirty = nextDirty;
			});

			window.addEventListener('popstate', async () => {
				// ìš°ë¦¬ê°€ guard ì œê±°í•˜ë ¤ê³  history.back() í–ˆì„ ë•Œ ë°œìƒí•œ popstateëŠ” ë¬´ì‹œ
				if (suppressNextPop) {
					suppressNextPop = false;
					return;
				}

				// í”„ë¡œê·¸ë¨ ì´ë™ ì¤‘ì´ë©´ ê°€ë¡œì±„ì§€ ì•ŠìŒ (â€» ì—¬ê¸°ì„œ history.back() ì¶”ê°€ í˜¸ì¶œí•˜ë©´ 2ë²ˆ í•„ìš” í˜„ìƒ ìƒê¹€)
				if (allowLeave) return;

				// ë”í‹°ê°€ ì•„ë‹ˆë©´ ê·¸ëƒ¥ ë‚˜ê°€ê²Œ ë‘ 
				if (!isDirty) return;

				// ì‚¬ìš©ìê°€ ë’¤ë¡œê°€ê¸°ë¥¼ ëˆŒë €ìœ¼ë‹ˆ, ë‹¤ì‹œ í˜„ì¬ë¡œ ë¶™ì¡ì•„ë‘ê³  í™•ì¸
				history.pushState({__dirty_guard__: true}, '', location.href);
				guardPushed = true;

				const ok = await confirmP('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆì–´ìš”.\nì •ë§ ë‚˜ê°€ì‹œê² ì–´ìš”?');

				if (ok) {
					allowLeave = true;
					isDirty = false;
					window.removeEventListener('beforeunload', onBeforeUnload);
					history.back(); // ì´ì œ 1ë²ˆì´ë©´ ë‚˜ê°
				}
				// ì·¨ì†Œë©´ í˜„ì¬ ìœ ì§€ (ì´ë¯¸ pushStateë¡œ ë˜ëŒë¦¼)
			});

			// âœ… ì €ì¥ ì„±ê³µ í›„ ì´ë™ ì „ì— í˜¸ì¶œí•  â€œì•ˆì „ ì¢…ë£Œâ€ í•¨ìˆ˜ ë…¸ì¶œ
			window.__disableDirtyGuard__ = () => {
				allowLeave = true;
				isDirty = false;
				window.removeEventListener('beforeunload', onBeforeUnload);
			};
		})();
	</script>

</th:block>

</html>