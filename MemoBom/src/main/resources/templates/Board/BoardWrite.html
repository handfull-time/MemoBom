<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{Common/LayoutBase}">

<th:block layout:fragment="title">ì‘ì€ ì¡°ê°</th:block>

<th:block layout:fragment="header">
	<th:block th:replace="~{Fragments/Header :: Header_Back('ì‘ì€ ì¡°ê°')}"></th:block><!--í¸ë¦°-->
</th:block>

<th:block layout:fragment="content">
	
<!-- Topic Select Modal (compact) -->
<div id="topicSelectModal"
     th:if="${topics != null and #lists.size(topics) > 1}"
     class="fixed inset-0 z-50 flex items-end justify-center bg-black/40 p-3">

  <div class="w-full max-w-sm rounded-2xl bg-white shadow-2xl">
    <!-- í—¤ë” -->
    <div class="px-4 pt-4 pb-3 border-b border-slate-100">
      <div class="text-base font-extrabold text-slate-800">í† í”½ ì„ íƒ</div>
      <div class="text-xs text-slate-500 mt-1">ì£¼ì œë¥¼ ì„ íƒí•˜ë©´ ë°”ë¡œ ì‘ì„±í•  ìˆ˜ ìˆì–´ìš”.</div>

      <!-- ê²€ìƒ‰ -->
      <div class="mt-3">
        <input id="topicSearch" type="text"
               placeholder="í† í”½ ê²€ìƒ‰..."
               class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm
                      outline-none focus:ring-2 focus:ring-slate-300/40" />
      </div>
    </div>

    <!-- ë¦¬ìŠ¤íŠ¸: ë§ì„ ë•Œ ëŒ€ë¹„ ìŠ¤í¬ë¡¤ -->
    <div id="modalTopicList"
         class="max-h-[46vh] overflow-y-auto px-2 py-2">
      <button type="button"
              th:each="t : ${topics}"
              class="topic-row w-full flex items-center gap-2 rounded-xl px-3 py-2
                     hover:bg-slate-50 transition text-left"
              th:attr="data-uid=${t.uid},
                       data-maxlen=${t.maxLen},
                       data-color=${t.color},
                       data-name=${t.name}">
        <span class="text-lg w-6 text-center" th:text="${t.imogi}">ğŸ§©</span>
        <span class="flex-1 text-sm font-semibold text-slate-800 truncate"
              th:text="${t.name}">Topic</span>

        <span class="h-3 w-3 rounded-full border border-black/10 shrink-0"
              th:style="'background:' + ${t.color}"></span>
      </button>

      <!-- ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ -->
      <div id="topicEmpty"
           class="hidden px-4 py-6 text-center text-sm text-slate-400">
        ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
      </div>
    </div>
  </div>
</div>

<!-- wrapper: í™”ë©´ ë†’ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê°•ì œë¡œ ì¡ìŒ -->
<div class="flex flex-col min-h-[320px] h-[calc(100dvh-120px)] h-[calc(100vh-120px)]">

  <!-- ë³¸ë¬¸: ë‚¨ì€ ê³µê°„ ì „ë¶€ ì°¨ì§€ -->
  <textarea id="content"
            name="content"
            placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."
            disabled
            class="flex-1 min-h-0 w-full border-0 outline-none resize-none p-3 text-[15px] box-border bg-transparent">
  </textarea>

  <!-- í•´ì‹œíƒœê·¸: í•­ìƒ ë§¨ ì•„ë˜(ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ ê³ ì • ëŠë‚Œ) -->
  <div class="sticky bottom-0 border-t border-slate-200 px-3 pt-2 pb-2.5 bg-white">
    <input type="text" id="hashtags" name="hashtags" placeholder="#í•´ì‹œíƒœê·¸ (ì„ íƒ)"
           class="w-full border-0 outline-none text-[13px] text-slate-600 bg-transparent" />

    <div class="mt-1 text-[11px] text-slate-400">
      ì‰¼í‘œ(,) ë˜ëŠ” ë„ì–´ì“°ê¸°ë¡œ ì—¬ëŸ¬ ê°œ ì…ë ¥í•  ìˆ˜ ìˆì–´ìš”.
    </div>
  </div>

</div>

</th:block>




<th:block layout:fragment="footer">
	<th:block th:replace="~{Fragments/Footer :: FooterWrite}"></th:block>
</th:block>

<th:block layout:fragment="script">

<script th:inline="javascript">
  const topics = /*[[${topics}]]*/ [];
  let selectedTopicUid = null;

  function applyTopicToEditor(topic) {
    const ta = document.getElementById("content");
    selectedTopicUid = topic.uid;

	const header = document.getElementById("headerTitle");
	if (header && topic.name) {
	    header.textContent = topic.name + " Â· ì‘ì€ ì¡°ê°";
	}
	  
    const maxLen = Number(topic.maxLen || 0);
    if (maxLen > 0) ta.setAttribute("maxlength", String(maxLen));
    else ta.removeAttribute("maxlength");

    ta.removeAttribute("disabled");
    ta.focus();

    const modal = document.getElementById("topicSelectModal");
    if (modal) modal.remove();
  }

  function initTopicModalCompact() {
    // 1ê°œë©´ ìë™
    if (!Array.isArray(topics) || topics.length <= 1) {
      if (topics?.length === 1) applyTopicToEditor(topics[0]);
      return;
    }

    // í´ë¦­ ì„ íƒ
    document.querySelectorAll("#modalTopicList .topic-row").forEach(btn => {
      btn.addEventListener("click", () => {
        applyTopicToEditor({
          uid: btn.dataset.uid,
          maxLen: Number(btn.dataset.maxlen || 0),
          color: btn.dataset.color,
          name: btn.dataset.name
        });
      });
    });

    // ê²€ìƒ‰
    const input = document.getElementById("topicSearch");
    const empty = document.getElementById("topicEmpty");
    const rows = Array.from(document.querySelectorAll("#modalTopicList .topic-row"));

    const applyFilter = () => {
      const q = (input.value || "").trim().toLowerCase();
      let visible = 0;

      rows.forEach(r => {
        const name = (r.dataset.name || "").toLowerCase();
        const ok = !q || name.includes(q);
        r.classList.toggle("hidden", !ok);
        if (ok) visible++;
      });

      if (empty) empty.classList.toggle("hidden", visible !== 0);
    };

    input?.addEventListener("input", applyFilter, { passive: true });
    // ì§„ì… ì‹œ ë°”ë¡œ í¬ì»¤ìŠ¤
    input?.focus();
  }

  document.addEventListener("DOMContentLoaded", initTopicModalCompact);

  // ì €ì¥ ì‹œ ì‚¬ìš©
  // onClickWriteì—ì„œ: topicUid: selectedTopicUid ë¡œ ì „ì†¡í•˜ëŠ” ê²ƒ ìœ ì§€
</script>


	<script th:inline="javascript">
		function normalizeHashtags(raw) {
			// ì‚¬ìš©ì ì…ë ¥ ê±°ë¶€ê° ìµœì†Œí™”: ììœ  ì…ë ¥ í—ˆìš©, ë‚´ë¶€ì ìœ¼ë¡œë§Œ ê°€ë³ê²Œ ì •ë¦¬
			// - êµ¬ë¶„ì: ê³µë°±/ì‰¼í‘œ
			// - ì•ì˜ # ì œê±°
			// - ì¤‘ë³µ ì œê±°, ìµœëŒ€ 10ê°œ
			if (!raw) return [];
			const parts = raw
				.split(/[\s,]+/g)
				.map(t => (t || '').trim())
				.filter(Boolean)
				.map(t => t.startsWith('#') ? t.slice(1) : t)
				.map(t => t.replace(/^#+/g, ''))
				.filter(Boolean)
				.map(t => t.slice(0, 20));

			const uniq = [];
			for (const t of parts) {
				if (!t) continue;
				if (!uniq.includes(t)) uniq.push(t);
				if (uniq.length >= 10) break;
			}
			return uniq;
		}

		async function onClickWrite() {
			if (Array.isArray(topics) && topics.length > 1 && !selectedTopicUid) {
			  await alertP( "í† í”½ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
			  return;
			}

			const content = document.getElementById('content').value.trim();
			if (!content || content.length === 0) {
				await alertP('ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
				return;
			}

			const hashtagRaw = (document.getElementById('hashtags')?.value || '').trim();
			//const hashtags = normalizeHashtags(hashtagRaw);

			const sendObj = {
				seal: /*[[${seal}]]*/ null,
				topicUid: selectedTopicUid,
				content: content,
				hashTag: hashtagRaw
			}

			try {
				const url = /*[[@{/Fragment/Save.json}]]*/ '/Fragment/Save.json';

				const data = await apiPost(url, sendObj);

				if (!data) {
					showGlobal("err", "ì €ì¥ ì‹¤íŒ¨");
					return;
				}

				if (data.code === "0") {
					await alertP("The new fragment has been saved.");
					location.replace(/*[[@{/Fragment/index.html}]]*/ '/Fragment/index.html');
				} else {
					showGlobal("err", data.message || "ì €ì¥ ì‹¤íŒ¨");
				}
			} catch (e) {
				showGlobal("err", "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
			} finally {
				// btnSaveê°€ ì—†ëŠ” í™”ë©´ë„ ìˆì„ ìˆ˜ ìˆì–´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
				if (typeof btnSave !== 'undefined' && btnSave) btnSave.disabled = false;
			}
		}
	</script>
</th:block>

</html>
<!--
	í† í”½ë§ˆë‹¤ placeholder ë¬¸êµ¬ë¥¼ ë°”ê¾¸ê¸° ("ì´ í† í”½ì—ëŠ” ì´ëŸ° ë‚´ìš©ì„ ì¨ë³´ì„¸ìš”")
	maxLen ì´ˆê³¼ ì§ì „ ì¹´ìš´íŠ¸ ìƒ‰ìƒ ê²½ê³ (ì˜ˆ: 90% ë„˜ìœ¼ë©´ ì£¼í™© â†’ ë¹¨ê°•)
	ë§ˆì§€ë§‰ìœ¼ë¡œ ì„ íƒí•œ í† í”½ localStorageì— ê¸°ì–µí•´ì„œ ë‹¤ìŒ ì‘ì„± ì‹œ ìë™ ì„ íƒ
	í† í”½ ìƒ‰ì„ textarea í¬ì»¤ìŠ¤ ë§ì´ë‚˜ í•˜ë‹¨ ë°”ì— ì‚´ì§ ë°˜ì˜í•´ì„œ â€œì§€ê¸ˆ ì“°ëŠ” í† í”½â€ ê°ê° ì£¼ê¸°
-->