<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{Common/LayoutBase}">

<th:block layout:fragment="title">작은 조각</th:block>

<th:block layout:fragment="header">
	<th:block th:replace="~{Fragments/Header :: Header_Back('작은 조각')}"></th:block><!--편린-->
</th:block>

<th:block layout:fragment="content">

	<!-- wrapper: 화면 높이를 기준으로 강제로 잡음 -->
	<div style="
      display:flex;
      flex-direction:column;
      height:calc(100dvh - 120px);
      height:calc(100vh - 120px);
      min-height:320px;
  ">

		<!-- 본문: 남은 공간 전부 차지 -->
		<textarea id="content" name="content" placeholder="내용을 입력해 주세요." style="
        flex:1;
        min-height:0;            /* 중요: flex 자식이 제대로 늘/줄도록 */
        width:100%;
        border:none;
        outline:none;
        resize:none;
        padding:12px;
        font-size:15px;
        box-sizing:border-box;
        background:transparent;
      "></textarea>

		<!-- 해시태그: 항상 맨 아래(스크롤 컨테이너 안에서 고정 느낌) -->
		<div style="
        position:sticky;
        bottom:0;
        border-top:1px solid #eee;
        padding:8px 12px 10px;
        background:#fff;
    ">
			<input type="text" id="hashtags" name="hashtags" placeholder="#해시태그 (선택)" style="
          width:100%;
          border:none;
          outline:none;
          font-size:13px;
          color:#555;
          background:transparent;
        " />
			<div style="margin-top:4px;font-size:11px;color:#aaa;">
				쉼표(,) 또는 띄어쓰기로 여러 개 입력할 수 있어요.
			</div>
		</div>

	</div>

</th:block>




<th:block layout:fragment="footer">
	<th:block th:replace="~{Fragments/Footer :: FooterWrite}"></th:block>
</th:block>

<th:block layout:fragment="script">

	<script th:inline="javascript">
		function normalizeHashtags(raw) {
			// 사용자 입력 거부감 최소화: 자유 입력 허용, 내부적으로만 가볍게 정리
			// - 구분자: 공백/쉼표
			// - 앞의 # 제거
			// - 중복 제거, 최대 10개
			if (!raw) return [];
			const parts = raw
				.split(/[\s,]+/g)
				.map(t => (t || '').trim())
				.filter(Boolean)
				.map(t => t.startsWith('#') ? t.slice(1) : t)
				.map(t => t.replace(/^#+/g, ''))
				.filter(Boolean)
				.map(t => t.slice(0, 20));

			const uniq = [];
			for (const t of parts) {
				if (!t) continue;
				if (!uniq.includes(t)) uniq.push(t);
				if (uniq.length >= 10) break;
			}
			return uniq;
		}

		async function onClickWrite() {
			const content = document.getElementById('content').value.trim();
			if (!content || content.length === 0) {
				alertP('내용을 입력해 주세요.');
				return;
			}

			const hashtagRaw = (document.getElementById('hashtags')?.value || '').trim();
			//const hashtags = normalizeHashtags(hashtagRaw);

			const sendObj = {
				seal: /*[[${seal}]]*/ null,
				topicUid: /*[[${topic.uid}]]*/ null,
				content: content,
				hashTag: hashtagRaw
			}

			try {
				const url = /*[[@{/Fragment/Save.json}]]*/ '/Fragment/Save.json';

				const data = await apiPost(url, sendObj);

				if (!data) {
					showGlobal("err", "저장 실패");
					return;
				}

				if (data.code === "0") {
					await alertP("The new fragment has been saved.");
					location.replace(/*[[@{/Fragment/index.html}]]*/ '/Fragment/index.html');
				} else {
					showGlobal("err", data.message || "저장 실패");
				}
			} catch (e) {
				showGlobal("err", "저장 중 오류가 발생했습니다.");
			} finally {
				// btnSave가 없는 화면도 있을 수 있어 안전하게 처리
				if (typeof btnSave !== 'undefined' && btnSave) btnSave.disabled = false;
			}
		}
	</script>
</th:block>

</html>