<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{Common/LayoutBase}">

<th:block layout:fragment="title">Topic</th:block>

<th:block layout:fragment="header">
	<div th:replace="~{Fragments/Header :: Header_Search('Topic')}"></div>
</th:block>

<th:block layout:fragment="content">

	<th:block th:if="${keyword != null}">
        <div class="px-2 pt-2">
            <h2 class="text-lg font-extrabold tracking-tight">ê²€ìƒ‰ ê²°ê³¼: "<span th:text="${keyword}">í‚¤ì›Œë“œ</span>"</h2>
        </div>
		<div id="searchList" class="space-y-2"></div>
	</th:block>
	
	<th:block th:if="${keyword == null}">
	<!-- ìƒë‹¨ ì„¹ì…˜: ì¸ê¸° -->
	<section class="space-y-2">
		<div class="px-2 pt-2">
			<h2 class="text-2xl font-extrabold tracking-tight">ì¸ê¸° Topic</h2>
			<p class="text-xs text-slate-500 mt-1">ìš”ì¦˜ ëœ¨ëŠ” í† í”½ì„ ëª¨ì•„ë´¤ì–´ìš”.</p>
		</div>

		<div id="trendingList" class="space-y-2"></div>
	</section>

	<div class="h-4"></div>

	<!-- í•˜ë‹¨ ì„¹ì…˜: ìƒˆë¡œìš´ -->
	<section class="space-y-2">
		<div class="px-2 pt-2">
			<h2 class="text-2xl font-extrabold tracking-tight">ìƒˆë¡œìš´ Topic</h2>
			<p class="text-xs text-slate-500 mt-1">ìµœê·¼ ìƒì„±ëœ í† í”½ì´ì—ìš”.</p>
		</div>

		<div id="freshList" class="space-y-2"></div>
	</section>
	</th:block>

	<!-- ìƒíƒœ ë©”ì‹œì§€ -->
	<div id="stateBox" class="hidden mt-3 mx-2 rounded-2xl border p-3 text-sm"></div>

	<!-- topic row template -->
	<template id="tplTopicRow">
		<div class="topic-row bg-white rounded-2xl border border-slate-200 p-3 shadow-sm">
			<div class="flex items-start gap-3">
				<!-- emoji badge -->
				<div class="shrink-0">
					<div
						class="emoji-badge w-11 h-11 rounded-2xl flex items-center justify-center text-2xl border border-slate-200 bg-slate-50">
						ğŸ˜Š
					</div>
				</div>

				<!-- right ì˜ì—­ -->
				<div class="min-w-0 flex-1">

					<!-- âœ… ìƒë‹¨ 3ì˜ì—­: [í† í”½] [ì‘ì„±ì] [Flowë²„íŠ¼] -->
					<div class="flex items-center gap-2"
						style="grid-template-columns: minmax(0, 1fr) minmax(0, 160px) 96px;">
						<!-- (1) í† í”½ ì˜ì—­ -->
						<div class="min-w-0 flex-1">
							<span
								class="topic-name block font-extrabold text-lg truncate cursor-pointer hover:underline">
								TopicName
							</span>
						</div>

						<!-- (2) ì‘ì„±ì ì˜ì—­ -->
						<div class="shrink-0 flex items-center gap-3">
							<button type="button" class="topic-user flex items-center gap-2 max-w-[140px]">
								<img class="topic-user-img w-6 h-6 rounded-full border border-slate-200 object-cover"
									alt="í”„ë¡œí•„" />
								<span class="topic-user-name text-xs text-slate-600 truncate">
									ì‘ì„±ì
								</span>
							</button>

							<button type="button"
								class="btn-follow w-24 h-9 rounded-xl border border-slate-200 bg-white text-slate-800 text-sm font-semibold hover:bg-slate-50">
								Flow ì‹ ì²­
							</button>
						</div>
					</div>

					<!-- Description -->
					<div class="topic-desc text-sm text-slate-600 mt-2 line-clamp-2">
						ì„¤ëª…
					</div>

					<!-- HashTag -->
					<div class="topic-tags text-xs text-slate-400 mt-1 truncate">
						#tag
					</div>

					<!-- meta -->
					<div class="flex items-center gap-4 mt-2 text-xs text-slate-600">
						<div class="flex items-center gap-1">
							<span aria-hidden="true">ğŸ‘¥</span>
							<span class="topic-flow">0</span>
						</div>
						<div class="flex items-center gap-1">
							<span aria-hidden="true">ğŸ“</span>
							<span class="topic-memo">0</span>
						</div>

						<span class="topic-uid hidden"></span>
						<span class="topic-no hidden"></span>
					</div>

				</div>
			</div>
		</div>
	</template>

</th:block>

<th:block layout:fragment="footer">
	<div th:replace="~{Fragments/Footer :: BasicFooter}"></div>
</th:block>

<th:block layout:fragment="script">
	<script th:inline="javascript">
		(() => {
			const $ = (id) => document.getElementById(id);

			const elTrending = $("trendingList");
			const elFresh = $("freshList");
			const elSearch = $("searchList");
			const elState = $("stateBox");
			const tpl = $("tplTopicRow");

			function showState(type, text) {
				elState.classList.remove("hidden");
				elState.textContent = text;

				elState.classList.remove(
					"bg-red-50", "border-red-200", "text-red-700",
					"bg-green-50", "border-green-200", "text-green-700",
					"bg-slate-50", "border-slate-200", "text-slate-700"
				);

				if (type === "err") elState.classList.add("bg-red-50", "border-red-200", "text-red-700");
				else if (type === "ok") elState.classList.add("bg-green-50", "border-green-200", "text-green-700");
				else elState.classList.add("bg-slate-50", "border-slate-200", "text-slate-700");
			}

			function hideState() {
				elState.classList.add("hidden");
				elState.textContent = "";
			}

			function safeText(v, fallback = "") {
				if (v === null || v === undefined) return fallback;
				const s = String(v).trim();
				return s ? s : fallback;
			}

			function renderList(container, topics) {
				
				if( !container ){
                    return;
                }
				
				container.innerHTML = "";

				if (!topics || topics.length === 0) {
					const empty = document.createElement("div");
					empty.className = "mx-2 rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-500";
					empty.textContent = "í‘œì‹œí•  í† í”½ì´ ì—†ìŠµë‹ˆë‹¤.";
					container.appendChild(empty);
					return;
				}

				topics.forEach((t) => {
					const node = tpl.content.firstElementChild.cloneNode(true);

					const emoji = node.querySelector(".emoji-badge");
					const name = node.querySelector(".topic-name");
					const desc = node.querySelector(".topic-desc");
					const tags = node.querySelector(".topic-tags");
					const flow = node.querySelector(".topic-flow");
					const memo = node.querySelector(".topic-memo");
					const btn = node.querySelector(".btn-follow");
					const uid = node.querySelector(".topic-uid");
					const no = node.querySelector(".topic-no");
					const userBtn = node.querySelector(".topic-user");
					const userImg = node.querySelector(".topic-user-img");
					const userName = node.querySelector(".topic-user-name");


					// ë°ì´í„° ë°”ì¸ë”©
					emoji.textContent = safeText(t.imogi, "ğŸ˜Š");
					name.textContent = safeText(t.name, "(ì´ë¦„ ì—†ìŒ)");
					desc.textContent = safeText(t.description, "");
					tags.textContent = safeText(t.hashTag, "");
					flow.textContent = Number(t.flowCount || 0).toLocaleString();
					memo.textContent = Number(t.memoCount || 0).toLocaleString();
					uid.textContent = safeText(t.uid, "");
					no.textContent = String(t.topicNo ?? "");
					const userUid = (t.user && t.user.uid) ? String(t.user.uid).trim() : "";
					const nick = (t.user && t.user.nickname) ? String(t.user.nickname).trim() : "";
					const profileUrl = (t.user && t.user.profileUrl) ? String(t.user.profileUrl).trim() : "";

					userName.textContent = nick || "Unknown";
					if (profileUrl) userImg.src = profileUrl;
					else userImg.removeAttribute("src"); // ë¹ˆ src ë°©ì§€



					// ì»¬ëŸ¬ ì ìš©(ë°°ì§€ ë°°ê²½ + ì¹´ë“œ ì¢Œì¸¡ ë¼ì¸ ëŠë‚Œ)
					const color = safeText(t.color, "");
					if (/^#[0-9a-fA-F]{6}$/.test(color)) {
						emoji.style.background = color;
						emoji.style.borderColor = "rgba(148,163,184,0.6)"; // slate-400 ëŠë‚Œ
						node.style.borderLeft = `6px solid ${color}`;
					}

					// íŒ”ë¡œìš° ë²„íŠ¼(ì˜ˆì‹œ ë™ì‘: í† ê¸€ UIë§Œ)
					// flow ë²„íŠ¼(ì„œë²„ ì—°ë™)
					let isFlow = !!t.flow;           // âœ… ì„œë²„ì—ì„œ ë‚´ë ¤ì˜¤ëŠ” boolean
					let busy = false;

					function applyFlowUI() {
						if (isFlow) {
							// âœ… flow ìƒíƒœ: "Flow í•´ì§€" + ì§„í•œ ë²„íŠ¼
							btn.textContent = "Flow í•´ì§€";
							btn.classList.remove("bg-white", "text-slate-800", "border-slate-200", "hover:bg-slate-50");
							btn.classList.add("bg-slate-900", "text-pink-500", "border-slate-900");
						} else {
							// âœ… ë¯¸flow ìƒíƒœ: "Flow ì‹ ì²­" + í° ë²„íŠ¼
							btn.textContent = "Flow ì‹ ì²­";
							btn.classList.add("bg-white", "text-slate-800", "border-slate-200", "hover:bg-slate-50");
							btn.classList.remove("bg-slate-900", "text-pink-500", "border-slate-900");
						}
					}

					applyFlowUI();

					btn.addEventListener("click", async (e) => {
						e.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë§‰ê¸°
						if (busy) return;

						const uidVal = (t.uid || "").trim();
						if (!uidVal) {
							showState("err", "uidê°€ ì—†ì–´ Flowë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
							return;
						}

						busy = true;
						btn.disabled = true;

						try {
							const url = /*[[@{/Topic/Flow.json}]]*/ "/Topic/Flow.json";

							const res = await apiPost(url, {uid: uidVal});

							if (!res || res.code !== "0") {
								showState("err", (res && res.message) ? res.message : "ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
								return;
							}

							// âœ… ì„±ê³µ ì‹œ UI ìƒíƒœ ì „í™˜
							const before = isFlow;
							isFlow = !isFlow;
							applyFlowUI();

							// âœ… (ì„ íƒ) flowCount ìˆ«ìë„ ê°™ì´ ì¦ê°
							// ì„œë²„ê°€ ìµœì‹  ì¹´ìš´íŠ¸ë¥¼ ë‚´ë ¤ì£¼ì§€ ì•Šìœ¼ë‹ˆ UXìš©ìœ¼ë¡œë§Œ ë°˜ì˜
							const cur = Number(t.flowCount || 0);
							if (!before && isFlow) t.flowCount = cur + 1;     // ì‹ ì²­
							if (before && !isFlow) t.flowCount = Math.max(0, cur - 1); // í•´ì§€
							flow.textContent = Number(t.flowCount || 0).toLocaleString();

							// (ì„ íƒ) ì„±ê³µ ë©”ì‹œì§€
							// showState("ok", isFlow ? "Flow ì‹ ì²­ ì™„ë£Œ" : "Flow í•´ì§€ ì™„ë£Œ");
						} catch (err) {
							showState("err", "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì²˜ë¦¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
						} finally {
							busy = false;
							btn.disabled = false;
						}
					});

					// topic name í´ë¦­ â†’ Topic í™”ë©´ ì´ë™
					const nameEl = node.querySelector(".topic-name");
					nameEl.addEventListener("click", (e) => {
						e.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€

						const uidVal = (t.uid || "").trim();
						if (!uidVal) {
							showState("err", "í† í”½ UIDê°€ ì—†ìŠµë‹ˆë‹¤.");
							return;
						}

						const url = /*[[@{/Board/Topic.html}]]*/ "/Board/Topic.html";
						location.href = url + "?uid=" + encodeURIComponent(uidVal);
					});
					
					emoji.addEventListener("click", (e) => {
                        e.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€

                        const uidVal = (t.uid || "").trim();
                        if (!uidVal) {
                            showState("err", "í† í”½ UIDê°€ ì—†ìŠµë‹ˆë‹¤.");
                            return;
                        }
						
                        const url = /*[[@{/Topic/Item.html}]]*/ "/Topic/Item.html";
                        location.href = url + "?uid=" + encodeURIComponent(uidVal);
                    });

					userBtn.addEventListener("click", (e) => {
						e.stopPropagation(); // ì¹´ë“œ í´ë¦­ê³¼ ë¶„ë¦¬
						if (!userUid) {
							showState("err", "ì‚¬ìš©ì UIDê°€ ì—†ìŠµë‹ˆë‹¤.");
							return;
						}
						const url = /*[[@{/Board/Topic.html}]]*/ "/Board/Topic.html";
						location.href = url + "?user=" + encodeURIComponent(userUid);
					});


					// (ì„ íƒ) ì¹´ë“œ í´ë¦­ ì‹œ ìƒì„¸ ì´ë™ â€” í•„ìš” ì‹œ URLë§Œ ë§ì¶°ì„œ ì‚¬ìš©
					node.addEventListener("click", (e) => {
						// ë²„íŠ¼ í´ë¦­ì€ ì¹´ë“œ í´ë¦­ìœ¼ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
						if (e.target.closest(".btn-follow")) return;
						console.log(e.target);

						// ì˜ˆì‹œ: /Topic/TopicView?topicNo=...
						// location.href = /*[[@{/Topic/View}]]*/ "/Topic/View" + "?topicNo=" + encodeURIComponent(t.topicNo);

						// ì§€ê¸ˆì€ ë™ì‘ ì•ˆí•˜ê²Œ(ì›í•˜ì‹œë©´ ë¼ìš°íŒ…ì— ë§ì¶° ë°”ë¡œ ì—°ê²°í•´ë“œë¦´ê²Œìš”)
					});

					container.appendChild(node);
				});
			}

			async function load() {
				hideState();
				
				const url = /*[[@{/Topic/TopicList.json}]]*/ "/Topic/TopicList.json";

				const keyword = /*[[${keyword}]]*/ null;
				let urlWithKeyword = url;
				if(keyword){
                    urlWithKeyword = url + "?keyword=" + encodeURIComponent(keyword);
                }

				try {
					// loading overlayê°€ app.jsì— ìˆë‹¤ë©´ ì—¬ê¸°ì„œ show/hide í˜¸ì¶œí•´ë„ ë¨
					const res = await apiGet(urlWithKeyword);

					if (!res || res.code !== "0" || !res.data) {
						showState("err", (res && res.message) ? res.message : "ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
						renderList(elTrending, []);
						renderList(elFresh, []);
						return;
					}

					if(keyword){
						renderList(elSearch, res.data.search || []);
					} else{
						renderList(elTrending, res.data.trending || []);
						renderList(elFresh, res.data.fresh || []);
					}
				} catch (e) {
					showState("err", "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
					renderList(elTrending, []);
					renderList(elFresh, []);
				}
			}

			// DOM ready
			window.addEventListener("DOMContentLoaded", load);
		})();
		
		function headerSearch(keyword) {
			
			if( !keyword || keyword.trim() === "" ){
				return;
			}
			
            // Topic ê²€ìƒ‰ ì²˜ë¦¬
			const url = /*[[@{/Topic/Topic.html}]]*/ "/Topic/Topic.html";
			location.href = url + "?keyword=" + encodeURIComponent(keyword);
		}
	</script>
</th:block>

</html>