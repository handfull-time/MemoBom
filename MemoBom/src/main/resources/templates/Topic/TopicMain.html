<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{Common/LayoutBase}">

<th:block layout:fragment="title">Mosaic</th:block>

<th:block layout:fragment="header">
	<th:block th:replace="~{Fragments/Header :: Header_Search(
			leftTitle=~{Fragments/Icons :: favicon},
			title='Mosaic', 
			rightTitle=~{Fragments/Icons :: topic_write}
		) }"></th:block>
</th:block>

<th:block layout:fragment="content">

	<th:block th:if="${keyword != null}">
		<div class="px-2 pt-2">
			<h2 class="text-lg font-extrabold tracking-tight">
				ê²€ìƒ‰ ê²°ê³¼: "<span th:text="${keyword}">í‚¤ì›Œë“œ</span>"
			</h2>
		</div>

		<div id="searchList" class="space-y-2"></div>

		<div class="px-2 mt-2">
			<button id="btnMoreSearch" type="button" class="w-full rounded-xl border border-slate-200 bg-white py-2 text-sm text-slate-700
	             hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
				ë” ë³´ê¸°
			</button>
		</div>
	</th:block>

	<th:block th:if="${keyword == null and uid != null}">
		<!-- ë‹¨ì¼ Mosaic(Topic UID ì§€ì •) -->
		<section class="space-y-2">
			<div class="px-2 pt-2">
				<h2 class="text-2xl font-extrabold tracking-tight">Mosaic</h2>
				<p class="text-xs text-slate-500 mt-1">ì„ íƒí•œ Mosaicì…ë‹ˆë‹¤.</p>
			</div>

			<div id="singleList" class="space-y-2"></div>
		</section>
	</th:block>

	<th:block th:if="${keyword == null and uid == null}">
		<!-- ìƒë‹¨ ì„¹ì…˜: ì¸ê¸° -->
		<section class="space-y-2">
			<div class="px-2 pt-2">
				<h2 class="text-2xl font-extrabold tracking-tight">ì¸ê¸° Mosaic</h2>
				<p class="text-xs text-slate-500 mt-1">ìš”ì¦˜ ëœ¨ëŠ” Mosaicì„ ëª¨ì•„ë´¤ì–´ìš”.</p>
			</div>

			<div id="trendingList" class="space-y-2"></div>
			<div class="px-2">
				<button id="btnMoreTrending" type="button" class="w-full rounded-xl border border-slate-200 bg-white py-2 text-sm text-slate-700
		             hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
					ë” ë³´ê¸°
				</button>
			</div>
		</section>

		<div class="h-4"></div>

		<!-- í•˜ë‹¨ ì„¹ì…˜: ìƒˆë¡œìš´ -->
		<section class="space-y-2">
			<div class="px-2 pt-2">
				<h2 class="text-2xl font-extrabold tracking-tight">ìƒˆë¡œìš´ Mosaic</h2>
				<p class="text-xs text-slate-500 mt-1">ìµœê·¼ ìƒì„±ëœ Mosaicì´ì—ìš”.</p>
			</div>

			<div id="freshList" class="space-y-2"></div>
			<div class="px-2">
				<button id="btnMoreFresh" type="button" class="w-full rounded-xl border border-slate-200 bg-white py-2 text-sm text-slate-700
		             hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
					ë” ë³´ê¸°
				</button>
			</div>
		</section>
	</th:block>

	<!-- topic row template -->
	<template id="tplTopicRow">
		<div
			class="topic-row bg-white rounded-xl border border-slate-200 p-1.5 shadow-sm transition-all active:bg-slate-50">
			<div class="flex items-center gap-1.5">
				<div class="shrink-0">
					<div
						class="emoji-badge w-10 h-10 rounded-lg flex items-center justify-center text-xl cursor-pointer border border-slate-200 bg-slate-50 shadow-sm">
						ğŸ˜Š
					</div>
				</div>

				<div class="min-w-0 flex-1">
					<div class="flex items-center justify-between gap-2">
						<span
							class="topic-name block font-bold text-base text-slate-900 truncate cursor-pointer hover:text-indigo-600 transition-colors">
							MosaicName
						</span>
						<button type="button" id="btn-flow"
							class="btn-follow shrink-0 h-7 flex items-center justify-center rounded-lg hover:opacity-80 transition-opacity">
							<img src="" alt="Flow" class="flow-img h-full w-auto object-contain" />
						</button>
					</div>

					<div class="topic-desc text-xs text-slate-500 mt-0.5 line-clamp-1">
						ì„¤ëª…ë¬¸ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.
					</div>

					<div class="flex items-center justify-between mt-1.5 pt-1.5 border-t border-slate-50">
						<div class="flex items-center gap-3 text-[12px] font-medium text-slate-400">
							<div class="flex items-center gap-0.5">
								<span class="opacity-70">ğŸ‘¥</span>
								<span class="topic-flow text-slate-600 font-semibold">0</span>
							</div>
							<div class="flex items-center gap-0.5">
								<span class="opacity-70">ğŸ“</span>
								<span class="topic-memo text-slate-600 font-semibold">0</span>
							</div>
							<span class="topic-uid hidden"></span>
						</div>

						<div class="flex items-center gap-2">
							<button type="button"
								class="btn-share p-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-100"
								aria-label="share">
								<img th:src="@{/images/share.svg}" alt="share" class="w-4 h-4 pointer-events-none" />
							</button>
							<button type="button" class="topic-user flex items-center gap-1.5 max-w-[100px]">
								<img class="topic-user-img w-5 h-5 rounded-full border border-slate-200 object-cover"
									alt="P" />
								<span class="topic-user-name text-[12px] text-slate-500 truncate font-medium">ì‘ì„±ì</span>
							</button>
							<div class="fragment-write-container border-l border-slate-100 pl-2">
								<img th:src="@{/images/fragment/writeFragment.svg}" alt="write"
									class="fragment-write h-6 w-auto cursor-pointer opacity-70 hover:opacity-100 transition-opacity" />
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</template>

</th:block>

<th:block layout:fragment="footer">
	<th:block th:replace="~{Fragments/Footer :: BasicFooter}"></th:block>
</th:block>

<th:block layout:fragment="script">
	<script th:inline="javascript">

		(() => {

			const $ = (id) => document.getElementById(id);

			const elTrending = $("trendingList");
			const elSingle = $("singleList");
			const elFresh = $("freshList");
			const elSearch = $("searchList");
			const tpl = $("tplTopicRow");

			const btnMoreTrending = $("btnMoreTrending");
			const btnMoreFresh = $("btnMoreFresh");
			const btnMoreSearch = $("btnMoreSearch");

			// âœ… sortType (ë°±ì—”ë“œ enumê³¼ ë™ì¼)
			const ETopicSortType = Object.freeze({
				trending: "trending",
				fresh: "fresh",
				search: "search",
				uid: "uid",
			});

			// âœ… sortTypeë³„ í˜ì´ì§• ìƒíƒœ
			const paging = {
				[ETopicSortType.trending]: {page: 1, loading: false, ended: false},
				[ETopicSortType.fresh]: {page: 1, loading: false, ended: false},
				[ETopicSortType.search]: {page: 1, loading: false, ended: false},
				[ETopicSortType.uid]: {page: 1, loading: false, ended: false},
			};

			const keyword = /*[[${keyword}]]*/ null;
			const topicUid = /*[[${uid}]]*/ null;

			function safeText(v, fallback = "") {
				if (v === null || v === undefined) return fallback;
				const s = String(v).trim();
				return s ? s : fallback;
			}

			// âœ… ê¸°ì¡´ renderListë¥¼ "append ì§€ì›"ìœ¼ë¡œ í™•ì¥
			function renderList(container, topics, append = false) {
				if (!container) return;

				if (!append) container.innerHTML = "";

				// ì²« í˜ì´ì§€ì—ì„œë§Œ empty í‘œì‹œ
				if (!append && (!topics || topics.length === 0)) {
					const empty = document.createElement("div");
					empty.className = "mx-2 rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-500";
					empty.textContent = "í‘œì‹œí•  í† í”½ì´ ì—†ìŠµë‹ˆë‹¤.";
					container.appendChild(empty);
					return;
				}

				if (!topics || topics.length === 0) return;

				topics.forEach((t) => {
					const node = tpl.content.firstElementChild.cloneNode(true);

					const emoji = node.querySelector(".emoji-badge");
					const name = node.querySelector(".topic-name");
					const desc = node.querySelector(".topic-desc");
					const flow = node.querySelector(".topic-flow");
					const memo = node.querySelector(".topic-memo");
					const btn_follow = node.querySelector(".btn-follow");
					const flowImg = node.querySelector(".flow-img");
					const uid = node.querySelector(".topic-uid");
					const userImg = node.querySelector(".topic-user-img");
					const userName = node.querySelector(".topic-user-name");

					emoji.textContent = safeText(t.imogi, "ğŸ˜Š");
					name.textContent = safeText(t.name, "(ì´ë¦„ ì—†ìŒ)");
					desc.textContent = safeText(t.description, "");
					flow.textContent = Number(t.flowCount || 0).toLocaleString();
					memo.textContent = Number(t.fragmentCount || 0).toLocaleString();
					uid.textContent = safeText(t.uid, "");

					const userUid = (t.user && t.user.uid) ? String(t.user.uid).trim() : "";
					const nick = (t.user && t.user.nickname) ? String(t.user.nickname).trim() : "";
					const profileUrl = (t.user && t.user.profileUrl) ? String(t.user.profileUrl).trim() : "";

					userName.textContent = nick || "Unknown";
					if (profileUrl) userImg.src = profileUrl;
					else userImg.removeAttribute("src");

					const color = safeText(t.color, "");
					if (/^#[0-9a-fA-F]{6}$/.test(color)) {
						emoji.style.background = color;
						emoji.style.borderColor = "rgba(148,163,184,0.6)";
						node.style.borderLeft = `6px solid ${color}`;
					}

					// flow ë²„íŠ¼(ì„œë²„ ì—°ë™)
					let isFlow = !!t.flow;
					let busy = false;

					function applyFlowUI() {
						flowImg.src = isFlow
							? (/*[[@{/images/topic/topic_flow_apply.svg}]]*/ '/images/topic/topic_flow_apply.svg')
							: (/*[[@{/images/topic/topic_flow_cancel.svg}]]*/ '/images/topic/topic_flow_cancel.svg');
					}
					applyFlowUI();

					btn_follow.addEventListener("click", async (e) => {
						e.stopPropagation();
						if (busy) return;

						if (!IS_LOGIN) {
							toastLoginRequired();
							return;
						}

						const uidVal = (t.uid || "").trim();
						if (!uidVal) {
							showToast("ê²½ê³ ", "uidê°€ ì—†ì–´ Flowë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", ToastType.WARNING, 1500);
							return;
						}

						const ask = "[" + t.name + "] íŒ”ë¡œìš°" + (isFlow ? " í•´ì§€í• ê¹Œìš”?" : "í• ê¹Œìš”?");
						const ok = await confirmP(ask);
						if (!ok) return;

						busy = true;
						btn_follow.disabled = true;

						try {
							const url = /*[[@{/Mosaic/Flow.json}]]*/ "/Mosaic/Flow.json";
							const res = await apiPost(url, {uid: uidVal});

							if (!res || res.code !== "0") {
								showToast("ì˜¤ë¥˜", (res && res.message) ? res.message : "ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", ToastType.ERROR, 1800);
								return;
							}

							const before = isFlow;
							isFlow = !isFlow;
							applyFlowUI();
							
							showToast("ì•ˆë‚´", "[" + t.name + "] íŒ”ë¡œìš°" + (before ? " í•´ì§€í–ˆìŠµë‹ˆë‹¤." : "í–ˆìŠµë‹ˆë‹¤."), ToastType.SUCCESS);

							const cur = Number(t.flowCount || 0);
							if (!before && isFlow) t.flowCount = cur + 1;
							if (before && !isFlow) t.flowCount = Math.max(0, cur - 1);
							flow.textContent = Number(t.flowCount || 0).toLocaleString();

						} catch (err) {
							showToast("ì˜¤ë¥˜", "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì²˜ë¦¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", ToastType.ERROR, 1500);
						} finally {
							busy = false;
							btn_follow.disabled = false;
						}
					});

					name.addEventListener("click", (e) => {
						e.stopPropagation();
						const uidVal = (t.uid || "").trim();
						if (!uidVal) {
							showToast("ì•ˆë‚´", "Mosaic UIDê°€ ì—†ìŠµë‹ˆë‹¤.", ToastType.WARNING, 1500); 
							return;
						}
						const url = /*[[@{/Fragment/index.html}]]*/ "/Fragment/index.html";
						location.href = url + "?topicUid=" + encodeURIComponent(uidVal);
					});

					emoji.addEventListener("click", (e) => {
						e.stopPropagation();
						const uidVal = (t.uid || "").trim();
						if (!uidVal) {
							showToast("ì•ˆë‚´", "Mosaic UIDê°€ ì—†ìŠµë‹ˆë‹¤.", ToastType.WARNING, 1500); 
							return;
						}
						const url = /*[[@{/Mosaic/Item.html}]]*/ "/Mosaic/Item.html";
						location.href = url + "?uid=" + encodeURIComponent(uidVal);
					});

					node.querySelector(".topic-user").addEventListener("click", (e) => {
						e.stopPropagation();
						if (!userUid){
							showToast("ì•ˆë‚´", "ì‚¬ìš©ì UIDê°€ ì—†ìŠµë‹ˆë‹¤.", ToastType.WARNING, 1500); 
							return;
						} 
						const url = /*[[@{/Fragment/index.html}]]*/ "/Fragment/index.html";
						location.href = url + "?userUid=" + encodeURIComponent(userUid);
					});

					node.querySelector(".fragment-write").addEventListener("click", async (e) => {
						e.stopPropagation();
						
						if (!IS_LOGIN) {
							toastLoginRequired();
							return;
						}
						
						const uidVal = (t.uid || "").trim();
						if (!uidVal) {
							showToast("ì•ˆë‚´", "Mosaic UIDê°€ ì—†ìŠµë‹ˆë‹¤.", ToastType.WARNING, 1500); 
							return;
						}
						
						if( !isFlow ){
							const flowIcon = /*[[@{/images/topic/topic_flow_cancel.svg}]]*/ '/images/topic/topic_flow_cancel.svg';

							showToast(
							  "ì•ˆë‚´",
							  `<div class="flex items-center gap-2">
							     <img src="${flowIcon}" class="w-5 h-5" alt="flow">
							     <span>ë¥¼ ì´ìš©í•´ íŒ”ë¡œìš°ë¥¼ ë¨¼ì € í•´ ì£¼ì„¸ìš”.</span>
							   </div>`,
							  ToastType.SUCCESS,
							  2000
							);
							return;
						}
						
						const url = /*[[@{/Fragment/Tessera.html}]]*/ "/Fragment/Tessera.html";
						location.href = url + "?topic=" + encodeURIComponent(uidVal);
					});

					node.querySelector(".btn-share").addEventListener("click", async (e) => {
						e.stopPropagation();

						const uid = (t.uid || "").trim();
						if (!uid) {
							showToast("ì•ˆë‚´", "Mosaic UIDê°€ ì—†ìŠµë‹ˆë‹¤.", ToastType.WARNING, 1500); 
							return;
						}

						// 1) ì§€ì› ì²´í¬
						if (!navigator.share) {
							showToast("ê³µìœ ", "ì´ ë¸Œë¼ìš°ì €ëŠ” ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", ToastType.INFO, 1800);
							return;
						}

						try {
							// 2) ê³µìœ  ë°ì´í„° ì¡°íšŒ
							const url = /*[[@{/TopicShare.json}]]*/ "/TopicShare.json";
							const res = await apiGetWithParam(url, {uid});

							if (!res || res.code !== "0" || !res.data) {
								showToast("ê³µìœ ", res?.message || "ê³µìœ  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", ToastType.ERROR, 1800);
								return;
							}

							const payload = {
								title: res.data.title ?? "",
								text: res.data.text ?? "",
								url: res.data.url ?? ""
							};

							// (ì„ íƒ) Web Share API Level 2: íŠ¹ì • íƒ€ì… ì§€ì› í™•ì¸
							// if (navigator.canShare && !navigator.canShare(payload)) { ... }

							// 3) ì‹¤ì œ ê³µìœ 
							await navigator.share(payload);

						} catch (err) {
							// ì‚¬ìš©ìê°€ ê³µìœ ì°½ì„ ë‹«ëŠ” ê²½ìš°ë„ rejectë¡œ ì˜¬ ìˆ˜ ìˆì–´ ê³¼í•˜ê²Œ ì—ëŸ¬ í† ìŠ¤íŠ¸ ë„ìš°ì§€ ì•ŠëŠ” ê²Œ UXìƒ ì¢‹ìŒ
							// í•„ìš”í•˜ë©´ err.name === 'AbortError' ë¶„ê¸° ê°€ëŠ¥
							console.error(err);
							showToast("ê³µìœ ", "ê³µìœ ë¥¼ ì™„ë£Œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", ToastType.INFO, 1500);
						}
					});

					container.appendChild(node);
				});
			}

			function setMoreButtonState(sortType, btn) {
				if (!btn) return;
				const st = paging[sortType];
				btn.disabled = !!st.loading || !!st.ended;
				btn.textContent = st.ended ? "ë§ˆì§€ë§‰ í˜ì´ì§€ì…ë‹ˆë‹¤" : (st.loading ? "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..." : "ë” ë³´ê¸°");
			}

			async function fetchPage(sortType) {
				const st = paging[sortType];
				if (st.loading || st.ended) return;

				st.loading = true;

				// ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 
				if (sortType === ETopicSortType.trending) setMoreButtonState(sortType, btnMoreTrending);
				if (sortType === ETopicSortType.fresh) setMoreButtonState(sortType, btnMoreFresh);
				if (sortType === ETopicSortType.search) setMoreButtonState(sortType, btnMoreSearch);

				try {
					const baseUrl = /*[[@{/Mosaic/List.json}]]*/ "/Mosaic/List.json";
					const params = {
						uid: (sortType === ETopicSortType.uid ? topicUid : null),
						sortType: sortType,
						page: String(st.page),
					};

					if (sortType === ETopicSortType.search && keyword) {
						params.keyword = keyword;
					}

					const res = await apiGetWithParam(baseUrl, params);

					if (!res || res.code !== "0") {
						showToast("ì—ëŸ¬", (res && res.message) ? res.message : "ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", ToastType.ERROR, 1500); 
						return;
					}

					const list = Array.isArray(res.data) ? res.data : [];

					// âœ… ë§ˆì§€ë§‰ í˜ì´ì§€ íŒì •: dataê°€ ë¹ˆ ë°°ì—´
					if (list.length === 0) {
						st.ended = true;
						return;
					}

					const isFirst = (st.page === 1);
					if (sortType === ETopicSortType.trending) renderList(elTrending, list, !isFirst);
					if (sortType === ETopicSortType.fresh) renderList(elFresh, list, !isFirst);
					if (sortType === ETopicSortType.search) renderList(elSearch, list, !isFirst);
					if (sortType === ETopicSortType.uid) renderList(elSingle, list, !isFirst);

					// âœ… ë‹¤ìŒ í˜¸ì¶œì„ ìœ„í•´ page ì¦ê°€
					st.page += 1;

				} catch (e) {
					console.error(e);
					showToast("ì˜¤ë¥˜", "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", ToastType.ERROR, 1500); 
				} finally {
					st.loading = false;

					if (sortType === ETopicSortType.trending) setMoreButtonState(sortType, btnMoreTrending);
					if (sortType === ETopicSortType.fresh) setMoreButtonState(sortType, btnMoreFresh);
					if (sortType === ETopicSortType.search) setMoreButtonState(sortType, btnMoreSearch);
				}
			}

			async function init() {
				// ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ
				setMoreButtonState(ETopicSortType.trending, btnMoreTrending);
				setMoreButtonState(ETopicSortType.fresh, btnMoreFresh);
				setMoreButtonState(ETopicSortType.search, btnMoreSearch);

				// ì´ë²¤íŠ¸
				btnMoreTrending?.addEventListener("click", () => fetchPage(ETopicSortType.trending));
				btnMoreFresh?.addEventListener("click", () => fetchPage(ETopicSortType.fresh));
				btnMoreSearch?.addEventListener("click", () => fetchPage(ETopicSortType.search));

				// ì²« ë¡œë”©
				if (keyword) {
					fetchPage(ETopicSortType.search);
					return;
				}

				// uidê°€ ìˆìœ¼ë©´: ë‹¨ì¼ Mosaic í™”ë©´(1ê°œë§Œ)
				const uidMode = !!(topicUid && String(topicUid).trim() !== "");
				if (uidMode) {
					fetchPage(ETopicSortType.uid);
					paging[ETopicSortType.uid].ended = true; // ë‹¨ì¼ ëª¨ë“œ 1íšŒë§Œ
					return;
				}

				// ê¸°ë³¸: ì¸ê¸° + ìƒˆë¡œìš´
				fetchPage(ETopicSortType.trending);
				fetchPage(ETopicSortType.fresh);
			}

			window.addEventListener("DOMContentLoaded", init);
		})();
	</script>

	<script th:inline="javascript">

		function headerSearch(keyword) {

			if (!keyword || keyword.trim() === "") {
				return;
			}

			// Mosaic ê²€ìƒ‰ ì²˜ë¦¬
			const url = /*[[@{/Mosaic/index.html}]]*/ "/Mosaic/index.html";
			location.replace(url + "?keyword=" + encodeURIComponent(keyword));
		}

		function functionLeft() {
			location.replace(/*[[@{/}]]*/ '/');
		}

		function functionRight() {
			location.href = /*[[@{/Mosaic/Ensemble.html}]]*/ '/Mosaic/Ensemble.html';
		}
	</script>
</th:block>

</html>