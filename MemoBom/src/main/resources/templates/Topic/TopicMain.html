<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{Common/LayoutBase}">

<th:block layout:fragment="title">Mosaic</th:block>

<th:block layout:fragment="header">
	<th:block th:replace="~{Fragments/Header :: Header_Search('ğŸ”™', 'Mosaic', 'âœï¸')}"></th:block>
</th:block>

<th:block layout:fragment="content">

	<th:block th:if="${keyword != null}">
        <div class="px-2 pt-2">
            <h2 class="text-lg font-extrabold tracking-tight">ê²€ìƒ‰ ê²°ê³¼: "<span th:text="${keyword}">í‚¤ì›Œë“œ</span>"</h2>
        </div>
		<div id="searchList" class="space-y-2"></div>
	</th:block>
	
	<th:block th:if="${keyword == null}">
	<!-- ìƒë‹¨ ì„¹ì…˜: ì¸ê¸° -->
	<section class="space-y-2">
		<div class="px-2 pt-2">
			<h2 class="text-2xl font-extrabold tracking-tight">ì¸ê¸° Mosaic</h2>
			<p class="text-xs text-slate-500 mt-1">ìš”ì¦˜ ëœ¨ëŠ” Mosaicì„ ëª¨ì•„ë´¤ì–´ìš”.</p>
		</div>

		<div id="trendingList" class="space-y-2"></div>
	</section>

	<div class="h-4"></div>

	<!-- í•˜ë‹¨ ì„¹ì…˜: ìƒˆë¡œìš´ -->
	<section class="space-y-2">
		<div class="px-2 pt-2">
			<h2 class="text-2xl font-extrabold tracking-tight">ìƒˆë¡œìš´ Mosaic</h2>
			<p class="text-xs text-slate-500 mt-1">ìµœê·¼ ìƒì„±ëœ Mosaicì´ì—ìš”.</p>
		</div>

		<div id="freshList" class="space-y-2"></div>
	</section>
	</th:block>

	<!-- ìƒíƒœ ë©”ì‹œì§€ -->
	<div id="stateBox" class="hidden mt-3 mx-2 rounded-2xl border p-3 text-sm"></div>

	<!-- topic row template -->
	<template id="tplTopicRow">
	    <div class="topic-row bg-white rounded-xl border border-slate-200 p-1.5 shadow-sm transition-all active:bg-slate-50">
	        <div class="flex items-center gap-1.5">
	            <div class="shrink-0">
	                <div class="emoji-badge w-10 h-10 rounded-lg flex items-center justify-center text-xl cursor-pointer border border-slate-200 bg-slate-50 shadow-sm">
	                    ğŸ˜Š
	                </div>
	            </div>

	            <div class="min-w-0 flex-1">
	                <div class="flex items-center justify-between gap-2">
	                    <span class="topic-name block font-bold text-base text-slate-900 truncate cursor-pointer hover:text-indigo-600 transition-colors">
	                        MosaicName
	                    </span>
	                    <button type="button" id="btn-flow" class="btn-follow shrink-0 h-7 flex items-center justify-center rounded-lg hover:opacity-80 transition-opacity">
	                        <img src="" alt="Flow" class="flow-img h-full w-auto object-contain" />
	                    </button>
	                </div>

	                <div class="topic-desc text-xs text-slate-500 mt-0.5 line-clamp-1">
	                    ì„¤ëª…ë¬¸ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.
	                </div>

	                <div class="flex items-center justify-between mt-1.5 pt-1.5 border-t border-slate-50">
	                    <div class="flex items-center gap-3 text-[10px] font-medium text-slate-400">
	                        <div class="flex items-center gap-0.5">
	                            <span class="opacity-70">ğŸ‘¥</span>
	                            <span class="topic-flow text-slate-600 font-semibold">0</span>
	                        </div>
	                        <div class="flex items-center gap-0.5">
	                            <span class="opacity-70">ğŸ“</span>
	                            <span class="topic-memo text-slate-600 font-semibold">0</span>
	                        </div>
	                        <span class="topic-uid hidden"></span>
	                        <span class="topic-no hidden"></span>
	                    </div>

	                    <div class="flex items-center gap-2">
	                        <button type="button" class="topic-user flex items-center gap-1.5 max-w-[100px]">
	                            <img class="topic-user-img w-4 h-4 rounded-full border border-slate-200 object-cover" alt="P" />
	                            <span class="topic-user-name text-[10px] text-slate-500 truncate font-medium">ì‘ì„±ì</span>
	                        </button>
	                        <div class="fragment-write-container border-l border-slate-100 pl-2">
	                            <img th:src="@{/images/noteWriteButton.svg}" alt="write" class="fragment-write h-5 w-auto cursor-pointer opacity-70 hover:opacity-100 transition-opacity" />
	                        </div>
	                    </div>
	                </div>
	            </div>
	        </div>
	    </div>
	</template>

</th:block>

<th:block layout:fragment="footer">
	<th:block th:replace="~{Fragments/Footer :: BasicFooter}"></th:block>
</th:block>

<th:block layout:fragment="script">
	<script th:inline="javascript">
		(() => {
			const $ = (id) => document.getElementById(id);

			const elTrending = $("trendingList");
			const elFresh = $("freshList");
			const elSearch = $("searchList");
			const elState = $("stateBox");
			const tpl = $("tplTopicRow");

			function showState(type, text) {
				elState.classList.remove("hidden");
				elState.textContent = text;

				elState.classList.remove(
					"bg-red-50", "border-red-200", "text-red-700",
					"bg-green-50", "border-green-200", "text-green-700",
					"bg-slate-50", "border-slate-200", "text-slate-700"
				);

				if (type === "err") elState.classList.add("bg-red-50", "border-red-200", "text-red-700");
				else if (type === "ok") elState.classList.add("bg-green-50", "border-green-200", "text-green-700");
				else elState.classList.add("bg-slate-50", "border-slate-200", "text-slate-700");
			}

			function hideState() {
				elState.classList.add("hidden");
				elState.textContent = "";
			}

			function safeText(v, fallback = "") {
				if (v === null || v === undefined) return fallback;
				const s = String(v).trim();
				return s ? s : fallback;
			}

			function renderList(container, topics) {
				
				if( !container ){
                    return;
                }
				
				container.innerHTML = "";

				if (!topics || topics.length === 0) {
					const empty = document.createElement("div");
					empty.className = "mx-2 rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-500";
					empty.textContent = "í‘œì‹œí•  í† í”½ì´ ì—†ìŠµë‹ˆë‹¤.";
					container.appendChild(empty);
					return;
				}

				topics.forEach((t) => {
					const node = tpl.content.firstElementChild.cloneNode(true);

					const emoji = node.querySelector(".emoji-badge");
					const name = node.querySelector(".topic-name");
					const desc = node.querySelector(".topic-desc");
					const flow = node.querySelector(".topic-flow");
					const memo = node.querySelector(".topic-memo");
					const btn = node.querySelector(".btn-follow");
					const flowImg = node.querySelector(".flow-img");
					const uid = node.querySelector(".topic-uid");
					const no = node.querySelector(".topic-no");
					const userImg = node.querySelector(".topic-user-img");
					const userName = node.querySelector(".topic-user-name");


					// ë°ì´í„° ë°”ì¸ë”©
					emoji.textContent = safeText(t.imogi, "ğŸ˜Š");
					name.textContent = safeText(t.name, "(ì´ë¦„ ì—†ìŒ)");
					desc.textContent = safeText(t.description, "");
					flow.textContent = Number(t.flowCount || 0).toLocaleString();
					memo.textContent = Number(t.fragmentCount || 0).toLocaleString();
					uid.textContent = safeText(t.uid, "");
					no.textContent = String(t.topicNo ?? "");
					const userUid = (t.user && t.user.uid) ? String(t.user.uid).trim() : "";
					const nick = (t.user && t.user.nickname) ? String(t.user.nickname).trim() : "";
					const profileUrl = (t.user && t.user.profileUrl) ? String(t.user.profileUrl).trim() : "";

					userName.textContent = nick || "Unknown";
					if (profileUrl) userImg.src = profileUrl;
					else userImg.removeAttribute("src"); // ë¹ˆ src ë°©ì§€

					// ì»¬ëŸ¬ ì ìš©(ë°°ì§€ ë°°ê²½ + ì¹´ë“œ ì¢Œì¸¡ ë¼ì¸ ëŠë‚Œ)
					const color = safeText(t.color, "");
					if (/^#[0-9a-fA-F]{6}$/.test(color)) {
						emoji.style.background = color;
						emoji.style.borderColor = "rgba(148,163,184,0.6)"; // slate-400 ëŠë‚Œ
						node.style.borderLeft = `6px solid ${color}`;
					}

					// íŒ”ë¡œìš° ë²„íŠ¼(ì˜ˆì‹œ ë™ì‘: í† ê¸€ UIë§Œ)
					// flow ë²„íŠ¼(ì„œë²„ ì—°ë™)
					let isFlow = !!t.flow;           // âœ… ì„œë²„ì—ì„œ ë‚´ë ¤ì˜¤ëŠ” boolean
					let busy = false;

					function applyFlowUI() {
						if (isFlow) {
							flowImg.src = /*[[@{/images/topic_flow_apply.svg}]]*/ '/images/topic_flow_apply.svg';
						} else {
							flowImg.src = /*[[@{/images/topic_flow_cancel.svg}]]*/ '/images/topic_flow_cancel.svg';
						}
					}

					applyFlowUI();

					btn.addEventListener("click", async (e) => {
						e.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë§‰ê¸°
						if (busy) return;

						const uidVal = (t.uid || "").trim();
						if (!uidVal) {
							showState("err", "uidê°€ ì—†ì–´ Flowë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
							return;
						}

						busy = true;
						btn.disabled = true;

						try {
							const url = /*[[@{/Mosaic/Flow.json}]]*/ "/Mosaic/Flow.json";

							const res = await apiPost(url, {uid: uidVal});

							if (!res || res.code !== "0") {
								showState("err", (res && res.message) ? res.message : "ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
								return;
							}

							// âœ… ì„±ê³µ ì‹œ UI ìƒíƒœ ì „í™˜
							const before = isFlow;
							isFlow = !isFlow;
							applyFlowUI();

							// âœ… (ì„ íƒ) flowCount ìˆ«ìë„ ê°™ì´ ì¦ê°
							// ì„œë²„ê°€ ìµœì‹  ì¹´ìš´íŠ¸ë¥¼ ë‚´ë ¤ì£¼ì§€ ì•Šìœ¼ë‹ˆ UXìš©ìœ¼ë¡œë§Œ ë°˜ì˜
							const cur = Number(t.flowCount || 0);
							if (!before && isFlow) t.flowCount = cur + 1;     // ì‹ ì²­
							if (before && !isFlow) t.flowCount = Math.max(0, cur - 1); // í•´ì§€
							flow.textContent = Number(t.flowCount || 0).toLocaleString();

							// (ì„ íƒ) ì„±ê³µ ë©”ì‹œì§€
							// showState("ok", isFlow ? "Flow ì‹ ì²­ ì™„ë£Œ" : "Flow í•´ì§€ ì™„ë£Œ");
						} catch (err) {
							showState("err", "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì²˜ë¦¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
						} finally {
							busy = false;
							btn.disabled = false;
						}
					});

					// topic name í´ë¦­ â†’ Topic í™”ë©´ ì´ë™
					name.addEventListener("click", (e) => {
						e.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€

						const uidVal = (t.uid || "").trim();
						if (!uidVal) {
							showState("err", "í† í”½ UIDê°€ ì—†ìŠµë‹ˆë‹¤.");
							return;
						}

						const url = /*[[@{/Fragment/Mosaic.html}]]*/ "/Fragment/Mosaic.html";
						location.href = url + "?uid=" + encodeURIComponent(uidVal);
					});
					
					emoji.addEventListener("click", (e) => {
                        e.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€

                        const uidVal = (t.uid || "").trim();
                        if (!uidVal) {
                            showState("err", "í† í”½ UIDê°€ ì—†ìŠµë‹ˆë‹¤.");
                            return;
                        }
						
                        const url = /*[[@{/Mosaic/Item.html}]]*/ "/Mosaic/Item.html";
                        location.href = url + "?uid=" + encodeURIComponent(uidVal);
                    });

					node.querySelector(".topic-user").addEventListener("click", (e) => {
						e.stopPropagation(); // ì¹´ë“œ í´ë¦­ê³¼ ë¶„ë¦¬
						if (!userUid) {
							showState("err", "ì‚¬ìš©ì UIDê°€ ì—†ìŠµë‹ˆë‹¤.");
							return;
						}
						const url = /*[[@{/Fragment/Mosaic.html}]]*/ "/Fragment/Mosaic.html";
						location.href = url + "?user=" + encodeURIComponent(userUid);
					});

					node.querySelector(".fragment-write").addEventListener("click", (e) => {
						e.stopPropagation(); // ì¹´ë“œ í´ë¦­ê³¼ ë¶„ë¦¬
						const uidVal = (t.uid || "").trim();
                        if (!uidVal) {
                            showState("err", "í† í”½ UIDê°€ ì—†ìŠµë‹ˆë‹¤.");
                            return;
                        }
						
						const url = /*[[@{/Fragment/Tessera.html}]]*/ '/Fragment/Tessera.html';
						location.href = url + "?topic=" + encodeURIComponent(uidVal);
					});

					// (ì„ íƒ) ì¹´ë“œ í´ë¦­ ì‹œ ìƒì„¸ ì´ë™ â€” í•„ìš” ì‹œ URLë§Œ ë§ì¶°ì„œ ì‚¬ìš©
					//node.addEventListener("click", (e) => {
					//	if (e.target.closest(".btn-follow")) return;
					//	console.log(e.target);
					//});

					container.appendChild(node);
				});
			}

			async function load() {
				hideState();
				
				const url = /*[[@{/Mosaic/List.json}]]*/ "/Mosaic/List.json";

				const keyword = /*[[${keyword}]]*/ null;
				let urlWithKeyword = url;
				if(keyword){
                    urlWithKeyword = url + "?keyword=" + encodeURIComponent(keyword);
                }

				try {
					// loading overlayê°€ app.jsì— ìˆë‹¤ë©´ ì—¬ê¸°ì„œ show/hide í˜¸ì¶œí•´ë„ ë¨
					const res = await apiGet(urlWithKeyword);

					if (!res || res.code !== "0" || !res.data) {
						showState("err", (res && res.message) ? res.message : "ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
						renderList(elTrending, []);
						renderList(elFresh, []);
						return;
					}

					if(keyword){
						renderList(elSearch, res.data.search || []);
					} else{
						renderList(elTrending, res.data.trending || []);
						renderList(elFresh, res.data.fresh || []);
					}
				} catch (e) {
					console.error(urlWithKeyword, e);
					showState("err", "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
					renderList(elTrending, []);
					renderList(elFresh, []);
				}
			}

			// DOM ready
			window.addEventListener("DOMContentLoaded", load);
		})();
		
		function headerSearch(keyword) {
			
			if( !keyword || keyword.trim() === "" ){
				return;
			}
			
            // Mosaic ê²€ìƒ‰ ì²˜ë¦¬
			const url = /*[[@{/Mosaic/Mosaic.html}]]*/ "/Mosaic/Mosaic.html";
			location.href = url + "?keyword=" + encodeURIComponent(keyword);
		}
		
		function functionLeft(){
			history.back();
		}
		
		function functionRight(){
			location.href = /*[[@{/Mosaic/Ensemble.html}]]*/ '/Mosaic/Ensemble.html';
		}
		</script>
</th:block>

</html>