<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{Common/LayoutBase}">

<th:block layout:fragment="title">Create Topic</th:block>

<th:block layout:fragment="css">
	<style>

	</style>
</th:block>

<th:block layout:fragment="header">
	<div th:replace="~{Fragments/Header :: Header_CreateTopic}"></div>
</th:block>

<th:block layout:fragment="content">

	<div class="space-y-4">

		<!-- hidden topicNo -->
		<input type="hidden" id="topicNo" th:value="${topic?.topicNo}" />

		<!-- Threads-like card -->
		<div class="bg-white rounded-2xl border border-slate-200 p-4">
			<!-- ìƒë‹¨: ì´ëª¨ì§€ + ì´ë¦„ -->
			<div class="flex items-start gap-3">
				<!-- Emoji -->
				<div class="shrink-0">
					<label class="block text-xs text-slate-500 mb-1">ì´ëª¨ì§€</label>
					<input type="hidden" id="imogi" th:value="${topic?.imogi}" />
					<button type="button" id="emojiBtn" class="w-12 h-12 rounded-xl border border-slate-200 text-xl"
						th:text="${topic?.imogi ?: 'ğŸ˜Š'}">
						ğŸ˜Š
					</button>

					<emoji-picker id="emojiPicker" style="display:none; position:absolute;"></emoji-picker>
				</div>

				<!-- Name -->
				<div class="flex-1">
					<label class="block text-xs text-slate-500 mb-1">ì´ë¦„</label>
					<div class="flex gap-2">
						<input type="text" id="name" required th:value="${topic?.name}" maxlength="36"
							placeholder="ì˜ˆ: ì•„ì´ë””ì–´"
							class="flex-1 h-12 px-4 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-300" />
						<button type="button" id="btnCheckName"
							class="h-12 px-4 whitespace-nowrap rounded-xl border border-slate-200 bg-white text-slate-700 font-semibold">
							ğŸ”
						</button>
					</div>

					<!-- ìƒíƒœ ë©”ì‹œì§€ -->
					<p id="nameStatus" class="mt-2 text-sm"></p>
					<p class="mt-1 text-xs text-slate-400">ì €ì¥ ì „ ì´ë¦„ ì¤‘ë³µ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
				</div>
			</div>

			<!-- Description -->
			<div class="mt-4">
				<label class="block text-xs text-slate-500 mb-1">ì„¤ëª…</label>
				<textarea id="description" rows="4" maxlength="256" placeholder="ì´ í† í”½ì„ ì–´ë–¤ ìš©ë„ë¡œ ì“¸ì§€ ê°„ë‹¨íˆ ì ì–´ì£¼ì„¸ìš”."
					class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-300 resize-none"
					th:text="${topic?.description}"></textarea>
			</div>

			<!-- HashTag -->
			<div class="mt-4">
				<label class="block text-xs text-slate-500 mb-1">í•´ì‹œíƒœê·¸</label>
				<input type="text" id="hashTag" maxlength="256" th:value="${topic?.hashTag}" placeholder="#ë‚´ìš© #ì•„ì´ë””ì–´ #íšŒì˜"
					class="w-full h-12 px-4 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-300" />
				<p class="mt-1 text-xs text-slate-400">ê³µë°±ìœ¼ë¡œ êµ¬ë¶„ (ì˜ˆ: #ë‚´ìš© #ë‚´ìš©)</p>
			</div>

			<!-- Color -->
			<div class="mt-4">
				<!-- Color -->
				<label class="block text-xs text-slate-500 mb-1">ìƒ‰ìƒ</label>

				<div class="flex items-center gap-2">
					<!-- ì‹¤ì œ ê°’ ì €ì¥ìš© (ì„œë²„ë¡œ ë³´ë‚¼ ê°’) -->
					<input type="hidden" id="color" th:value="${topic?.color}" />

					<!-- ë„¤ì´í‹°ë¸Œ ì»¬ëŸ¬ ë‹¤ì´ì–¼ë¡œê·¸ -->
					<input type="color" id="colorPicker"
						class="w-12 h-12 p-0 rounded-xl border border-slate-200 bg-white cursor-pointer" value="#64748b"
						aria-label="ìƒ‰ìƒ ì„ íƒ" />

					<!-- ì„ íƒí•œ ìƒ‰ìƒ í…ìŠ¤íŠ¸ í‘œì‹œ(ì½ê¸° ì „ìš©) -->
					<input type="text" id="colorText" readonly
						class="flex-1 h-12 px-4 rounded-xl border border-slate-200 bg-slate-50 text-slate-700"
						placeholder="#RRGGBB" />

					<!-- ë¯¸ë¦¬ë³´ê¸°(ê¸°ì¡´ ìœ ì§€ ê°€ëŠ¥) -->
					<div id="colorPreview" class="w-10 h-10 rounded-xl border border-slate-200"></div>
				</div>

				<p class="mt-1 text-xs text-slate-400">ìƒ‰ìƒì„ ëˆŒëŸ¬ ì„ íƒí•˜ì„¸ìš”.</p>
			</div>
			<!-- Emoji Set Type -->
			<div class="mt-4">
				<label class="block text-xs text-slate-500 mb-1">ì´ëª¨ì§€ ì„¸íŠ¸</label>
				<div class="grid grid-cols-2 gap-2">
					<!-- ê°ì •í˜• -->
					<button type="button" data-set="1" id="btnSetEmotion"
						class="emoji-set-btn w-full rounded-2xl border border-slate-200 bg-white p-3 text-left hover:bg-slate-50">
						<div class="flex items-center justify-between">
							<div class="font-semibold text-slate-900 text-sm">ê°ì •í˜•</div>
							<span
								class="set-check hidden text-xs px-2 py-0.5 rounded-full bg-slate-900 text-white">ì„ íƒ</span>
						</div>
						<!--<div class="mt-1 text-xs text-slate-500">ê¸°ì¨ Â· ë³´í†µ Â· ìŠ¬í”” Â· í™”ë‚¨ Â· ë§¤ìš°ì¢‹ìŒ</div>-->
						<div class="mt-2 flex items-center gap-1 text-lg">
							<span>ğŸ˜Š</span><span>ğŸ˜</span><span>ğŸ˜¢</span><span>ğŸ˜ </span><span>ğŸ¤©</span>
						</div>
					</button>

					<!-- ë°˜ì‘í˜• -->
					<button type="button" data-set="2" id="btnSetReaction"
						class="emoji-set-btn w-full rounded-2xl border border-slate-200 bg-white p-3 text-left hover:bg-slate-50">
						<div class="flex items-center justify-between">
							<div class="font-semibold text-slate-900 text-sm">ë°˜ì‘í˜•</div>
							<span
								class="set-check hidden text-xs px-2 py-0.5 rounded-full bg-slate-900 text-white">ì„ íƒ</span>
						</div>
						<!--<div class="mt-1 text-xs text-slate-500">ì¢‹ì•„ìš” Â· ê³µê° Â· ì›ƒê¹€ Â· ë†€ëŒ Â· ìŠ¬í””</div>-->
						<div class="mt-2 flex items-center gap-1 text-lg">
							<span>ğŸ‘</span><span>â¤ï¸</span><span>ğŸ˜‚</span><span>ğŸ˜®</span><span>ğŸ˜¢</span>
						</div>
					</button>
				</div>
				<p class="mt-1 text-xs text-slate-400">í† í”½ ì„±ê²©ì— ë§ëŠ” ë°˜ì‘ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”.</p>
			</div>
			<div class="mt-4">
				<!-- External toggle -->
				<label class="block text-xs text-slate-500 mb-1">ì™¸ë¶€ ê³µê°œ</label>
				<label
					class="h-12 px-4 rounded-xl border border-slate-200 flex items-center justify-between cursor-pointer select-none">
					<span class="text-sm text-slate-700">ê³µê°œ</span>
					<input type="checkbox" id="external" th:checked="${topic?.external}"
						class="h-5 w-5 accent-slate-900" />
				</label>
				<p class="mt-1 text-xs text-slate-400">ì²´í¬ ì‹œ ì™¸ë¶€ì— ë…¸ì¶œ</p>
			</div>
		</div>

		<!-- ê¸€ë¡œë²Œ ë©”ì‹œì§€ -->
		<div id="globalMsg" class="hidden text-sm rounded-xl p-3 border"></div>

		<!-- ë²„íŠ¼ -->
		<div class="flex gap-2">
			<button type="button" onclick="history.back()" class="flex-1 h-12 rounded-xl border border-slate-200 bg-slate-100
		           text-slate-600 font-medium hover:bg-slate-200">
				ì·¨ì†Œ
			</button>

			<button type="button" id="btnSave" class="flex-1 h-12 rounded-xl
		           bg-slate-900 text-slate-400 font-semibold
		           enabled:hover:bg-slate-800
		           disabled:bg-slate-300 disabled:text-slate-400">
				ì €ì¥
			</button>
		</div>
	</div>
</th:block>

<th:block layout:fragment="footer">
	<div th:replace="~{Fragments/Footer :: BasicFooter}"></div>
</th:block>

<th:block layout:fragment="script">

	<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
	<script>
		const btn = document.getElementById('emojiBtn');
		const picker = document.getElementById('emojiPicker');
		const input = document.getElementById('imogi');

		btn.addEventListener('click', (e) => {
			picker.style.display = 'block';
			picker.style.top = e.target.getBoundingClientRect().bottom + 'px';
			picker.style.left = e.target.getBoundingClientRect().left + 'px';
		});

		picker.addEventListener('emoji-click', event => {
			input.value = event.detail.unicode;
			btn.textContent = event.detail.unicode;
			picker.style.display = 'none';
		});
	</script>


	<script th:inline="javascript">

		(() => {
			const $ = (id) => document.getElementById(id);

			const elTopicNo = $("topicNo");
			const elImogi = $("imogi");
			const elName = $("name");
			const elHashTag = $("hashTag");
			const elDesc = $("description");
			const elColor = $("color");
			const elExternal = $("external");
			const elColorPicker = $("colorPicker");
			const elColorText = $("colorText");

			const elNameStatus = $("nameStatus");
			const elGlobalMsg = $("globalMsg");
			const elColorPreview = $("colorPreview");

			const btnCheckName = $("btnCheckName");
			const btnSave = $("btnSave");
			const btnSetEmotion = $("btnSetEmotion");
			const btnSetReaction = $("btnSetReaction");
			// ---- emoji set selection ----
			function setEmojiSetType(v) {
				const n = v;
				elEmojiSetType = n;

				// reset
				[btnSetEmotion, btnSetReaction].forEach((b) => {
					b.classList.remove("ring-2", "ring-slate-900", "border-slate-900");
					const ck = b.querySelector(".set-check");
					if (ck) ck.classList.add("hidden");
				});

				const active = (n === 'REACTION') ? btnSetReaction : btnSetEmotion;
				active.classList.add("ring-2", "ring-slate-900", "border-slate-900");
				const ck = active.querySelector(".set-check");
				if (ck) ck.classList.remove("hidden");
			}

			btnSetEmotion.addEventListener("click", () => setEmojiSetType('EMOTION'));
			btnSetReaction.addEventListener("click", () => setEmojiSetType('REACTION'));

			// ì´ˆê¸°ê°’ ì ìš© (ì—†ìœ¼ë©´ 1)
			let elEmojiSetType = /*[[${topic.emojiSetType}]]*/ 'EMOTION'; 
			setEmojiSetType(elEmojiSetType);

			

			// ---- UI helpers ----
			function showGlobal(type, text) {
				elGlobalMsg.classList.remove("hidden");
				elGlobalMsg.textContent = text;

				// reset classes
				elGlobalMsg.classList.remove(
					"bg-red-50", "border-red-200", "text-red-700",
					"bg-green-50", "border-green-200", "text-green-700",
					"bg-slate-50", "border-slate-200", "text-slate-700"
				);

				if (type === "ok") elGlobalMsg.classList.add("bg-green-50", "border-green-200", "text-green-700");
				else if (type === "err") elGlobalMsg.classList.add("bg-red-50", "border-red-200", "text-red-700");
				else elGlobalMsg.classList.add("bg-slate-50", "border-slate-200", "text-slate-700");
			}

			function clearGlobal() {
				elGlobalMsg.classList.add("hidden");
				elGlobalMsg.textContent = "";
			}

			function setNameStatus(type, text) {
				elNameStatus.textContent = text || "";
				elNameStatus.className = "mt-2 text-sm";
				if (type === "ok") elNameStatus.classList.add("text-green-700");
				else if (type === "err") elNameStatus.classList.add("text-red-700");
				else elNameStatus.classList.add("text-slate-500");
			}

			function isHexColor(v) {
				return /^#[0-9a-fA-F]{6}$/.test((v || "").trim());
			}

			function updateColorPreview() {
				const v = (elColor.value || "").trim();
				if (isHexColor(v)) elColorPreview.style.background = v;
				else elColorPreview.style.background = "";
			}

			function normalizeHex(v) {
				const s = (v || "").trim();
				return /^#[0-9a-fA-F]{6}$/.test(s) ? s : "";
			}

			function applyColor(hex) {
				// hidden ê°’
				elColor.value = hex;

				// text í‘œì‹œ
				elColorText.value = hex;

				// preview
				elColorPreview.style.background = hex || "";
			}

			function initColor() {
				// ì„œë²„ì—ì„œ ë‚´ë ¤ì˜¨ ê°’ì´ #RRGGBBë©´ ê·¸ëŒ€ë¡œ, ì•„ë‹ˆë©´ ê¸°ë³¸ê°’ ì§€ì •
				const fromServer = normalizeHex(elColor.value);
				const initial = fromServer || "#64748b";

				elColorPicker.value = initial;
				applyColor(initial);
			}

			elColorPicker.addEventListener("input", () => {
				applyColor(elColorPicker.value);
			});


			// ---- name duplicate check state ----
			let lastCheckedName = "";
			let nameOk = false; // true only when server says code==="0"
			let checking = false;

			function invalidateNameCheck() {
				nameOk = false;
				lastCheckedName = "";
				setNameStatus("info", "");
			}

			async function checkSameName() {
				const name = (elName.value || "").trim();
				clearGlobal();

				if (!name) {
					setNameStatus("err", "ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
					nameOk = false;
					return false;
				}

				// ì´ë¯¸ í™•ì¸ëœ ì´ë¦„ì´ë©´ ìŠ¤í‚µ
				if (nameOk && lastCheckedName === name) return true;

				checking = true;
				setNameStatus("info", "ì¤‘ë³µ í™•ì¸ ì¤‘...");
				btnCheckName.disabled = true;

				const url = /*[[@{/Topic/SameName.json}]]*/ '/Topic/SameName.json';
				try {
					const data = await apiGet(`${url}?name=${encodeURIComponent(name)}`);

					if (!data) {
						setNameStatus("err", "ì¤‘ë³µ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
						nameOk = false;
						return false;
					}

					if (data.code === "0") {
						lastCheckedName = name;
						nameOk = true;
						setNameStatus("ok", "ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¦„ì…ë‹ˆë‹¤.");
						return true;
					} else {
						nameOk = false;
						setNameStatus("err", data.message || "ë™ì¼ ì´ë¦„ ìˆìŒ");
						return false;
					}
				} catch (e) {
					nameOk = false;
					setNameStatus("err", "ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
					return false;
				} finally {
					checking = false;
					btnCheckName.disabled = false;
				}
			}

			// ---- save ----
			function buildPayload() {
				const topicNoRaw = (elTopicNo.value || "").trim();
				const topicNo = topicNoRaw ? Number(topicNoRaw) : 0;

				return {
					topicNo,
					name: (elName.value || "").trim(),
					hashTag: (elHashTag.value || "").trim(),
					description: (elDesc.value || "").trim(),
					color: (elColor.value || "").trim(),
					external: !!elExternal.checked,
					imogi: (elImogi.value || "").trim(),
					emojiSetType: elEmojiSetType
				};
			}

			async function saveTopic() {
				clearGlobal();

				const payload = buildPayload();

				if (!payload.name) {
					showGlobal("err", "ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
					elName.focus();
					return;
				}

				// ì €ì¥ ì „ ì¤‘ë³µí™•ì¸ í•„ìˆ˜
				const ok = await checkSameName();
				if (!ok) {
					showGlobal("err", "ì´ë¦„ ì¤‘ë³µ í™•ì¸ì„ í†µê³¼í•´ì•¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
					return;
				}

				btnSave.disabled = true;

				try {
					const url = /*[[@{/Topic/SaveTopic.json}]]*/ '/Topic/SaveTopic.json';
					const data = await apiPost(url, payload);

					if (!data) {
						showGlobal("err", "ì €ì¥ ì‹¤íŒ¨");
						return;
					}

					if (data.code === "0") {
						alertP("ìƒˆ Topicì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
						location.href = /*[[@{/}]]*/ '/';
					} else {
						showGlobal("err", data.message || "ì €ì¥ ì‹¤íŒ¨");
					}
				} catch (e) {
					showGlobal("err", "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
				} finally {
					btnSave.disabled = false;
				}
			}

			// ---- events ----
			btnCheckName.addEventListener("click", checkSameName);
			btnSave.addEventListener("click", saveTopic);

			// ì´ë¦„ì´ ë°”ë€Œë©´ ì¤‘ë³µí™•ì¸ ë¬´íš¨í™” + ë””ë°”ìš´ìŠ¤ ìë™ ì²´í¬
			let t = null;
			elName.addEventListener("input", () => {
				invalidateNameCheck();
				if (t) clearTimeout(t);
				t = setTimeout(() => {
					// ì…ë ¥ ì¤‘ ë©ˆì·„ì„ ë•Œ ìë™ ì²´í¬(ì›ì¹˜ ì•Šìœ¼ë©´ ì´ ì¤„ì„ ì£¼ì„ ì²˜ë¦¬)
					checkSameName();
				}, 450);
			});

			// ì—”í„°í‚¤ ì €ì¥ ë°©ì§€(ì˜ë„ì¹˜ ì•Šì€ submit ë°©ì§€)
			[elName, elHashTag, elColor].forEach(el => {
				el.addEventListener("keydown", (e) => {
					if (e.key === "Enter") e.preventDefault();
				});
			});

			// ì»¬ëŸ¬ í”„ë¦¬ë·°
			elColor.addEventListener("input", updateColorPreview);
			updateColorPreview();
		})();
	</script>
</th:block>

</html>