<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<!--//네임스페이스에는 mapper 가 있는 풀 패키지명과 매퍼명을 등록 한다. -->
<mapper namespace="com.utime.memoBom.common.mapper.CreateMapper">

<!--ALTER TABLE MB_FRAGMENT ALTER COLUMN IP VARCHAR(40) DEFAULT NULL;-->

	<insert id="createUser">
		CREATE TABLE IF NOT EXISTS MB_USER (
			USER_NO BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
			, REG_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL <!-- 생성일 -->
			, UPDATE_DATE TIMESTAMP NOT NULL <!-- 수정일 -->
			, ENABLED BOOLEAN DEFAULT FALSE NOT NULL <!-- 사용 여부. T:사용, F:미사용 -->
			, ROLE VARCHAR(16) NOT NULL
			, UID UUID DEFAULT RANDOM_UUID() NOT NULL <!-- 고유 ID -->
			, PROVIDER VARCHAR(16) NOT NULL
			, ID VARCHAR(32) NOT NULL
			, EMAIL VARCHAR(128) DEFAULT NULL
			, NICKNAME VARCHAR(32) DEFAULT NULL
			, PROFILE_IMG_PATH VARCHAR(255) DEFAULT NULL
			, DESCRIPTION  VARCHAR(64) DEFAULT NULL
			, CONSTRAINT UK_USER_PROVIDER_ID UNIQUE (PROVIDER, ID)
			
			, CONSTRAINT UQ_MB_USER_ID UNIQUE (ID)
			, CONSTRAINT UQ_MB_USER_UID UNIQUE (UID)
		)
	</insert>
	
	<!-- 로그인 기록 -->
	<insert id="createLoginRecord">
		CREATE TABLE IF NOT EXISTS MB_USER_LOGIN_RECORD (
			REG_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
			, USER_NO BIGINT NOT NULL
			, IP VARCHAR(16) NOT NULL
			, DEVICE VARCHAR(16) NOT NULL
			, MODEL VARCHAR(32) DEFAULT NULL
			
			, CONSTRAINT FK_MB_USER_LOGIN_RECORD_USER_NO FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO)
		)
	</insert>

	<!--토픽 테이블 생성-->
	<insert id="createTopic">
		CREATE TABLE IF NOT EXISTS MB_TOPIC (
			TOPIC_NO BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
			, REG_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL <!-- 생성일 -->
			, UPDATE_DATE TIMESTAMP NOT NULL <!-- 수정일 -->
			, OWNER_NO BIGINT NOT NULL  <!-- 생성자 -->
			, ENABLED BOOLEAN DEFAULT FALSE NOT NULL <!-- 사용 여부. T:사용, F:미사용 -->
			, UID UUID DEFAULT RANDOM_UUID() NOT NULL <!-- 고유 ID -->
			, EXTERNAL BOOLEAN DEFAULT TRUE NOT NULL <!-- 공개 여부. T:공개, F:미공개 -->
			, EMOTION BOOLEAN DEFAULT TRUE NOT NULL <!-- 이모션 사용 여부. T:사용, F:미사용 -->
			, COMMENTS BOOLEAN DEFAULT TRUE NOT NULL <!-- 댓글 사용 여부. T:사용, F:미사용 -->
			, MAX_LEN SMALLINT DEFAULT 0 NOT NULL <!-- 글 최대 크기. 0은 무제한 --> 
			, NAME VARCHAR(36) NOT NULL
			, NAME_UPPER VARCHAR(36) NOT NULL <!-- 검색 대상용 --> 
			, DESCRIPTION VARCHAR(256) DEFAULT NULL
			, IMOGI VARCHAR(4) DEFAULT NULL
			, COLOR VARCHAR(16) DEFAULT NULL <!--선택: '#RRGGBB' 또는 'indigo' 등-->
			, EMOJI_SET_TYPE SMALLINT NOT NULL DEFAULT 1
			, AI BOOLEAN DEFAULT FALSE NOT NULL <!-- AI 사용 여부. T:사용, F:미사용 -->
			, PROMPT VARCHAR(104) DEFAULT NULL <!-- AI 프롬프트 -->
			
			, CONSTRAINT UQ_MB_TOPIC_UID UNIQUE (UID)
			, CONSTRAINT FK_MB_TOPIC_OWNER_USER_NO FOREIGN KEY (OWNER_NO) REFERENCES MB_USER(USER_NO)
		)
	</insert>
	
	<!-- Topic Follow 테이블 -->
	<insert id="createTopicFlow">
		CREATE TABLE IF NOT EXISTS MB_TOPIC_FOLLOW (
			USER_NO BIGINT NOT NULL
			, TOPIC_NO BIGINT NOT NULL
			, CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
	
			, PRIMARY KEY (USER_NO, TOPIC_NO)
			, CONSTRAINT FK_TOPIC_FOLLOW_USER FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO) ON DELETE CASCADE
			, CONSTRAINT FK_TOPIC_FOLLOW_TOPIC FOREIGN KEY (TOPIC_NO) REFERENCES MB_TOPIC(TOPIC_NO) ON DELETE CASCADE
		)
	</insert>
	
	<!-- Topic 통계 테이블 -->
	<insert id="createTopicStats">
		CREATE TABLE IF NOT EXISTS MB_TOPIC_STATS (
		    TOPIC_NO BIGINT PRIMARY KEY,
		    FOLLOW_COUNT BIGINT NOT NULL DEFAULT 0,
		    FRAGMENT_COUNT BIGINT NOT NULL DEFAULT 0,
		    COMMENT_COUNT BIGINT NOT NULL DEFAULT 0,
		    LAST_FRAGMENT_AT TIMESTAMP DEFAULT NULL,
		    UPDATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
		    
			CONSTRAINT FK_MB_TOPIC_STATS_TOPIC_NO FOREIGN KEY (TOPIC_NO) REFERENCES MB_TOPIC(TOPIC_NO) ON DELETE CASCADE
		)
	</insert>

	
	<!-- 게시판 -->
	<insert id="createFragment">
		CREATE TABLE IF NOT EXISTS MB_FRAGMENT (
			FRAGMENT_NO BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
			, REG_DATE TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP <!-- 생성일 -->
			, UPDATE_DATE TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP <!-- 수정일 --> 
			, USER_NO BIGINT NOT NULL <!-- 작성자 --> 
			, TOPIC_NO BIGINT NOT NULL <!-- 토픽 --> 
			, IS_DELETED BOOLEAN NOT NULL DEFAULT FALSE <!-- 삭제 여부 --> 
			, UID UUID NOT NULL DEFAULT RANDOM_UUID() <!-- 고유 ID -->
			, CONTENT CLOB NOT NULL
			, IP VARCHAR(40) DEFAULT NULL
			, DEVICE VARCHAR(16) DEFAULT NULL

			, CONSTRAINT UQ_MB_FRAGMENT_UID UNIQUE (UID)
			, CONSTRAINT FK_MB_FRAGMENT_USER_NO FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO) ON DELETE CASCADE
			, CONSTRAINT FK_MB_FRAGMENT_TOPIC_NO FOREIGN KEY (TOPIC_NO) REFERENCES MB_TOPIC(TOPIC_NO) ON DELETE CASCADE
		) 
	</insert>
	
	<!-- 댓글 -->
	<insert id="createFragmentComments">
		CREATE TABLE IF NOT EXISTS MB_FRAGMENT_COMMENTS (
			COMMENT_NO BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
			, REG_DATE TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
			, UPDATE_DATE TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
			, FRAGMENT_NO BIGINT NOT NULL
			, USER_NO BIGINT NOT NULL
			, IS_DELETED BOOLEAN NOT NULL DEFAULT FALSE
			, UID UUID NOT NULL DEFAULT RANDOM_UUID()
			, CONTENT CLOB NOT NULL
			, IP VARCHAR(40) DEFAULT NULL
			, DEVICE VARCHAR(16) DEFAULT NULL
			
			, CONSTRAINT UQ_MB_FRAGMENT_COMMENTS_UID UNIQUE (UID)
			, CONSTRAINT FK_MB_FRAGMENT_COMMENTS_FRAGMENT_NO FOREIGN KEY (FRAGMENT_NO) REFERENCES MB_FRAGMENT(FRAGMENT_NO) ON DELETE CASCADE
			, CONSTRAINT FK_MB_FRAGMENT_COMMENTS_USER_NO FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO) ON DELETE CASCADE
		)
	</insert>

	<!-- 스크랩(중복 방지: 1인 1글 1스크랩) -->
	<insert id="createFragmentScrap">
		CREATE TABLE IF NOT EXISTS MB_FRAGMENT_SCRAP (
			REG_DATE TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
			, UPDATE_DATE TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
			, USER_NO BIGINT NOT NULL
			, FRAGMENT_NO BIGINT NOT NULL
			
			, PRIMARY KEY (USER_NO, FRAGMENT_NO)
			, CONSTRAINT FK_MB_FRAGMENT_SCRAP_USER_NO FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO)
			, CONSTRAINT FK_MB_FRAGMENT_SCRAP_FRAGMENT_NO FOREIGN KEY (FRAGMENT_NO) REFERENCES MB_FRAGMENT(FRAGMENT_NO)
		)
	</insert>

	<!-- 이모지(리액션) 로그: 1인 1개만 가능(교체 가능) -->
	<insert id="createFragmentEmotionLog"> 
		CREATE TABLE IF NOT EXISTS MB_FRAGMENT_EMOTION_LOG (
			EMOTION_LOG_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
			, REG_DATE TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
			, UPDATE_DATE TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
			, USER_NO BIGINT NOT NULL
			, TARGET_TYPE SMALLINT NOT NULL <!-- 1: BOARD, 2: COMMENT --> 
			, TARGET_NO BIGINT NOT NULL
			, EMOTION VARCHAR(10) NOT NULL <!-- joy/pleasure/normal/sadness/anger 등 --> 
			
			, CONSTRAINT FK_MB_EMOLOG_USER_NO FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO)
			, CONSTRAINT UQ_MB_EMOLOG_ONE_PER_USER UNIQUE (USER_NO, TARGET_TYPE, TARGET_NO) 
		) 
	</insert>
	
	<insert id="createFragmentHashTag">
		CREATE TABLE IF NOT EXISTS MB_FRAGMENT_HASHTAG (
    		TAG_NO BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
    		, NAME VARCHAR(64) NOT NULL
    		
    		, CONSTRAINT UQ_MB_FRAGMENT_HASHTAG_NAME UNIQUE (NAME)
    	)
    </insert>
    
    <insert id="createFragmentHashTagRecord">
    	CREATE TABLE IF NOT EXISTS MB_FRAGMENT_HASHTAG_RECORD (
			TAG_NO BIGINT NOT NULL
			, FRAGMENT_NO BIGINT NOT NULL
			
			, PRIMARY KEY (TAG_NO, FRAGMENT_NO)
			, CONSTRAINT FK_MB_FRAGMENT_HASHTAG_RECORD_USER_NO FOREIGN KEY (TAG_NO) REFERENCES MB_FRAGMENT_HASHTAG(TAG_NO)
			, CONSTRAINT FK_MB_FRAGMENT_HASHTAG_RECORD_FRAGMENT_NO FOREIGN KEY (FRAGMENT_NO) REFERENCES MB_FRAGMENT(FRAGMENT_NO) ON DELETE CASCADE
		)
	</insert>
	
	<!-- 푸시 구독 정보 -->
	<insert id="createPushSubscriptionTable">
        CREATE TABLE IF NOT EXISTS MB_PUSH_SUB (
			SUB_NO BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
			, REG_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL <!-- 생성일 -->
			, UPDATE_DATE TIMESTAMP NOT NULL <!-- 수정일 -->
			, USER_NO BIGINT NOT NULL
			, END_POINT VARCHAR(512) NOT NULL
			, P256DH VARCHAR(128) NOT NULL
			, AUTH VARCHAR(64) NOT NULL
			, IS_ACTIVE BOOLEAN DEFAULT TRUE NOT NULL <!--구독이 만료/거절/410 Gone 등으로 죽었을 때 비활성화-->
			, DEVICE_ID VARCHAR(64) <!--동일 USER_NO가 여러 기기(PC/폰)로 구독하는 경우 구분-->
			, USER_AGENT VARCHAR(512) <!--문제 발생 시 분석( BROWSER / OS / USER_AGENT )-->
			, BROWSER VARCHAR(32)
			, OS VARCHAR(32)
			, LAST_PUSH_DATE TIMESTAMP DEFAULT NULL <!--마지막 발송 시간-->
			, FAIL_COUNT INT DEFAULT 0 NOT NULL  <!--실패 누적(예: 3회 이상이면 비활성)-->
			, EXPIRATION_TIME BIGINT DEFAULT NULL <!--브라우저가 주는 만료시간이 있는 경우 저장(대개 null)-->
			
			, CONSTRAINT FK_MB_PUSH_SUB_USER_NO FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO)
		);
    </insert>
    
	<!-- Share 테이블 -->
	<insert id="createShare">
		CREATE TABLE IF NOT EXISTS MB_SHARE (
		    SHARE_NO BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
		    , CREATE_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
		    , UID UUID NOT NULL DEFAULT RANDOM_UUID() <!-- 고유 ID -->
		    , USER_NO BIGINT DEFAULT 0
			, TARGET_TYPE SMALLINT NOT NULL -- 0:Topic, 1:Board, 2:Comment 
			, TARGET_NO BIGINT NOT NULL
			
			, CONSTRAINT UQ_MB_SHARE_UID UNIQUE (UID)
		)
	</insert>
	
	<!-- 기념일 -->
	<insert id="createHoliday">
		CREATE TABLE IF NOT EXISTS MB_HOLIDAY (
			HOLIDAY_NO BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
			HOLI_TYPE SMALLINT NOT NULL,
            LOC_DATE TIMESTAMP NOT NULL,
            HOLIDAY BOOLEAN NOT NULL,
            NAME VARCHAR(32) NOT NULL         
        )
	</insert>
	
	<!-- 알람 -->
	<insert id="createAlarm">
		CREATE TABLE IF NOT EXISTS MB_ALARM (
			ALARM_NO BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
			CREATE_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
			READ_AT TIMESTAMP DEFAULT NULL, <!-- 읽은 시간 -->
			ALARM_TYPE CHAR(1) NOT NULL, <!-- 알람 종류. I:정보, -->
		    USER_NO BIGINT NOT NULL,
		    ALARM VARCHAR(64) NOT NULL,

			CONSTRAINT FK_MB_ALARM_USER_NO FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO) ON DELETE CASCADE
		)
	</insert>


	<!-- 사용자 이미지 -->
	<update id="createUserProfile">
		CREATE TABLE IF NOT EXISTS MB_USER_PROFILE (
			USER_NO   BIGINT NOT NULL PRIMARY KEY,
			REG_DATE  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
			UPD_DATE  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
			MIME_TYPE VARCHAR(64),
			IMAGE     BLOB NOT NULL,
			CONSTRAINT FK_MB_USER_PROFILE_USER_NO FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO) ON DELETE CASCADE
		)
	</update>
	
	<!--Feedback-->
	<update id="createFeedback">
		CREATE TABLE IF NOT EXISTS MB_FEEDBACK (
			FEEDBACK_NO  BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
			REG_DATE  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
			UPD_DATE  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
		    CHECK_DATE TIMESTAMP DEFAULT NULL, <!-- 피드백 수신 일자 --> 
			USER_NO BIGINT NOT NULL, <!-- 작성자 -->
			FEEDBACK_TYPE CHAR(2), <!--EFeedbackType.  BG:오류 보고, FR:기능 제안, IM:성능/사용성 개선, GI:기타 문의. -->
		    TITLE VARCHAR(64) NOT NULL, <!-- 제목-->
		    CONTENT CLOB NOT NULL, <!-- 내용 -->
		    NEED_FEEDBACK BOOLEAN DEFAULT FALSE,  <!-- 피드백 수신 요청 여부 -->
			MIME_TYPE VARCHAR(64) DEFAULT NULL, 
			SUGGEST_FILE BLOB NOT NULL,

			CONSTRAINT FK_MB_FEEDBACK_USER_NO FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO)
		)
	</update>
	    
</mapper>
