<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.utime.memoBom.user.mapper.UserProfileMapper">

	<resultMap id="UserProfileMap" type="com.utime.memoBom.user.vo.query.UserProfile">
		<result column="MIME_TYPE" property="mimeType" />
		<result column="IMAGE" property="image" jdbcType="VARBINARY" />
	</resultMap>
	
	<!-- 단건 조회 (이미지 포함) -->
	<select id="selectUserProfile" parameterType="string" resultMap="UserProfileMap">
		SELECT
			MIME_TYPE, 
			IMAGE
		FROM MB_USER_PROFILE PR 
			INNER JOIN MB_USER US 
				ON PR.USER_NO = US.USER_NO 
		WHERE US.UID = #{uid}
	</select>

	<!-- 데이터 있나? -->
	<select id="existsUserProfileMeta" parameterType="long" resultType="boolean">
		SELECT 
			CASE COUNT(1) 
	   			WHEN 0 THEN 0
				ELSE 1
	   		END AS RES
		FROM MB_USER_PROFILE
		WHERE USER_NO = #{userNo}
	</select>

	<!-- 신규 저장 -->
	<insert id="insertUserProfile" parameterType="map">
		INSERT INTO MB_USER_PROFILE (USER_NO, MIME_TYPE, IMAGE)
		VALUES (#{userNo}, #{mimeType}, #{image, jdbcType=VARBINARY})
	</insert>

	<!-- 변경(업서트가 DB마다 달라서 update + exists 체크는 서비스에서 처리 권장) -->
	<update id="updateUserProfile" parameterType="map">
		UPDATE MB_USER_PROFILE
		SET
			MIME_TYPE = #{mimeType},
			IMAGE = #{image, jdbcType=VARBINARY},
			UPD_DATE = CURRENT_TIMESTAMP
		WHERE USER_NO = #{userNo}
	</update>

</mapper>
