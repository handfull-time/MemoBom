<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<!--//네임스페이스에는 mapper 가 있는 풀 패키지명과 매퍼명을 등록 한다. -->
<mapper namespace="com.utime.memoBom.user.mapper.UserMapper">

	<insert id="createUser">
		CREATE TABLE MB_USER (
			USER_NO BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
			, REG_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL <!-- 생성일 -->
			, UPDATE_DATE TIMESTAMP NOT NULL <!-- 수정일 -->
			, ENABLED BOOLEAN DEFAULT FALSE NOT NULL <!-- 사용 여부. T:사용, F:미사용 -->
			, ROLE VARCHAR(16) NOT NULL
			, UID UUID DEFAULT RANDOM_UUID() NOT NULL <!-- 고유 ID -->
			, PROVIDER VARCHAR(16) NOT NULL
			, ID VARCHAR(32) NOT NULL
			, EMAIL VARCHAR(128) DEFAULT NULL
			, NICKNAME VARCHAR(32) DEFAULT NULL
			, PROFILE_IMG_PATH VARCHAR(255) DEFAULT NULL
			, DESCRIPTION  VARCHAR(64) DEFAULT NULL
			, CONSTRAINT UK_USER_PROVIDER_ID UNIQUE (PROVIDER, ID)
		)
	</insert>
	
	<!-- 로그인 기록 -->
	<insert id="createLoginRecord">
		CREATE TABLE MB_USER_LOGIN_RECORD (
			REG_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
			, USER_NO BIGINT NOT NULL
			, IP VARCHAR(16) NOT NULL
			, DEVICE VARCHAR(16) NOT NULL
			, MODEL VARCHAR(32) DEFAULT NULL
		)
	</insert>
	
	<!-- 사용자 추가 -->
	<insert id="insertUser" parameterType="com.utime.memoBom.user.vo.UserVo" 
		useGeneratedKeys="true" keyProperty="userNo" >
		INSERT INTO MB_USER (
			UPDATE_DATE 
			, ENABLED
			, ROLE
			, PROVIDER
			, ID 
			<if test="email != null and ! email.isEmpty() ">, EMAIL </if>
			<if test="nickname != null and ! nickname.isEmpty() ">, NICKNAME </if>
			<if test="profileUrl != null and ! profileUrl.isEmpty() ">, PROFILE_IMG_PATH </if>
			<if test="note != null and ! note.isEmpty() ">, DESCRIPTION </if>
		) VALUES (
			CURRENT_TIMESTAMP
			, #{enabled}
			, #{role}
			, #{provider}
			, #{id}
			<if test="email != null and ! email.isEmpty() ">, #{email, typeHandler=com.utime.memoBom.common.typeHandler.SeedEncryptTypeHandler} </if>
			<if test="nickname != null and ! nickname.isEmpty() ">, #{nickname} </if>
			<if test="profileUrl != null and ! profileUrl.isEmpty() ">, #{profileUrl} </if>
			<if test="note != null and ! note.isEmpty() ">, #{dscr} </if>
		)
	</insert>
	
	<!-- 로그인 기록 추가 -->
	<insert id="insertLoginRecord" parameterType="map">
		INSERT INTO MB_USER_LOGIN_RECORD (
			USER_NO
			, IP
			, DEVICE
			<if test="device.model != null">
			, MODEL
			</if>
		) VALUES (
			#{user.userNo}
			, #{ip}
			, #{device.device}
			<if test="device.model != null ">
			, #{device.model}
			</if>
		)
	</insert>
	
	
	<sql id="UserColumn">
		USER_NO
		, REG_DATE
		, UPDATE_DATE
		, ENABLED 
		, UID
		, ROLE 
		, PROVIDER 
		, ID 
		, EMAIL
		, NICKNAME 
		, PROFILE_IMG_PATH 
		, DESCRIPTION
	</sql>
	
	<resultMap id="UserVoMap" type="com.utime.memoBom.user.vo.UserVo">
		<id column="USER_NO" property="userNo"/>
		<result column="REG_DATE" property="regDate"/>
		<result column="UPDATE_DATE" property="updateDate"/>
		<result column="ENABLED" property="enabled"/>
		<result column="ROLE" property="role"/>
		<result column="PROVIDER" property="provider"/>
		<result column="UID" property="uid"/>
		<result column="ID" property="id"/>
		<result column="EMAIL" property="email" typeHandler="com.utime.memoBom.common.typeHandler.SeedEncryptTypeHandler"/>
		<result column="NICKNAME" property="nickname"/>
		<result column="DESCRIPTION" property="note"/>
		<result column="PROFILE_IMG_PATH" property="profileUrl"/>
	</resultMap>
	
	<!-- id 조회 -->	
	<select id="selectUserFromIdAndProvider" parameterType="map" resultMap="UserVoMap">
		SELECT 
			<include refid="UserColumn" /> 
		FROM MB_USER UR 
		WHERE UR.ID = #{id} AND PROVIDER = #{provider}
	</select>

	<!--회원 정보 제거-->
	<update id="removeUser" parameterType="com.utime.memoBom.user.vo.UserVo" >
		UPDATE MB_USER SET 
			UPDATE_DATE = CURRENT_TIMESTAMP
			, ENABLED = FALSE
			, ROLE = '-'
			, PROVIDER = '-'
			, ID  = '${userNo}'
		WHERE USER_NO = ${userNo}
	</update>
	
</mapper>