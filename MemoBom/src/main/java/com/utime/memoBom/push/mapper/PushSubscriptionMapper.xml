<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<!--//네임스페이스에는 mapper 가 있는 풀 패키지명과 매퍼명을 등록 한다. -->
<mapper namespace="com.utime.memoBom.push.mapper.PushSubscriptionMapper">

	<!-- Key-Value 테이블 생성 -->
	<insert id="createPushSubscriptionTable">
        CREATE TABLE MB_PUSH_SUB (
			SUB_NO BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
			, REG_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL <!-- 생성일 -->
			, UPDATE_DATE TIMESTAMP NOT NULL <!-- 수정일 -->
			, USER_NO BIGINT NOT NULL
			, END_POINT VARCHAR(512) NOT NULL
			, P256DH VARCHAR(128) NOT NULL
			, AUTH VARCHAR(64) NOT NULL
		);
    </insert>
	
	<!-- endpont 매칭 조회 -->
	<select id="findByEndpoint" parameterType="map" resultType="com.utime.memoBom.push.vo.PushSubscriptionEntity">
		SELECT 
			SUB_NO
			, USER_NO 
			, END_POINT 
			, P256DH
			, AUTH
		FROM MB_PUSH_SUB
		WHERE END_POINT = #{endPoint}
	</select>	

	<!-- 구독 정보 추가 -->
	<insert id="insertSubscription" parameterType="com.utime.memoBom.push.vo.PushSubscriptionEntity" 
		useGeneratedKeys="true" keyProperty="subNo" >
		INSERT INTO MB_PUSH_SUB (
			UPDATE_DATE
			, USER_NO
			, END_POINT
			, P256DH
			, AUTH
		) VALUES (
			CURRENT_TIMESTAMP
			, #{userNo}
			, #{endPoint}
			, #{p256dh}
			, #{auth}
		)
	</insert>
	
    <!-- 구독 정보 수정 -->
	<update id="updateSubscription" parameterType="com.utime.memoBom.push.vo.PushSubscriptionEntity" >
		UPDATE MB_PUSH_SUB SET
			UPDATE_DATE = CURRENT_TIMESTAMP
			, END_POINT
			, P256DH
			, AUTH
		WHERE SUB_NO = #{subNo}
	</update>

    <!-- 구독 정보 제거 -->
	<delete id="removeSubscription" parameterType="com.utime.memoBom.push.vo.PushSubscriptionEntity" >
		DELETE FROM MB_PUSH_SUB 
		WHERE SUB_NO = #{subNo}
	</delete>
	
	<!-- endpont 매칭 조회 -->
	<select id="findAllByUser" parameterType="com.utime.memoBom.user.vo.UserVo" resultType="com.utime.memoBom.push.vo.PushSubscriptionEntity">
		SELECT 
			SUB_NO
			, USER_NO 
			, END_POINT 
			, P256DH
			, AUTH
		FROM MB_PUSH_SUB
		WHERE USER_NO = {userNo}
		ORDER BY REG_DATE
	</select>
</mapper>
