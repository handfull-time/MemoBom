<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<!--//네임스페이스에는 mapper 가 있는 풀 패키지명과 매퍼명을 등록 한다. -->
<mapper namespace="com.utime.memoBom.push.mapper.PushSubscriptionMapper">
	
	<resultMap id="PushSubMap" type="com.utime.memoBom.push.dto.PushSubscriptionDto">
	    <id column="SUB_NO" property="subNo"/>
	    <result column="REG_DATE" property="regDate"/>
	    <result column="UPDATE_DATE" property="updateDate"/>
	    <result column="USER_NO" property="userNo"/>
	    <result column="END_POINT" property="endPoint"/>
	    <result column="P256DH" property="p256dh"/>
	    <result column="AUTH" property="auth"/>
	
	    <result column="IS_ACTIVE" property="isActive"/>
	    <result column="DEVICE_ID" property="deviceId"/>
	    <result column="USER_AGENT" property="userAgent"/>
	    <result column="BROWSER" property="browser"/>
	    <result column="OS" property="os"/>
	    <result column="LAST_PUSH_DATE" property="lastPushDate"/>
	    <result column="FAIL_COUNT" property="failCount"/>
	    <result column="EXPIRATION_TIME" property="expirationTime"/>
	</resultMap>
  
	<!-- endpont 매칭 조회 -->
	<select id="findByEndpoint" parameterType="map" resultType="com.utime.memoBom.push.vo.PushSubscriptionEntity">
		SELECT 
			SUB_NO
			, USER_NO 
			, END_POINT 
			, P256DH
			, AUTH
		FROM MB_PUSH_SUB
		WHERE END_POINT = #{endPoint}
	</select>	

	<!-- 구독 정보 추가 -->
	<insert id="insertSubscription" parameterType="com.utime.memoBom.push.vo.PushSubscriptionEntity" 
		useGeneratedKeys="true" keyProperty="subNo" >
		INSERT INTO MB_PUSH_SUB (
			UPDATE_DATE
			, USER_NO
			, END_POINT
			, P256DH
			, AUTH
		) VALUES (
			CURRENT_TIMESTAMP
			, #{userNo}
			, #{endPoint}
			, #{p256dh}
			, #{auth}
		)
	</insert>
	
    <!-- 구독 정보 수정 -->
	<update id="updateSubscription" parameterType="com.utime.memoBom.push.vo.PushSubscriptionEntity" >
		UPDATE MB_PUSH_SUB SET
			UPDATE_DATE = CURRENT_TIMESTAMP
			, END_POINT
			, P256DH
			, AUTH
		WHERE SUB_NO = #{subNo}
	</update>

    <!-- 구독 정보 제거 -->
	<delete id="removeSubscription" parameterType="com.utime.memoBom.push.vo.PushSubscriptionEntity" >
		DELETE FROM MB_PUSH_SUB 
		WHERE SUB_NO = #{subNo}
	</delete>
	
	<!-- endpont 매칭 조회 -->
	<select id="findAllByUser" parameterType="com.utime.memoBom.user.vo.UserVo" resultType="com.utime.memoBom.push.vo.PushSubscriptionEntity">
		SELECT 
			SUB_NO
			, USER_NO 
			, END_POINT 
			, P256DH
			, AUTH
		FROM MB_PUSH_SUB
		WHERE USER_NO = {userNo}
		ORDER BY REG_DATE
	</select>
</mapper>
