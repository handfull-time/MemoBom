<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.utime.memoBom.board.mapper.BoardMapper">

	<!-- 게시판 -->
  <update id="createMemoBoard">
    CREATE TABLE IF NOT EXISTS MB_MEMO_BOARD (
      BOARD_NO    BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      REG_DATE    TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,  <!-- 생성일 -->
      UPDATE_DATE TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,  <!-- 수정일 -->
      USER_NO     BIGINT NOT NULL,                               <!-- 작성자 -->
      TOPIC_NO    BIGINT NOT NULL,                               <!-- 토픽 -->
      IS_DELETED  BOOLEAN NOT NULL DEFAULT FALSE,                <!-- 삭제 여부 -->
      UID         UUID NOT NULL DEFAULT RANDOM_UUID(),           <!-- 고유 ID -->
      MEMO        CLOB NOT NULL,
      HASH_KEYWORD VARCHAR(256) DEFAULT NULL,

      CONSTRAINT UQ_MB_MEMO_BOARD_UID UNIQUE (UID),
      CONSTRAINT FK_MB_BOARD_USER_NO FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO),
      CONSTRAINT FK_MB_BOARD_TOPIC_NO FOREIGN KEY (TOPIC_NO) REFERENCES MB_TOPIC(TOPIC_NO)
    )
  </update>

	<!-- 댓글 -->
  <update id="createMemoComments">
    CREATE TABLE IF NOT EXISTS MB_MEMO_COMMENTS (
      COMMENT_NO  BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      REG_DATE    TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      UPDATE_DATE TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      BOARD_NO    BIGINT NOT NULL,
      USER_NO     BIGINT NOT NULL,
      CONTENT     CLOB NOT NULL,
      IS_DELETED  BOOLEAN NOT NULL DEFAULT FALSE,

      CONSTRAINT FK_MB_COMMENT_BOARD FOREIGN KEY (BOARD_NO) REFERENCES MB_MEMO_BOARD(BOARD_NO),
      CONSTRAINT FK_MB_COMMENT_USER  FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO)
    )
  </update>

	<!-- 스크랩(중복 방지: 1인 1글 1스크랩) -->
  <update id="createMemoScrap">
    CREATE TABLE IF NOT EXISTS MB_MEMO_SCRAP (
      REG_DATE    TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      UPDATE_DATE TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      USER_NO     BIGINT NOT NULL,
      BOARD_NO    BIGINT NOT NULL,

      PRIMARY KEY (USER_NO, BOARD_NO),
      CONSTRAINT FK_MB_SCRAP_USER  FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO),
      CONSTRAINT FK_MB_SCRAP_BOARD FOREIGN KEY (BOARD_NO) REFERENCES MB_MEMO_BOARD(BOARD_NO)
    )
  </update>

	<!-- 이모지(리액션) 로그: 1인 1개만 가능(교체 가능) -->
  <update id="createMemoEmotionLog">
    CREATE TABLE IF NOT EXISTS MB_MEMO_EMOTION_LOG (
      EMOTION_LOG_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      REG_DATE       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      UPDATE_DATE    TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      USER_NO        BIGINT NOT NULL,

      TARGET_TYPE    SMALLINT NOT NULL,   <!-- 1: BOARD, 2: COMMENT -->
      TARGET_NO      BIGINT NOT NULL,

      EMOTION        VARCHAR(10) NOT NULL, <!-- joy/pleasure/normal/sadness/anger 등 -->

      CONSTRAINT FK_MB_EMOLOG_USER FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO),
      CONSTRAINT UQ_MB_EMOLOG_ONE_PER_USER UNIQUE (USER_NO, TARGET_TYPE, TARGET_NO)
    )
  </update>

  <update id="upsertEmotion">
    MERGE INTO MB_MEMO_EMOTION_LOG (
		USER_NO, TARGET_TYPE, TARGET_NO, EMOTION, UPDATE_DATE
	) KEY (
		USER_NO, TARGET_TYPE, TARGET_NO
	) VALUES (
		#{userNo}, #{targetType}, #{targetNo}, #{emotion}, CURRENT_TIMESTAMP
	)
  </update>

	<!-- 리액션 삭제(해제) -->
  <delete id="deleteEmotion">
    DELETE FROM MB_MEMO_EMOTION_LOG
    WHERE USER_NO = #{userNo}
      AND TARGET_TYPE = #{targetType}
      AND TARGET_NO = #{targetNo}
  </delete>

	<!-- 대상(게시글/댓글)별 리액션 카운트 -->
  <select id="selectEmotionCountsByTarget" resultType="map">
    SELECT EMOTION, COUNT(*) AS CNT
    FROM MB_MEMO_EMOTION_LOG
    WHERE TARGET_TYPE = #{targetType}
      AND TARGET_NO = #{targetNo}
    GROUP BY EMOTION
  </select>

	<!-- 내가 누른 리액션(1개) -->
  <select id="selectMyEmotion" resultType="string">
    SELECT EMOTION
    FROM MB_MEMO_EMOTION_LOG
    WHERE USER_NO = #{userNo}
      AND TARGET_TYPE = #{targetType}
      AND TARGET_NO = #{targetNo}
  </select>

</mapper>
