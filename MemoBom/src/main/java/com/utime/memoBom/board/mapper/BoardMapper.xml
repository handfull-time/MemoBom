<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.utime.memoBom.board.mapper.BoardMapper">

	<insert id="insertFragment" parameterType="map"
		useGeneratedKeys="true" keyProperty="req.fragmentNo">
		INSERT INTO MB_FRAGMENT ( 
			USER_NO 
			, TOPIC_NO 
			, CONTENT 
			<if test="req.ip != null and ! req.ip.isEmpty()">, IP </if>
			<if test="device.device != null">, DEVICE</if> 
		)VALUES ( 
			#{user.userNo} 
			, #{topic.topicNo} 
			, #{req.content} 
			<if test="req.ip != null and ! req.ip.isEmpty()">, #{req.ip} </if>
			<if test="device.device != null ">, #{device.device}</if> 
		) 
	</insert>


	<!-- 해시태그: 있으면 아무것도 안 하고, 없으면 생성 -->
	<update id="mergeFragmentHashTag" parameterType="map">
		MERGE INTO MB_FRAGMENT_HASHTAG (NAME)
		KEY (NAME)
		VALUES (#{name})
	</update>
	
	
	<!-- 대상(게시글/댓글)별 리액션 카운트 -->
	<select id="selectEmotionCountsByTarget" resultType="map">
		SELECT 
			EMOTION, COUNT(*) AS CNT
		FROM MB_FRAGMENT_EMOTION_LOG
		WHERE 1=1
			AND TARGET_TYPE = #{targetType}
			AND TARGET_NO = #{targetNo}
		GROUP BY EMOTION
	</select>
	
	<!-- 내가 누른 리액션(1개) -->
	<select id="selectMyEmotion" resultType="string">
		SELECT EMOTION
		FROM MB_FRAGMENT_EMOTION_LOG
		WHERE 1=1
			AND USER_NO = #{userNo}
			AND TARGET_TYPE = #{targetType}
			AND TARGET_NO = #{targetNo}
  </select>
  
  
  <resultMap id="FragmentItemMap" type="com.utime.memoBom.board.vo.FragmentItem">
        <id property="uid" column="fragment_uid" />
        <result property="content" column="content" />
        <result property="regDate" column="reg_date" />
        <result property="scrap" column="is_scrap" /> 
        
        <association property="user" javaType="com.utime.memoBom.user.vo.UserVo">
            <result property="uid" column="user_uid" />
            <result property="nickname" column="user_nickname" />
            <result property="profileUrl" column="user_img_url" />
        </association>
        
        <association property="topic" javaType="com.utime.memoBom.board.vo.TopicVo">
            <result property="uid" column="topic_uid" />
            <result property="name" column="topic_name" />
            <result property="color" column="topic_color" />
            <result property="imogi" column="topic_imogi" />
            <result property="imogi" column="topic_imogi" />
            <result property="emojiSetType" column="emoji_set_type" 
            	typeHandler="com.utime.memoBom.board.typeHandler.EmojiSetTypeHandler"/>
        </association>
        
        <collection property="hashtagList"
            ofType="string"
            column="fragment_uid"
            select="selectHashtagListByFragmentUid" />
            
        <collection property="emotionList"
            ofType="com.utime.memoBom.board.vo.EmotionItem"
            column="fragment_uid"
            select="selectEmotionListByFragmentUid" />

    </resultMap>

	<!-- 해시테그 목록  -->    
    <select id="selectHashtagListByFragmentUid" parameterType="string" resultType="string">
	    SELECT h.NAME
	    FROM MB_FRAGMENT_HASHTAG h
		    INNER JOIN MB_FRAGMENT_HASHTAG_RECORD r
		        ON r.TAG_NO = h.TAG_NO
		    INNER JOIN MB_FRAGMENT f
		        ON f.FRAGMENT_NO = r.FRAGMENT_NO
	    WHERE f.UID = #{fragmentUid}
	    ORDER BY h.NAME
	</select>
	
	<!-- 감정(리액션) 목록  -->
	<select id="selectEmotionListByFragmentUid" parameterType="string" resultType="com.utime.memoBom.board.vo.EmotionItem">
	    SELECT
	        EMOTION          AS emotion,
	        COUNT(*)         AS count
	    FROM MB_FRAGMENT_EMOTION_LOG
	    WHERE 1=1
	    	AND TARGET_TYPE = 1
	    	AND TARGET_NO = (
				SELECT 
					FRAGMENT_NO
				FROM MB_FRAGMENT
				WHERE UID = #{fragmentUid}
	      )
	    GROUP BY EMOTION
	</select>

    <select id="loadFragmentList" parameterType="map" resultMap="FragmentItemMap">
        SELECT 
            f.UID           AS fragment_uid,
            f.CONTENT       AS content,
            f.REG_DATE      AS reg_date,
            <!-- 작성자 정보 -->
            u.UID           AS user_uid,
            u.NICKNAME      AS user_nickname,
            u.PROFILE_IMG_PATH AS user_img_url,
            <!-- 토픽 정보 -->
            t.UID           AS topic_uid,
            t.NAME	 		AS topic_name,
            t.COLOR         AS topic_color,
            t.IMOGI 		AS topic_imogi,
            t.EMOJI_SET_TYPE AS emoji_set_type,
            <!-- [변경됨] 스크랩 여부 판별 로직 -->
            <choose>
                <when test="user != null ">
                    CASE 
                        WHEN EXISTS (
                            SELECT 1 
                            FROM MB_FRAGMENT_SCRAP fs
                            INNER JOIN MB_USER viewer ON fs.USER_NO = viewer.USER_NO
                            WHERE fs.FRAGMENT_NO = f.FRAGMENT_NO 
                            AND viewer.USER_NO = #{user.userNo}
                        ) THEN TRUE 
                        ELSE FALSE 
                    END
                </when>
                <otherwise>
                    FALSE
                </otherwise>
            </choose> AS is_scrap

        FROM MB_FRAGMENT f
        INNER JOIN MB_USER u ON f.USER_NO = u.USER_NO
        INNER JOIN MB_TOPIC t ON f.TOPIC_NO = t.TOPIC_NO
        <if test="user != null ">
        	INNER JOIN MB_TOPIC_FOLLOW l ON l.TOPIC_NO = t.TOPIC_NO AND l.USER_NO = #{user.userNo}  
        </if>
        WHERE 1=1
            <!-- 기본 조건 -->
            AND f.IS_DELETED = FALSE
            AND u.ENABLED = TRUE
            AND t.ENABLED = TRUE

	        <if test="user != null ">
	        	OR t.EXTERNAL = TRUE
	        </if>

            <!-- 필터: 작성자 -->
            <if test="req.userUid != null and !req.userUid.isEmpty() ">
                AND u.UID = #{req.userUid}
            </if>
            
            <!-- 필터: 토픽 -->
            <if test="req.topicUid != null and !req.topicUid.isEmpty() ">
                AND t.UID = #{req.topicUid}
            </if>
            
            <!-- 필터: 키워드 검색 -->
            <if test="req.keyword != null and !req.keyword.isEmpty() ">
                AND f.CONTENT LIKE CONCAT('%', #{req.keyword}, '%')
            </if>

            <!-- 필터: 해시태그 -->
			<if test="req.hashtag != null and !req.hashtag.isEmpty()">
			  AND EXISTS (
			      SELECT 1
			      FROM MB_FRAGMENT_HASHTAG_RECORD r
			      	INNER JOIN MB_FRAGMENT_HASHTAG h ON h.TAG_NO = r.TAG_NO
			      WHERE r.FRAGMENT_NO = f.FRAGMENT_NO
			        AND h.NAME = #{req.hashtag}
			  )
			</if>

        ORDER BY f.REG_DATE DESC
        <!-- 페이징 (페이지당 5개) -->
        LIMIT 5 OFFSET (#{req.pageNo} - 1) * 5
    </select>
    
    <!--스크랩 존재 여부 확인  -->
    <select id="existsScrap" resultType="boolean">
    	SELECT 
			CASE COUNT(1) 
	   			WHEN 0 THEN 0
				ELSE 1
	   		END AS RES
	   	FROM MB_FRAGMENT_SCRAP
	   	WHERE 1=1	
	   	    AND USER_NO = #{userNo}
            AND FRAGMENT_NO = (
                SELECT FRAGMENT_NO FROM MB_FRAGMENT WHERE UID = #{fUid}
            )
    </select>
    
	<!--스크랩 삭제  -->
	<delete id="deleteScrap">
        DELETE FROM MB_FRAGMENT_SCRAP
        WHERE 1=1
            AND USER_NO = #{userNo}
            AND FRAGMENT_NO = (
                SELECT FRAGMENT_NO FROM MB_FRAGMENT WHERE UID = #{fUid}
            )
    </delete>
	
	<!--스크랩 추가  -->
	<insert id="insertScrap" parameterType="map">
        INSERT INTO MB_FRAGMENT_SCRAP (
            USER_NO,
            FRAGMENT_NO
        ) VALUES (
            #{userNo},
            (SELECT FRAGMENT_NO FROM MB_FRAGMENT WHERE UID = #{fUid})
        )
    </insert>
    
    <select id="selectFragmentContentPreview" resultType="string">
	    SELECT
	        CASE
	            WHEN LENGTH(CAST(CONTENT AS VARCHAR)) > 64
	            THEN SUBSTRING(CAST(CONTENT AS VARCHAR), 1, 64) || '...'
	            ELSE CAST(CONTENT AS VARCHAR)
	        END
	    FROM MB_FRAGMENT
	    WHERE UID = #{uid}
	</select>

	<!--공유 정보 삽입-->
	<insert id="insertShareInfo" parameterType="map">
        INSERT INTO MB_SHARE (
            FRAGMENT_NO,
            USER_NO
        ) VALUES (
            (
                SELECT FRAGMENT_NO FROM MB_FRAGMENT WHERE UID = #{fUid}
            )
            #{userNo}s
        )
    </insert>
    
    <sql id="getTargetNoSql">
	 	(<choose>
			<when test="req.targetType.name() == 'Board'">
				SELECT FRAGMENT_NO FROM MB_FRAGMENT WHERE UID = #{req.uid}
			</when>
			<otherwise>
				SELECT COMMENT_NO FROM MB_FRAGMENT_COMMENT WHERE UID = #{req.uid}
			</otherwise>
	    </choose>)
	</sql>
    
	<!-- 감정 표현 삭제(해제) -->
	<delete id="deleteEmotion" parameterType="map">
		DELETE FROM MB_FRAGMENT_EMOTION_LOG
		WHERE 1=1
			AND USER_NO = #{userNo}
			AND TARGET_TYPE = #{req.targetType, typeHandler=com.utime.memoBom.board.typeHandler.EmotionTargetTypeHandler}
			AND TARGET_NO = <include refid="getTargetNoSql" />
			AND EMOTION = #{req.emotion, typeHandler=com.utime.memoBom.board.typeHandler.EmotionCodeTypeHandler}
	</delete>
	
	<update id="upsertEmotion" parameterType="map">
		MERGE INTO MB_FRAGMENT_EMOTION_LOG (
			USER_NO
			, TARGET_TYPE
			, TARGET_NO
			, EMOTION
			, UPDATE_DATE
		) KEY (USER_NO, TARGET_TYPE, TARGET_NO)
		VALUES (
			#{userNo}
			, #{req.targetType, typeHandler=com.utime.memoBom.board.typeHandler.EmotionTargetTypeHandler}
			, <include refid="getTargetNoSql" />
			, #{req.emotion, typeHandler=com.utime.memoBom.board.typeHandler.EmotionCodeTypeHandler}
			, CURRENT_TIMESTAMP
		)
</update>


</mapper>