<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.utime.memoBom.board.mapper.BoardMapper">

	<insert id="insertFragment" parameterType="map"
		useGeneratedKeys="true" keyProperty="req.fragmentNo">
		INSERT INTO MB_FRAGMENT ( 
			USER_NO 
			, TOPIC_NO 
			, CONTENT 
			<if test="req.ip != null and ! req.ip.isEmpty()">, IP </if>
			<if test="device.device != null">, DEVICE</if> 
		)VALUES ( 
			#{user.userNo} 
			, #{topic.topicNo} 
			, #{req.content} 
			<if test="req.ip != null and ! req.ip.isEmpty()">, #{req.ip} </if>
			<if test="device.device != null ">, #{device.device}</if> 
		) 
	</insert>


	<!-- 해시태그: 있으면 아무것도 안 하고, 없으면 생성 -->
	<update id="mergeFragmentHashTag" parameterType="map">
		MERGE INTO MB_FRAGMENT_HASHTAG (NAME)
		KEY (NAME)
		VALUES (#{name})
	</update>
	
	<update id="mergeFragmentHashTagRecordByName" parameterType="map">
		MERGE INTO MB_FRAGMENT_HASHTAG_RECORD (TAG_NO, FRAGMENT_NO)
		KEY (TAG_NO, FRAGMENT_NO)
		VALUES (
			(SELECT TAG_NO FROM MB_FRAGMENT_HASHTAG WHERE NAME = #{name})
			, #{fragmentNo}
		)
	</update>
	
	<update id="upsertEmotion">
		MERGE INTO MB_FRAGMENT_EMOTION_LOG (
			USER_NO, TARGET_TYPE, TARGET_NO, EMOTION, UPDATE_DATE
		) KEY ( USER_NO, TARGET_TYPE, TARGET_NO ) 
		VALUES (
			#{userNo}, #{targetType}, #{targetNo}, #{emotion}, CURRENT_TIMESTAMP
		)
	</update>
	
	<!-- 리액션 삭제(해제) -->
	<delete id="deleteEmotion">
		DELETE FROM MB_FRAGMENT_EMOTION_LOG
		WHERE 1=1
			AND USER_NO = #{userNo}
			AND TARGET_TYPE = #{targetType}
			AND TARGET_NO = #{targetNo}
	</delete>
	
	<!-- 대상(게시글/댓글)별 리액션 카운트 -->
	<select id="selectEmotionCountsByTarget" resultType="map">
		SELECT 
			EMOTION, COUNT(*) AS CNT
		FROM MB_FRAGMENT_EMOTION_LOG
		WHERE 1=1
			AND TARGET_TYPE = #{targetType}
			AND TARGET_NO = #{targetNo}
		GROUP BY EMOTION
	</select>
	
	<!-- 내가 누른 리액션(1개) -->
	<select id="selectMyEmotion" resultType="string">
		SELECT EMOTION
		FROM MB_FRAGMENT_EMOTION_LOG
		WHERE 1=1
			AND USER_NO = #{userNo}
			AND TARGET_TYPE = #{targetType}
			AND TARGET_NO = #{targetNo}
  </select>
  
  
  <resultMap id="FragmentItemMap" type="com.utime.memoBom.board.vo.FragmentItem">
        <id property="uid" column="fragment_uid" />
        <result property="content" column="content" />
        <result property="regDate" column="reg_date" />
        <result property="scrap" column="is_scrap" /> 
        
        <association property="user" javaType="com.utime.memoBom.user.vo.UserVo">
            <result property="uid" column="user_uid" />
            <result property="nickName" column="user_nickname" />
        </association>
        
        <association property="topic" javaType="com.utime.memoBom.board.vo.TopicVo">
            <result property="uid" column="topic_uid" />
            <result property="color" column="topic_color" />
            <result property="imogi" column="topic_imogi" />
        </association>
    </resultMap>

    <select id="loadList" parameterType="map" resultMap="FragmentItemMap">
        SELECT 
            f.UID           AS fragment_uid,
            f.CONTENT       AS content,
            f.REG_DATE      AS reg_date,
            
            <!-- 작성자 정보 -->
            u.UID           AS user_uid,
            u.NICKNAME      AS user_nickname,
            
            <!-- 토픽 정보 -->
            t.UID           AS topic_uid,
            t.COLOR         AS topic_color,
            t.IMOGI 		AS topic_imogi,
            
            <!-- [변경됨] 스크랩 여부 판별 로직 -->
            <choose>
                <when test="user != null ">
                    CASE 
                        WHEN EXISTS (
                            SELECT 1 
                            FROM MB_FRAGMENT_SCRAP fs
                            INNER JOIN MB_USER viewer ON fs.USER_NO = viewer.USER_NO
                            WHERE fs.FRAGMENT_NO = f.FRAGMENT_NO 
                            AND viewer.USER_NO = #{user.userNo}
                        ) THEN TRUE 
                        ELSE FALSE 
                    END
                </when>
                <otherwise>
                    FALSE
                </otherwise>
            </choose> AS is_scrap

        FROM MB_FRAGMENT f
        INNER JOIN MB_USER u ON f.USER_NO = u.USER_NO
        INNER JOIN MB_TOPIC t ON f.TOPIC_NO = t.TOPIC_NO
        <if test="user != null ">
        	INNER JOIN MB_TOPIC_FOLLOW l ON l.TOPIC_NO = t.TOPIC_NO AND l.USER_NO = #{user.userNo}  
        </if>
        WHERE 1=1
        <where>
            <!-- 기본 조건 -->
            AND f.IS_DELETED = FALSE
            AND u.ENABLED = TRUE
            AND t.ENABLED = TRUE

	        <if test="user != null ">
	        	OR t.EXTERNAL = TRUE
	        </if>

            <!-- 필터: 작성자 -->
            <if test="userUid != null and ! userUid.isEmpty() ">
                AND u.UID = #{userUid}
            </if>
            
            <!-- 필터: 토픽 -->
            <if test="topicUid != null and ! topicUid.isEmpty() ">
                AND t.UID = #{topicUid}
            </if>
            
            <!-- 필터: 키워드 검색 -->
            <if test="keyword != null and ! keyword.isEmpty() ">
                AND f.CONTENT LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
        
        ORDER BY f.REG_DATE DESC
        
        <!-- 페이징 (페이지당 5개) -->
        LIMIT 5 OFFSET (#{pageNo} - 1) * 5
    </select>

</mapper>