<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<!--//네임스페이스에는 mapper 가 있는 풀 패키지명과 매퍼명을 등록 한다. -->
<mapper namespace="com.utime.memoBom.board.mapper.TopicMapper">
	
	<!--팔로우 한 topic이 있나?-->
	<select id="hasTopic" parameterType="com.utime.memoBom.user.vo.UserVo" resultType="boolean">
		SELECT 
			CASE COUNT(1) 
	   			WHEN 0 THEN 0
				ELSE 1
	   		END AS RES
	   	FROM MB_TOPIC_FOLLOW FL
	   		INNER JOIN MB_TOPIC TP ON FL.TOPIC_NO = TP.TOPIC_NO
	   	WHERE TP.ENABLED = TRUE AND FL.USER_NO = #{userNo}
	</select>
	
	<!-- topic이 있나?-->
	<select id="isEmpty" parameterType="map" resultType="boolean">
		SELECT 
			CASE COUNT(1) 
	   			WHEN 0 THEN 1
				ELSE 0
	   		END AS RES
	   	FROM MB_TOPIC
	   	WHERE ENABLED = TRUE 
	</select>
	
	
	<!--동일 이름 있는지 검사.-->
	<select id="checkSameName" parameterType="map" resultType="boolean">
		SELECT 
			CASE COUNT(1) 
	   			WHEN 0 THEN 0
				ELSE 1
	   		END AS RES
	   	FROM MB_TOPIC
	   	WHERE 1=1
	   		AND NAME_UPPER = UPPER(#{name})
	   		<if test="uid != null and ! uid.isEmpty()">
       			AND UID != #{uid}
	   		</if>
	</select>
	
	<insert id="insertTopic" parameterType="com.utime.memoBom.board.vo.TopicVo"
	    useGeneratedKeys="true" keyProperty="topicNo" >
		INSERT INTO MB_TOPIC (
			UPDATE_DATE 
			, OWNER_NO
			, ENABLED 
			, EXTERNAL
			, EMOTION
			, COMMENTS
			, MAX_LEN
			, NAME 
			, NAME_UPPER 
			<if test="description != null and ! description.isEmpty()">, DESCRIPTION</if>
			<if test="imogi != null and ! imogi.isEmpty()">, IMOGI</if>
			<if test="color != null and ! color.isEmpty()">, COLOR</if>
			, EMOJI_SET_TYPE
			, AI
			<if test="prompt != null and ! prompt.isEmpty()">, PROMPT</if>
		) VALUES (
			CURRENT_TIMESTAMP
			, #{ownerNo}
			, TRUE
			, #{external}
			, #{emotion}
			, #{comments}
			, #{maxLen}
			, #{name}
			, UPPER(#{name})
			<if test="description != null and ! description.isEmpty()">, #{description}</if>
			<if test="imogi != null and ! imogi.isEmpty()">, #{imogi}</if>
			<if test="color != null and ! color.isEmpty()">, #{color}</if>
			, #{emojiSetType, typeHandler=com.utime.memoBom.board.typeHandler.EmojiSetTypeHandler}
			, #{ai}
			<if test="prompt != null and ! prompt.isEmpty()">, #{prompt}</if>
		)
	</insert>
	
	<!--topic 수정-->
	<update id="updateTopic" parameterType="com.utime.memoBom.board.vo.TopicVo">
		UPDATE MB_TOPIC SET
			UPDATE_DATE = CURRENT_TIMESTAMP
			, ENABLED = #{enabled}
			, EXTERNAL = #{external}
			, EMOTION = #{emotion}
			, COMMENTS = #{comments}
			, MAX_LEN = #{maxLen}
			, NAME = #{name}
			, NAME_UPPER = UPPER(#{name})
			, DESCRIPTION = <choose> <when test="description != null and ! description.isEmpty()">#{description}</when> <otherwise>NULL</otherwise> </choose>
			, IMOGI = <choose> <when test="imogi != null and ! imogi.isEmpty()">#{imogi}</when> <otherwise>NULL</otherwise> </choose>
			, COLOR = <choose> <when test="color != null and ! color.isEmpty()">#{color}</when> <otherwise>NULL</otherwise> </choose>
			, EMOJI_SET_TYPE = #{emojiSetType, typeHandler=com.utime.memoBom.board.typeHandler.EmojiSetTypeHandler}
			, AI = #{ai}
			, PROMPT = <choose> <when test="prompt != null and ! prompt.isEmpty()">#{prompt}</when> <otherwise>NULL</otherwise> </choose>
		WHERE UID = #{uid} AND OWNER_NO = #{ownerNo}
	</update>

	<sql id="TopicColumnSql">
	 	TP.TOPIC_NO
		, TP.ENABLED 
		, TP.OWNER_NO
		, CAST(TP.UID AS VARCHAR) AS UID 
		, TP.EXTERNAL
		, TP.EMOTION
		, TP.COMMENTS
		, TP.MAX_LEN
		, TP.NAME
		, TP.DESCRIPTION 
		, TP.IMOGI 
		, TP.COLOR 
		, TP.EMOJI_SET_TYPE
		, TP.AI
		, TP.PROMPT
	</sql>
	
	<resultMap id="TopicMap" type="com.utime.memoBom.board.vo.TopicVo">
        <id property="topicNo" column="TOPIC_NO" />
        <result property="uid" column="UID" />
        <result property="ownerNo" column="OWNER_NO" />
        <result property="enabled" column="ENABLED" />
        <result property="name" column="NAME" />
        <result property="description" column="DESCRIPTION" />
        <result property="color" column="COLOR" />
        <result property="external" column="EXTERNAL" />
        <result property="emotion" column="EMOTION" />
        <result property="comments" column="COMMENTS" />
        <result property="maxLen" column="MAX_LEN" />
        <result property="imogi" column="IMOGI" />
        <result property="emojiSetType" column="EMOJI_SET_TYPE" 
            typeHandler="com.utime.memoBom.board.typeHandler.EmojiSetTypeHandler"/>
        <result property="ai" column="AI"/>
        <result property="prompt" column="PROMPT"/>
    </resultMap>
    
	<!--topic 정보 읽기-->
	<select id="loadTopic" parameterType="map" resultMap="TopicMap">
		SELECT
			<include refid="TopicColumnSql" /> 
		FROM MB_TOPIC TP
		WHERE 1=1
			<if test="uid != null and ! uid.isEmpty()">
				AND UID = #{uid}
			</if>
			<if test="topicNo > 0">
				AND TOPIC_NO = #{topicNo}
			</if>
	</select>
	
	<resultMap id="TopicResultMap" type="com.utime.memoBom.board.vo.query.TopicResultVo">
        <result property="uid" column="UID" />
        <result property="name" column="NAME" />
        <result property="description" column="DESCRIPTION" />
        <result property="color" column="COLOR" />
        <result property="external" column="EXTERNAL" />
        <result property="emotion" column="EMOTION" />
        <result property="comments" column="COMMENTS" />
        <result property="maxLen" column="MAX_LEN" />
        <result property="imogi" column="IMOGI" />
        <result property="emojiSetType" column="EMOJI_SET_TYPE" 
            typeHandler="com.utime.memoBom.board.typeHandler.EmojiSetTypeHandler"/>
        <result property="flow" column="FLOW" />
        <result property="flowCount" column="FLOW_COUNT" />
        <result property="fragmentCount" column="FRAGMENT_COUNT" />
         
		<association property="user" javaType="com.utime.memoBom.user.vo.query.BasicUserVo">
            <result property="uid" column="USER_UID" />
            <result property="nickname" column="NICKNAME" />
            <result property="profileUrl" column="PROFILE_IMG_PATH" />
        </association>
    </resultMap>
	
	<select id="listTopic" parameterType="map" resultMap="TopicResultMap">
		SELECT
		      TP.TOPIC_NO
		    , TP.OWNER_NO
		    , TP.EXTERNAL
		    , CAST(TP.UID AS VARCHAR) AS UID
		    , TP.NAME
		    , TP.DESCRIPTION
		    , TP.IMOGI
		    , TP.COLOR
		    , TP.EMOTION
		    , TP.COMMENTS
		    , TP.MAX_LEN
		    , TP.ENABLED
		    , TP.EMOJI_SET_TYPE
		
		    , CAST(USR.UID AS VARCHAR) AS USER_UID
		    , USR.NICKNAME
		    , USR.PROFILE_IMG_PATH
		
		    , (MYFL.USER_NO IS NOT NULL) AS FLOW
		
		    , COALESCE(ST.FOLLOW_COUNT, 0)   AS FLOW_COUNT
		    , COALESCE(ST.FRAGMENT_COUNT, 0) AS FRAGMENT_COUNT
		
		FROM MB_TOPIC TP
		    JOIN MB_USER USR
		        ON TP.OWNER_NO = USR.USER_NO
		
		    <!-- ✅ 현재 로그인 사용자: UID로 USER_NO 매핑 -->
		    LEFT JOIN MB_USER ME
		        ON ME.UID = #{user.uid}
		
		    <!-- ✅ follow 판단은 ME.USER_NO로 -->
		    LEFT JOIN MB_TOPIC_FOLLOW MYFL
		        ON MYFL.TOPIC_NO = TP.TOPIC_NO
		       AND MYFL.USER_NO  = ME.USER_NO
		
		    LEFT JOIN MB_TOPIC_STATS ST
		        ON ST.TOPIC_NO = TP.TOPIC_NO
		
		WHERE 1=1
		    AND TP.ENABLED = TRUE
		
		    <!-- 기본은 공개 토픽만. 단, 로그인 유저가 follow 한 토픽이면 비공개도 노출 -->
		    AND (
		        TP.EXTERNAL = TRUE
		        <if test="user != null">
		            OR MYFL.USER_NO IS NOT NULL
		        </if>
		    )
		
		    <!-- 검색 -->
		    <if test="keyword != null and keyword != ''">
		        AND TP.NAME_UPPER LIKE CONCAT('%', UPPER(#{keyword}), '%')
		    </if>

		    <if test="uid != null and uid != ''">
		        AND TP.UID = #{uid}
		    </if>
		
		<choose>
		    <when test="sortType != null and sortType.name() == 'fresh'">
		        ORDER BY TP.REG_DATE DESC, TP.TOPIC_NO DESC
		    </when>
		
		    <when test="sortType != null and sortType.name() == 'trending'">
		        ORDER BY COALESCE(ST.FRAGMENT_COUNT, 0) DESC,
		                 COALESCE(ST.FOLLOW_COUNT, 0) DESC,
		                 TP.REG_DATE DESC,
		                 TP.TOPIC_NO DESC
		    </when>
		
		    <otherwise>
		        ORDER BY TP.REG_DATE DESC, TP.TOPIC_NO DESC
		    </otherwise>
		</choose>
		
		LIMIT 5 OFFSET ((#{page} - 1) * 5)
	</select>




	
	<!--topic 번호 조회-->
	<select id="selectTopicNoByUid" parameterType="string" resultType="long">
	    SELECT TOPIC_NO
	    FROM MB_TOPIC
        WHERE UID = #{uid}
    </select>
	
	<!-- topic 팔로우 추가 -->
	<insert id="insertTopicFlow" parameterType="map">
        INSERT INTO MB_TOPIC_FOLLOW (
            USER_NO
            , TOPIC_NO
        ) VALUES (
            #{userNo}
            , #{topicNo}
        )
    </insert>
    
	<!-- topic 팔로우 삭제 -->
	<delete id="deleteTopicFlow" parameterType="map">
        DELETE FROM MB_TOPIC_FOLLOW
        WHERE USER_NO = #{userNo}
          AND TOPIC_NO = #{topicNo}
	</delete>
	
	<!-- topic 팔로우 여부 -->
	<select id="isTopicFollowed" parameterType="map" resultType="boolean">
        SELECT 
            CASE COUNT(1) 
       			WHEN 0 THEN 0
                ELSE 1
       		END AS RES
       	FROM MB_TOPIC_FOLLOW
       	WHERE USER_NO = #{userNo}
          AND TOPIC_NO = #{topicNo}
    </select>
    
    <!--사용자의 보유 Topic 목록-->
    <select id="loadUserTopicList" resultMap="TopicMap">
    	SELECT
	        <include refid="TopicColumnSql" /> 
	    FROM MB_TOPIC TP
	        JOIN MB_USER USR
	            ON TP.OWNER_NO = USR.USER_NO
	        JOIN MB_TOPIC_FOLLOW MYFL
	            ON MYFL.TOPIC_NO = TP.TOPIC_NO AND MYFL.USER_NO = #{userNo}
	    WHERE 1=1
	    	AND TP.ENABLED = TRUE
	    	AND USR.USER_NO = #{userNo}
	    ORDER BY TP.NAME
    </select>
    
    <!-- topic 통계 정보 생성 -->
    <insert id="insertTopicStats" parameterType="map">
    	INSERT INTO MB_TOPIC_STATS ( TOPIC_NO ) VALUES ( #{topicNo} )
    </insert>
    
    <!-- topic 팔로우 수 증가 -->
    <update id="updateTopicStatsFollowCount" parameterType="map">
    	UPDATE MB_TOPIC_STATS
		   SET FOLLOW_COUNT = FOLLOW_COUNT + 1,
       		UPDATED_AT = CURRENT_TIMESTAMP
 		WHERE TOPIC_NO = #{topicNo}
    </update>

    <!-- topic 팔로우 수 감소 -->
    <update id="decreaseTopicStatsFollowCount" parameterType="map">
    	UPDATE MB_TOPIC_STATS
    		SET FOLLOW_COUNT = CASE WHEN FOLLOW_COUNT > 0 THEN FOLLOW_COUNT - 1 ELSE 0 END,
    		UPDATED_AT = CURRENT_TIMESTAMP
    	WHERE TOPIC_NO = #{topicNo}
    </update>

    <!--글 작성 성공 후 +1, 최신글 시간 갱신-->
    <update id="increaseTopicStatsFragmentCount" parameterType="map">
    	UPDATE MB_TOPIC_STATS
		   SET FRAGMENT_COUNT = FRAGMENT_COUNT + 1,
		       LAST_FRAGMENT_AT = CURRENT_TIMESTAMP,
		       UPDATED_AT = CURRENT_TIMESTAMP
		 WHERE TOPIC_NO = #{topicNo}
    </update>
    
    <!--글 삭제(soft delete) 성공 후 -1-->
    <update id="decreaseTopicStatsFragmentCount" parameterType="map">
    	UPDATE MB_TOPIC_STATS
		   SET FRAGMENT_COUNT = CASE WHEN FRAGMENT_COUNT > 0 THEN FRAGMENT_COUNT - 1 ELSE 0 END,
		       UPDATED_AT = CURRENT_TIMESTAMP
		WHERE TOPIC_NO = #{topicNo}
    </update>
    
    <!-- 통계 리빌드용 -->
    <update id="rebuildTopicStats">
    MERGE INTO MB_TOPIC_STATS ST
		USING (
		    SELECT
		        TP.TOPIC_NO AS TOPIC_NO,
		        COALESCE(FL.CNT, 0) AS FOLLOW_COUNT,
		        COALESCE(FG.CNT, 0) AS FRAGMENT_COUNT,
		        COALESCE(CM.CNT, 0) AS COMMENT_COUNT,
		        FG.LAST_AT AS LAST_FRAGMENT_AT
		    FROM MB_TOPIC TP
		    LEFT JOIN (SELECT TOPIC_NO, COUNT(*) CNT FROM MB_TOPIC_FOLLOW GROUP BY TOPIC_NO) FL
		      ON FL.TOPIC_NO = TP.TOPIC_NO
		    LEFT JOIN (SELECT TOPIC_NO, COUNT(*) CNT, MAX(REG_DATE) LAST_AT
		               FROM MB_FRAGMENT WHERE IS_DELETED = FALSE GROUP BY TOPIC_NO) FG
		      ON FG.TOPIC_NO = TP.TOPIC_NO
		    LEFT JOIN (SELECT F.TOPIC_NO, COUNT(*) CNT
		               FROM MB_FRAGMENT_COMMENTS C
		               JOIN MB_FRAGMENT F ON F.FRAGMENT_NO = C.FRAGMENT_NO
		               WHERE F.IS_DELETED = FALSE
		               GROUP BY F.TOPIC_NO) CM
		      ON CM.TOPIC_NO = TP.TOPIC_NO
		) SRC
		ON ST.TOPIC_NO = SRC.TOPIC_NO
		WHEN MATCHED THEN UPDATE SET
		    ST.FOLLOW_COUNT = SRC.FOLLOW_COUNT,
		    ST.FRAGMENT_COUNT = SRC.FRAGMENT_COUNT,
		    ST.COMMENT_COUNT = SRC.COMMENT_COUNT,
		    ST.LAST_FRAGMENT_AT = SRC.LAST_FRAGMENT_AT,
		    ST.UPDATED_AT = CURRENT_TIMESTAMP
		WHEN NOT MATCHED THEN INSERT (TOPIC_NO, FOLLOW_COUNT, FRAGMENT_COUNT, COMMENT_COUNT, LAST_FRAGMENT_AT, UPDATED_AT)
		VALUES (SRC.TOPIC_NO, SRC.FOLLOW_COUNT, SRC.FRAGMENT_COUNT, SRC.COMMENT_COUNT, SRC.LAST_FRAGMENT_AT, CURRENT_TIMESTAMP)
	</update>    	

	<select id="loadTopicFromUid" parameterType="map" resultMap="TopicMap">
		SELECT
		    <include refid="TopicColumnSql" /> 
		FROM MB_TOPIC TP
		    JOIN MB_USER USR
		        ON TP.OWNER_NO = USR.USER_NO
		
		    LEFT JOIN MB_TOPIC_FOLLOW MYFL
		        ON MYFL.TOPIC_NO = TP.TOPIC_NO
		       AND MYFL.USER_NO  = #{user.userNo}
		WHERE 1=1
		    AND TP.UID = #{uid}
		    AND TP.ENABLED = TRUE
		    AND (
		        TP.EXTERNAL = TRUE
		        OR TP.OWNER_NO = #{user.userNo}
		        OR MYFL.USER_NO IS NOT NULL
		    )
	</select>
	
	<!--“userNo가 만든 토픽 OR userNo가 팔로우한 토픽”**을 조회하고, keyword 검색-->
	<select id="listMyOrFollowTopic" parameterType="map" resultMap="TopicMap">
		SELECT DISTINCT
			<include refid="TopicColumnSql" /> 
		FROM MB_TOPIC TP
			LEFT JOIN MB_TOPIC_FOLLOW MYFL
				ON MYFL.TOPIC_NO = TP.TOPIC_NO AND MYFL.USER_NO = #{user.userNo}
		WHERE 1=1
			AND TP.ENABLED = TRUE
			
			<!-- 내가 만든 토픽 OR 내가 팔로우한 토픽 -->
			AND (
				TP.OWNER_NO = #{user.userNo}
				OR MYFL.USER_NO IS NOT NULL
			)
			
			<!-- 검색 -->
			<if test="keyword != null and !keyword.isEmpty()">
				AND (
					TP.NAME_UPPER LIKE CONCAT('%', UPPER(#{keyword}), '%')
					OR TP.DESCRIPTION LIKE CONCAT('%', #{keyword}, '%')
				)
			</if>
		ORDER BY TP.TOPIC_NO DESC
		LIMIT 5 OFFSET ((#{pageNo} - 1) * 5)
	</select>
	
	<!--공유 데이터 추가.-->
	<insert id="insertTopicShareInfo" parameterType="com.utime.memoBom.board.vo.query.ShareDataVo"
		useGeneratedKeys="true" keyProperty="shareNo" >
        INSERT INTO MB_SHARE (
            USER_NO
            , TARGET_TYPE
            , TARGET_NO
        ) VALUES (
			#{userNo}
			, ${@com.utime.memoBom.board.vo.EShareTargetType@Topic.getCode()} 
            , #{topicNo}
        )
    </insert>

</mapper>