<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<!--//네임스페이스에는 mapper 가 있는 풀 패키지명과 매퍼명을 등록 한다. -->
<mapper namespace="com.utime.memoBom.board.mapper.TopicMapper">

	<!--토픽 테이블 생성-->
	<insert id="createTopic">
		CREATE TABLE MB_TOPIC (
			TOPIC_NO BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
			, REG_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL <!-- 생성일 -->
			, UPDATE_DATE TIMESTAMP NOT NULL <!-- 수정일 -->
			, OWNER_NO BIGINT NOT NULL  <!-- 생성자 -->
			, ENABLED BOOLEAN DEFAULT FALSE NOT NULL <!-- 사용 여부. T:사용, F:미사용 -->
			, EXTERNAL BOOLEAN DEFAULT TRUE NOT NULL <!-- 공개 여부. T:공개, F:미공개 -->
			, UID UUID DEFAULT RANDOM_UUID() NOT NULL <!-- 고유 ID -->
			, NAME VARCHAR(36) NOT NULL
			, NAME_UPPER VARCHAR(36) NOT NULL
			, HASH_KEYWORD VARCHAR(256) DEFAULT NULL
			, DESCRIPTION VARCHAR(256) DEFAULT NULL
			, IMOGI VARCHAR(16) DEFAULT NULL
			, COLOR VARCHAR(16) DEFAULT NULL <!--선택: '#RRGGBB' 또는 'indigo' 등-->
			, EMOJI_SET_TYPE SMALLINT NOT NULL DEFAULT 1
			
			, CONSTRAINT FK_MB_TOPIC_OWNER_USER_NO FOREIGN KEY (OWNER_NO) REFERENCES MB_USER(USER_NO)
		)
	</insert>
	
	<insert id="createTopicFlow">
		CREATE TABLE MB_TOPIC_FOLLOW (
			USER_NO BIGINT NOT NULL
			, TOPIC_NO BIGINT NOT NULL
			, CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
	
			, PRIMARY KEY (USER_NO, TOPIC_NO)
			, CONSTRAINT FK_TOPIC_FOLLOW_USER FOREIGN KEY (USER_NO) REFERENCES MB_USER(USER_NO)
			, CONSTRAINT FK_TOPIC_FOLLOW_TOPIC FOREIGN KEY (TOPIC_NO) REFERENCES MB_TOPIC(TOPIC_NO)
		)
	</insert>
	
	<!--팔로우 한 topic이 있나?-->
	<select id="hasTopic" parameterType="com.utime.memoBom.user.vo.UserVo" resultType="boolean">
		SELECT 
			CASE COUNT(1) 
	   			WHEN 0 THEN 0
				ELSE 1
	   		END AS RES
	   	FROM MB_TOPIC_FOLLOW FL
	   		INNER JOIN MB_TOPIC TP ON FL.TOPIC_NO = TP.TOPIC_NO
	   	WHERE TP.ENABLED = TRUE AND FL.USER_NO = #{userNo}
	</select>
	
	<!-- topic이 있나?-->
	<select id="isEmpty" parameterType="map" resultType="boolean">
		SELECT 
			CASE COUNT(1) 
	   			WHEN 0 THEN 1
				ELSE 0
	   		END AS RES
	   	FROM MB_TOPIC
	   	WHERE ENABLED = TRUE 
	</select>
	
	
	<!--동일 이름 있는지 검사.-->
	<select id="checkSameName" parameterType="map" resultType="boolean">
		SELECT 
			CASE COUNT(1) 
	   			WHEN 0 THEN 0
				ELSE 1
	   		END AS RES
	   	FROM MB_TOPIC
	   	WHERE NAME_UPPER = UPPER(#{name})
	</select>
	
	<insert id="insertTopic" parameterType="com.utime.memoBom.board.vo.TopicReqVo"
	    useGeneratedKeys="true" keyProperty="topicNo" >
		INSERT INTO MB_TOPIC (
			UPDATE_DATE 
			, OWNER_NO
			, ENABLED 
			, EXTERNAL
			, NAME 
			, NAME_UPPER 
			<if test="hashTag != null and ! hashTag.isEmpty()">, HASH_KEYWORD</if>
			<if test="description != null and ! description.isEmpty()">, DESCRIPTION</if>
			<if test="imogi != null and ! imogi.isEmpty()">, IMOGI</if>
			<if test="color != null and ! color.isEmpty()">, COLOR</if>
			, EMOJI_SET_TYPE
		) VALUES (
			CURRENT_TIMESTAMP
			, #{ownerNo}
			, TRUE
			, #{external}
			, #{name}
			, UPPER(#{name})
			<if test="hashTag != null and ! hashTag.isEmpty()">, #{hashTag}</if>
			<if test="description != null and ! description.isEmpty()">, #{description}</if>
			<if test="imogi != null and ! imogi.isEmpty()">, #{imogi}</if>
			<if test="color != null and ! color.isEmpty()">, #{color}</if>
			, #{emojiSetType, typeHandler=com.utime.memoBom.board.typeHandler.EmojiSetTypeHandler}
		)
	</insert>
	
	<!--topic 수정-->
	<update id="updateTopic" parameterType="com.utime.memoBom.board.vo.TopicReqVo">
		UPDATE MB_TOPIC SET
			UPDATE_DATE = CURRENT_TIMESTAMP
			, ENABLED = #{enabled}
			, EXTERNAL = #{external}
			, NAME = #{name}
			, NAME_UPPER = UPPER(#{name})
			, HASH_KEYWORD = <choose> <when test="hashTag != null and ! hashTag.isEmpty()">#{hashTag}</when> <otherwise>NULL</otherwise> </choose>
			, DESCRIPTION = <choose> <when test="description != null and ! description.isEmpty()">#{description}</when> <otherwise>NULL</otherwise> </choose>
			, IMOGI = <choose> <when test="imogi != null and ! imogi.isEmpty()">#{imogi}</when> <otherwise>NULL</otherwise> </choose>
			, COLOR = <choose> <when test="color != null and ! color.isEmpty()">#{color}</when> <otherwise>NULL</otherwise> </choose>
			, EMOJI_SET_TYPE = #{emojiSetType, typeHandler=com.utime.memoBom.board.typeHandler.EmojiSetTypeHandler}
		WHERE TOPIC_NO = #{topicNo}	
	</update>

	<sql id="TopicColumnSql">
	 	TOPIC_NO
		, ENABLED 
		, OWNER_NO
		, EXTERNAL
		, UID 
		, NAME
		, HASH_KEYWORD AS "hashTag"
		, DESCRIPTION 
		, IMOGI 
		, COLOR 
		, EMOJI_SET_TYPE
	</sql>
	
	<resultMap id="TopicResultMap" type="com.utime.memoBom.board.vo.TopicVo">
        <result property="topicNo" column="TOPIC_NO" />
        <result property="enabled" column="ENABLED" />
        <result property="ownerNo" column="OWNER_NO" />
        <result property="external" column="EXTERNAL" />
        <result property="uid" column="UID" />
        <result property="name" column="NAME" />
        <result property="hashTag" column="HASH_KEYWORD" />
        <result property="description" column="DESCRIPTION" />
        <result property="imogi" column="IMOGI" />
        <result property="color" column="COLOR" />
        
        <result property="user.uid" column="USER_UID" />
        <result property="user.nickname" column="NICKNAME" />
        <result property="user.profileUrl" column="PROFILE_IMG_PATH" />
        <result property="memoCount" column="MEMO_COUNT" />
        <result property="flowCount" column="FLOW_COUNT" />
        <result property="flow" column="FLOW" />
         
        <result property="emojiSetType" column="EMOJI_SET_TYPE" 
            typeHandler="com.utime.memoBom.board.typeHandler.EmojiSetTypeHandler"/>
    </resultMap>
    
	<!--topic 정보 읽기-->
	<select id="loadTopic" parameterType="map" resultMap="TopicResultMap">
		SELECT
			<include refid="TopicColumnSql" /> 
		FROM MB_TOPIC
		WHERE 1=1
			<if test="uid != null and ! uid.isEmpty()">
				AND UID = #{uid}
			</if>
			<if test="topicNo > 0">
				AND TOPIC_NO = #{topicNo}
			</if>
	</select>
	
	<!--topic 인기 목록-->
	<select id="listTopicTrending" parameterType="map" resultMap="TopicResultMap">
		SELECT
			TP.TOPIC_NO
			, TP.OWNER_NO
			, TP.EXTERNAL
			, TP.UID
			, TP.NAME
			, TP.HASH_KEYWORD
			, TP.DESCRIPTION
			, TP.IMOGI
			, TP.COLOR
			, USR.UID AS USER_UID
			, USR.NICKNAME 
			, USR.PROFILE_IMG_PATH
			, (COUNT(MYFL.USER_NO) > 0) AS FLOW
			, COUNT(DISTINCT ALLFL.USER_NO) AS FLOW_COUNT
			, COUNT(DISTINCT MB.BOARD_NO) AS MEMO_COUNT
		FROM MB_TOPIC TP
			JOIN MB_USER USR
				ON TP.OWNER_NO = USR.USER_NO
			LEFT JOIN MB_TOPIC_FOLLOW ALLFL
				ON ALLFL.TOPIC_NO = TP.TOPIC_NO
			LEFT JOIN MB_TOPIC_FOLLOW MYFL
				ON MYFL.TOPIC_NO = TP.TOPIC_NO AND MYFL.USER_NO = #{userNo}
			LEFT JOIN MB_MEMO_BOARD MB
				ON MB.TOPIC_NO = TP.TOPIC_NO
		WHERE 1=1
			AND TP.ENABLED = TRUE
			AND TP.EXTERNAL = TRUE
		GROUP BY
			TP.TOPIC_NO
			, TP.OWNER_NO
			, TP.EXTERNAL
			, TP.UID
			, TP.NAME
			, TP.HASH_KEYWORD
			, TP.DESCRIPTION
			, TP.IMOGI
			, TP.COLOR
			, USR.NICKNAME
			, USR.PROFILE_IMG_PATH
		ORDER BY
			COUNT(DISTINCT ALLFL.USER_NO) DESC <!-- 인기: 팔로우 수 -->
			, COUNT(DISTINCT MB.BOARD_NO) DESC
			, TP.TOPIC_NO DESC
		LIMIT #{pageSize} OFFSET #{offset}
	</select>
	
	<!--topic 신상 목록-->
	<select id="listTopicFresh" parameterType="map" resultMap="TopicResultMap">
		SELECT
			TP.TOPIC_NO
			, TP.OWNER_NO
			, TP.EXTERNAL
			, TP.UID
			, TP.NAME
			, TP.HASH_KEYWORD 
			, TP.DESCRIPTION
			, TP.IMOGI
			, TP.COLOR
			, USR.UID AS USER_UID
			, USR.NICKNAME 
			, USR.PROFILE_IMG_PATH 
			, (COUNT(MYFL.USER_NO) > 0) AS FLOW
			, COUNT(DISTINCT ALLFL.USER_NO) AS FLOW_COUNT
			, COUNT(DISTINCT MB.BOARD_NO) AS MEMO_COUNT
		FROM MB_TOPIC TP
			JOIN MB_USER USR
				ON TP.OWNER_NO = USR.USER_NO
			LEFT JOIN MB_TOPIC_FOLLOW ALLFL
				ON ALLFL.TOPIC_NO = TP.TOPIC_NO
			LEFT JOIN MB_TOPIC_FOLLOW MYFL
				ON MYFL.TOPIC_NO = TP.TOPIC_NO AND MYFL.USER_NO = #{userNo}
			LEFT JOIN MB_MEMO_BOARD MB
				ON MB.TOPIC_NO = TP.TOPIC_NO
		WHERE 1=1
			AND TP.ENABLED = TRUE
			AND TP.EXTERNAL = TRUE
		GROUP BY
			TP.TOPIC_NO
			, TP.OWNER_NO
			, TP.EXTERNAL
			, TP.UID
			, TP.NAME
			, TP.HASH_KEYWORD
			, TP.DESCRIPTION
			, TP.IMOGI
			, TP.COLOR
			, USR.NICKNAME
			, USR.PROFILE_IMG_PATH
		ORDER BY
			TP.TOPIC_NO DESC
		LIMIT #{pageSize} OFFSET #{offset}
	</select>
	
	<!-- topic 검색 목록 -->
	<select id="searchTopic" resultMap="TopicResultMap">
		SELECT
			TP.TOPIC_NO
			, TP.OWNER_NO
			, TP.EXTERNAL
			, TP.UID
			, TP.NAME
			, TP.HASH_KEYWORD 
			, TP.DESCRIPTION
			, TP.IMOGI
			, TP.COLOR
			, USR.UID AS USER_UID
			, USR.NICKNAME 
			, USR.PROFILE_IMG_PATH 
			, (COUNT(MYFL.USER_NO) > 0) AS FLOW
			, COUNT(DISTINCT ALLFL.USER_NO) AS FLOW_COUNT
			, COUNT(DISTINCT MB.BOARD_NO) AS MEMO_COUNT
		FROM MB_TOPIC TP
			JOIN MB_USER USR
				ON TP.OWNER_NO = USR.USER_NO
			LEFT JOIN MB_TOPIC_FOLLOW ALLFL
				ON ALLFL.TOPIC_NO = TP.TOPIC_NO
			LEFT JOIN MB_TOPIC_FOLLOW MYFL
				ON MYFL.TOPIC_NO = TP.TOPIC_NO AND MYFL.USER_NO = #{userNo}
			LEFT JOIN MB_MEMO_BOARD MB
				ON MB.TOPIC_NO = TP.TOPIC_NO
		WHERE 1=1
			AND TP.ENABLED = TRUE
			AND TP.EXTERNAL = TRUE
			AND ( 
				TP.NAME_UPPER LIKE CONCAT('%', UPPER(#{keyword}), '%')
				OR TP.HASH_KEYWORD LIKE CONCAT('%', #{keyword}, '%')
				OR TP.DESCRIPTION LIKE CONCAT('%', #{keyword}, '%')
			)
		GROUP BY
			TP.TOPIC_NO
			, TP.OWNER_NO
			, TP.EXTERNAL
			, TP.UID
			, TP.NAME
			, TP.HASH_KEYWORD
			, TP.DESCRIPTION
			, TP.IMOGI
			, TP.COLOR
			, USR.NICKNAME
			, USR.PROFILE_IMG_PATH
		ORDER BY
			TP.TOPIC_NO DESC
		LIMIT #{pageSize} OFFSET #{offset}
	</select>

	
	<!--topic 번호 조회-->
	<select id="selectTopicNoByUid" parameterType="string" resultType="long">
	    SELECT TOPIC_NO
	    FROM MB_TOPIC
        WHERE UID = #{uid}
    </select>
	
	<!-- topic 팔로우 추가 -->
	<insert id="insertTopicFlow" parameterType="map">
        INSERT INTO MB_TOPIC_FOLLOW (
            USER_NO
            , TOPIC_NO
        ) VALUES (
            #{userNo}
            , #{topicNo}
        )
    </insert>
    
	<!-- topic 팔로우 삭제 -->
	<delete id="deleteTopicFlow" parameterType="map">
        DELETE FROM MB_TOPIC_FOLLOW
        WHERE USER_NO = #{userNo}
          AND TOPIC_NO = #{topicNo}
	</delete>
	
	<!-- topic 팔로우 여부 -->
	<select id="isTopicFollowed" parameterType="map" resultType="boolean">
        SELECT 
            CASE COUNT(1) 
       			WHEN 0 THEN 0
                ELSE 1
       		END AS RES
       	FROM MB_TOPIC_FOLLOW
       	WHERE USER_NO = #{userNo}
          AND TOPIC_NO = #{topicNo}
    </select>
</mapper>